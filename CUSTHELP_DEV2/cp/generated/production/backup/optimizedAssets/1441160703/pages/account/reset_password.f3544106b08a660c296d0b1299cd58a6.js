
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
(function(){var n=function(){var c={},b={},k={};return{getDeferred:function(f,e){if(c[f])return c[f];b[e]=b[e]||{events:[]};b[e].form=f;return{on:function(a,d,c){if(d&&"function"===typeof d)return b[e].events.push({name:a,handler:d,context:c}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,d){if(a&&d&&"object"===typeof d)k[f]||(k[f]={}),k[f][a]=d;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(b){return c[b]},newInstance:function(b,e){e instanceof RightNow.Form&&(c[b]=e)},getDeferredEvents:function(c){var e,a,d={};for(e in b)if(a=b[e],b.hasOwnProperty(e)&&a.form===c&&a.events.length){a=a.events;for(var h=0;h<a.length;h++)d[a[h].name]=d[a[h].name]||[],d[a[h].name].push(a[h])}return d},getDeferredFields:function(b){return k[b]}}}(),m=function(){function c(a,b,c,e){var g={},k=a.getAttribute("target");a.all("input, select, textarea").each(function(a){var b=a.get("type");""!==a.get("name")&&"submit"!==b&&"image"!==b&&(g[a.get("name")]=a.get("value"))});a=b+RightNow.Url.convertToSegment(g)+c;RightNow.Url.getSession()&&(a=RightNow.Url.addParameter(a,"session",RightNow.Url.getSession()));a=e.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",a);k&&a.setAttribute("target",k);e.Y.one(document.body).append(a);a=e.Y.Node.getDOMNode(a);document.createEvent?(e=document.createEvent("MouseEvents"),e.initEvent("click",!1,!1),a.dispatchEvent(e)):a.fireEvent("onclick")}function b(a){this.fire("response",new RightNow.Event.EventObject(this,{data:a}))}function k(a){this.fire("responseError",new RightNow.Event.EventObject(this,{data:a}))}var f={},e={};return{submitForm:function(a,d,h){var f=h.Y.one("#"+a),g=f.getAttribute("method"),l=f.getAttribute("action");a=e[a];d=d||"";if(l&&!h.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(l,"/")&&RightNow.Url.isExternalUrl(l)){d&&f.set("action",l+d);for(d=0;d<a.length;d++)(g=a[d])&&g.value&&((l=f.one('input[name="'+g.name+'"]'))?l.set("value",g.value):f.append(h.Y.Node.create('<input type="hidden" name="'+
g.name+'" value="'+g.value+'"/>')));f.submit()}else c(f,l,d,h);else{f=(l||"/ci/ajaxRequest/sendForm")+d;if(RightNow.Event.noSessionCookies())for(d=0,g=a.length;d<g;d++)if("Contact.Login"===a[d].name){document.cookie="cp_login_start=1;path=/";break}a={f_tok:h._originalEventObject.data.f_tok,form:RightNow.JSON.stringify(a),updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id")})};d={scope:h,json:!0,successHandler:b,failureHandler:k};g=RightNow.UI.Form;null!=g.smartAssistant&&(a.smrt_asst=g.smartAssistant);null!==g.smartAssistantToken&&(a.saToken=g.smartAssistantToken);if(h._originalEventObject){h._originalEventObject.data.timeout&&(d.timeout=h._originalEventObject.data.timeout);h=h._originalEventObject;for(var g=["challengeHandler","challengeHandlerContext"],m,l=0;l<g.length;++l)m=g[l],d[m]=h[m]||void 0}RightNow.Ajax.makeRequest(f,a,d)}},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,c){f[a]||(f[a]={});f[a][b]=c},findField:function(a,b){return f[a][b]},getAllFields:function(a){return f[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(b){b.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));this._errorMessageDiv.setAttribute("aria-live","assertive");if(this._parentForm){if(n.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");n.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=n.getDeferredEvents(this._parentForm);this.Y.Object.each(n.getDeferredFields(this._parentForm),function(b,c){m.addField(this._parentForm,c,b)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(b){m.resetValidatedFields(this._parentForm);this._challengeDivID&&(b.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=b},during:function(b){!1===b?this._eventCanceled=!0:b instanceof RightNow.Event.EventObject&&m.addValidatedField(this._parentForm,b)},post:function(b){var c=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+c,b)}})._addEventHandler("send",{post:function(b){this._eventCanceled||m.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(b){!1===b&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(b){b&&this._collectedFields.push(b)},post:function(b){this.fire("submit",b)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(c){throw"Failed while trying to parse a challenge provider.  "+c;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}}},_filterSubmittedWidgets:function(c){var b=m.getAllFields(this._parentForm),k=[];this.Y.Object.each(b,function(b,e){this.Y.Array.each(c,function(a,c){a.context===b&&-1===this.Y.Array.indexOf(this._collectedFields,e)&&k.push(c)},this)},this);return k},getValidatedFields:function(){return m.getValidatedFields(this._parentForm)},addField:function(c,b){m.addField(this._parentForm,c,b)},findField:function(c){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return m.findField(this._parentForm,c)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"'>"),"before")},_reportChallengeError:function(c){c=c||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+c+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus();return!1}))},_challengeHandler:function(c,b,k){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(c),this.on("submit",this._onValidateChallengeResponse,this));this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(c));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var c=this._challengeProvider.getInputs(this._challengeDivID);if(c.abuse_challenge_response)for(var b in c)c.hasOwnProperty(b)&&RightNow.Ajax.addRequestData(b,c[b])}},{find:function(c,b,k){if(c=RightNow.UI.findParentForm(c))return k?c:n.getDeferred(c,b);throw Error("You're using a form that doesn't have a proper form submit button or an id");}})})();
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a){this._errors=a||[];this._value=this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+
c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){for(var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' class='rn_HintBox'>"+this.data.attrs.hint+"</span>"),b=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;b.next();)b=b.next();a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:{node:b,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio()))this.input.on("click",function(){b.focus();a.show()});else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
RightNow.Widgets.ResetPassword=RightNow.Widgets.extend({constructor:function(){RightNow.Event.subscribe("evt_formButtonSubmitRequest",this._formSubmitButtonPushed,this);},_formSubmitButtonPushed:function(){RightNow.Ajax.addRequestData('pw_reset',this.data.js.resetString,true);RightNow.Ajax.addRequestData('w_id',this.data.info.w_id,true);}});
RightNow.Widgets.FormSubmit=RightNow.Form.extend({overrides:{constructor:function(){this.parent();this._formButton=this.Y.one(this.baseSelector+"_Button");this._formSubmitFlag=this.Y.one(this.baseSelector+"_Submission");if(!this._formButton||!this._formSubmitFlag)return;if(this._formSubmitFlag.get("checked")){this._formButton.set("disabled","true");return;}
this.on("validation:fail",this._onFormValidationFail,this).on("validation:pass",this._onFormValidated,this).on("response",this._formSubmitResponse,this).on("responseError",this._onErrorResponse,this).on("submitRequest",this._onButtonClick,this).on("formUpdated",this._onFormUpdated,this);this._toggleClickListener(true);RightNow.Event.subscribe("evt_formTokenUpdate",this._onFormTokenUpdate,this);this._enableFormExpirationWatch();}},_onButtonClick:function(evt){if(evt&&evt.halt){evt.halt();}
if(this._requestInProgress)return false;this._toggleClickListener(false);this._errorMessageDiv.addClass("rn_Hidden").set("innerHTML","");if(this.Y.UA.ie&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(document.getElementById(this._parentForm));}
this._fireSubmitRequest();},_fireSubmitRequest:function(){var eo=new RightNow.Event.EventObject(this,{data:{form:this._parentForm,f_tok:this.data.js.f_tok,error_location:this._errorMessageDiv.get("id"),timeout:this.data.attrs.timeout*1000}});RightNow.Event.fire("evt_formButtonSubmitRequest",eo);this.fire("collect",eo);},_onFormValidated:function(){this._toggleLoadingIndicators();this.fire("send",this.getValidatedFields());},_onFormValidationFail:function(){this._errorMessageDiv.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden").scrollIntoView();window.scrollTo(0,this.Y.DOM.docScrollY());var firstField=this._errorMessageDiv.one("a");if(firstField){firstField.focus();this._errorMessageDiv.removeAttribute('tabIndex');}
else{this._errorMessageDiv.set('tabIndex',0);this.Y.Lang.later(500,this,function(){this._errorMessageDiv.focus();});}
this._toggleClickListener(true);this._toggleLoadingIndicators(false);RightNow.Event.fire("evt_formValidateFailure",new RightNow.Event.EventObject(this));},_formSubmitResponse:function(type,args){var responseObject=args[0].data,result;if(!responseObject){this._displayErrorDialog(RightNow.Interface.getMessage('ERROR_REQUEST_ACTION_COMPLETED_MSG'));}
else if(responseObject.errors){var errorMessage="";this.Y.Array.each(responseObject.errors,function(error){errorMessage+="<div><b>"+error+"</b></div>";});this._errorMessageDiv.append(errorMessage);this._onFormValidationFail();}
else if(responseObject.result){result=responseObject.result;if(result.sa){if(result.newFormToken){this.data.js.f_tok=result.newFormToken;RightNow.Event.fire("evt_formTokenUpdate",new RightNow.Event.EventObject(this,{data:{newToken:result.newFormToken}}));}}
else if(result.transaction||result.redirectOverride){this._formSubmitFlag.set("checked",true);var navigateToUrl=function(){var url;if(result.redirectOverride){url=result.redirectOverride+result.sessionParam;}
else if(this.data.attrs.on_success_url){var paramsToAdd='';this.Y.Object.each(result.transaction,function(details){if(details.key){paramsToAdd+='/'+details.key+'/'+details.value;}});if(paramsToAdd){url=this.data.attrs.on_success_url+paramsToAdd+result.sessionParam;}
else{var sessionValue=result.sessionParam.substr(result.sessionParam.lastIndexOf("/")+1);if(!sessionValue&&this.data.js.redirectSession)
sessionValue=this.data.js.redirectSession;url=RightNow.Url.addParameter(this.data.attrs.on_success_url,'session',sessionValue);}}
else{url=window.location+result.sessionParam;}
RightNow.Url.navigate(url+this.data.attrs.add_params_to_url);};if(this.data.attrs.label_confirm_dialog!==''){RightNow.UI.Dialog.messageDialog(this.data.attrs.label_confirm_dialog,{exitCallback:{fn:navigateToUrl,scope:this},width:'250px'});}
else{navigateToUrl.call(this);}
return;}
else{this._displayErrorDialog();}}
else{this._displayErrorDialog();}
this._toggleLoadingIndicators(false);this._toggleClickListener(true);args[0].data||(args[0].data={});args[0].data.form=this._parentForm;RightNow.Event.fire('evt_formButtonSubmitResponse',args[0]);},_onFormUpdated:function(){if(this._errorMessageDiv.all('[data-field]').size()===0){this._errorMessageDiv.addClass("rn_Hidden").set("innerHTML","");}},_onErrorResponse:function(){this._displayErrorDialog(RightNow.Interface.getMessage('ERROR_REQUEST_ACTION_COMPLETED_MSG'));this._toggleLoadingIndicators(false);this._toggleClickListener(true);},_displayErrorDialog:function(message){RightNow.UI.Dialog.messageDialog(message||RightNow.Interface.getMessage('ERROR_PAGE_PLEASE_S_TRY_MSG'),{icon:"WARN"});},_onFormTokenUpdate:function(type,args){var eventObject=args[0];if(eventObject.data.newToken&&this.instanceID===eventObject.w_id){this.data.js.f_tok=eventObject.data.newToken;}
this._enableFormExpirationWatch();},_enableFormExpirationWatch:function(){if(this.data.js.formExpiration>=300000){var fiveMinutesBeforeExpiring=function(){this.Y.Lang.later(this.data.js.formExpiration,this,function(){RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("FORM_EXP_PLS_CONFIRM_WISH_CONTINUE_MSG"),{icon:"WARN",exitCallback:{fn:function(){RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject(this,{data:{formToken:this.data.js.f_tok}}));},scope:this}});});};fiveMinutesBeforeExpiring.call(this);}},_toggleLoadingIndicators:function(turnOn){var classFunc=((typeof turnOn==="undefined")?"toggleClass":((turnOn===true)?"removeClass":"addClass")),loading=this.Y.one(this.baseSelector+"_LoadingIcon"),message=this.Y.one(this.baseSelector+"_StatusMessage");if(loading){loading[classFunc]("rn_Hidden");}
if(message){message[classFunc]("rn_Hidden").setAttribute("aria-live",(message.hasClass("rn_Hidden"))?"off":"assertive");}},_toggleClickListener:function(enable){this._formButton.set("disabled",!enable);this._requestInProgress=!enable;this.Y.Event[((enable)?"attach":"detach")]("click",this._onButtonClick,this._formButton,this);}});
RightNow.Widgets.SelectionInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();var attrs=this.data.attrs;this.input=(this.data.js.type==="Boolean"&&!attrs.display_as_checkbox)?this.Y.all(this._inputSelector+"_1, "+this._inputSelector+"_0"):this.Y.one(this._inputSelector);if(!this.input)return;if(attrs.hint&&!attrs.hide_hint&&!attrs.always_show_hint){this._initializeHint();}
if(attrs.initial_focus&&this.input){if(this.data.js.type==="Boolean"&&this.input[0]&&this.input[0].focus)
this.input[0].focus();else if(this.input.focus)
this.input.focus();}
if(attrs.validate_on_blur&&attrs.required){this.Y.Event.attach('blur',this.blurValidate,this.input instanceof this.Y.NodeList?this.input.item(1):this.input,this);}
this.input.on('change',function(){this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);var fieldName=this.data.js.name;if(fieldName==="Contact.Address.Country"){this.input.on("change",this.countryChanged,this);if(this.input.get('value'))
this.countryChanged();}
else if(fieldName==="Contact.Address.StateOrProvince"){this.currentState=this.input.get('value');RightNow.Event.on("evt_provinceResponse",this.onProvinceResponse,this);}
else if(fieldName==='Incident.StatusWithType.Status'){this.on('change',this.onStatusChanged,this);}
this.parentForm().on("submit",this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){if(this.data.js.type==='Boolean'&&!this.data.attrs.display_as_checkbox){this.swapLabel(this.Y.one(this.baseSelector+'_Label'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
else{this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidationFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidationPass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,message;i<errors.length;i++){message=errors[i];message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div>");}}
this.toggleErrorIndicator(true);},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator(!this.getValue());},countryChanged:function(){var value=this.input.get("value"),fireResponse=function(response,eventObject){RightNow.Event.fire("evt_provinceResponse",response,eventObject);};if(value){var eventObject=new RightNow.Event.EventObject(this,{data:{country_id:value}});if(RightNow.Event.fire("evt_provinceRequest",eventObject)){this._provinces=this._provinces||{};if(this._provinces[value]){return fireResponse(this._provinces[value],eventObject);}
RightNow.Ajax.makeRequest("/ci/ajaxRequestMin/getCountryValues",eventObject.data,{successHandler:function(response){this._provinces[value]=response;fireResponse(response,eventObject);},scope:this,json:true,type:"GETPOST"});}}
else{fireResponse({ProvincesLength:0,Provinces:{}});}},onProvinceResponse:function(type,args){var response=args[0],options='',provinces=response.Provinces,i,length;this.input.set("innerHTML","");if(provinces){if(!this.Y.Lang.isArray(provinces)){var temp=[];this.Y.Object.each(provinces,function(val){temp.push(val);});provinces=temp;}
if(!provinces[0]||(provinces[0].Name!=="--"&&!this.data.hideEmptyOption)){provinces.unshift({Name:"--",ID:""});}
for(i=0,length=provinces.length;i<length;i++){options+="<option value='"+provinces[i].ID+"'>"+provinces[i].Name+"</option>";}
this.input.append(options);this.input.set('value',this.currentState);}
this.currentState='';},onStatusChanged:function(){var threadInput=this.parentForm().findField('Incident.Threads');if(threadInput){threadInput.setConstraints({required:this.input.get('value')==='0'});}}});
RightNow.Widgets.DateInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();var widgetContainer=this.Y.one(this.baseSelector);if(!widgetContainer)return;this.input=widgetContainer.all('select');if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.item(0)&&this.input.item(0).focus){this.input.item(0).focus();}
if(this.data.attrs.validate_on_blur){this.input.item(this.input.size()-1).on('blur',this.blurValidate,this);}
this.input.on('change',function(){this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);this.parentForm().on('submit',this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_Legend'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(this),errors=[];this.toggleErrorIndicator(false);if(!this.validateValue(errors)||!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),fieldsToHighlight;if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,errorString="",message;i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message.ids&&message.message){id=message.ids[0];fieldsToHighlight=message.ids;message=message.message;}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
this.toggleErrorIndicator(true,fieldsToHighlight);},toggleErrorIndicator:function(showOrHide,fieldsToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldsToHighlight){this.input.each(function(field){if(this.Array.indexOf(fieldsToHighlight,field.get("id"))>-1){field[method]("rn_ErrorField");}},this.Y);}
else{this.input[method]("rn_ErrorField");}
this.Y.one(this.baseSelector+"_Legend")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator((this.data.attrs.required&&!this.getValue())||!this.validateValue());},validateValue:function(errors){var errorNodes=[];this.input.each(function(input){if(input.get("value")==="")
errorNodes.push(input.get("id"));});if(errorNodes.length&&errorNodes.length!==this.input.size()){errors.push({ids:errorNodes,message:RightNow.Interface.getMessage("PCT_S_IS_NOT_COMPLETELY_FILLED_IN_MSG")});return false;}
else if(errorNodes.length===this.input.size()){return true;}
var year=this._getDateFieldValue('Year'),month=this._getDateFieldValue('Month'),day=this._getDateFieldValue('Day');if(new Date(year,month-1,day).getDate()!==day){errors.push(RightNow.Interface.getMessage("PCT_S_IS_NOT_A_VALID_DATE_MSG"));return false;}
if(this.data.attrs.min_year&&year<=this.data.attrs.min_year){var min=this.data.js.min,hour=this._getDateFieldValue('Hour');if(year<min.year||month<min.month||(month===min.month&&day<min.day)||(hour!==null&&(hour<min.hour&&day<=min.day))){errors.push(RightNow.Text.sprintf(RightNow.Interface.getMessage("VALUE_MIN_VALUE_PCT_S_MSG"),this.data.js.min_val));return false;}}
return true;},_getDateFieldValue:function(fieldName){var element=this.Y.one(this._inputSelector+'_'+fieldName);return(element)?parseInt(element.get('value'),10):null;}});
RightNow.Widgets.PasswordInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this._inputSelector);if(!this.input)return;this.inputLabel=this.Y.one(this.baseSelector+"_Label");this.currentPasswordField=this.Y.one(this._inputSelector+"_CurrentPassword");this.input.on('change',function(){this.fire('change',this);},this);this.on('constraintChange',this.constraintChange,this);if(this.data.attrs.require_validation){this.validation=this.Y.one(this._inputSelector+"_Validate");this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this.parentForm().on("submit",this.onValidate,this);if(this.data.js.requirements){this.initEvents();}
if(this.data.attrs.initial_focus){if(this.currentPasswordField&&this.currentPasswordField.focus)
this.currentPasswordField.focus();else if(this.input.focus)
this.input.focus();}},validate:function(errors){var attrs=this.data.attrs;this._value=this.input.get('value');this._checkData();if(this._errors){errors=this._errors.slice();}
if(attrs.required){this.toggleErrorIndicator(false,this.input,this.inputLabel);if(!this.input.get('value')){errors.push(attrs.label_required);this.toggleErrorIndicator(true,this.input,this.inputLabel);}}
if(!errors.length&&this.data.js.requirements&&!this.validateInput(true)){errors.push(RightNow.Interface.getMessage("PCT_S_REQUIREMENTS_MET_LBL"));}
if(attrs.require_validation){var validationLabel=RightNow.Text.sprintf(attrs.label_validation,attrs.label_error||attrs.label_input);this.toggleErrorIndicator(false,this.validation,this.validationLabel);if((attrs.required||(this.data.js.requirements&&'length'in this.data.js.requirements))&&!this.validation.get('value')){errors.push({text:RightNow.Text.sprintf(attrs.label_required,validationLabel),id:this.validation.get('id')});this.toggleErrorIndicator(true,this.validation,this.validationLabel);}
else if(!this.validateValidation(true)){errors.push({text:RightNow.Text.sprintf(attrs.label_validation_incorrect,attrs.label_input,validationLabel)});this.toggleErrorIndicator(true,this.validation,this.validationLabel);}}
return!errors.length;}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(this.data.js.requirements||(constraint.required===this.data.attrs.required))return;this.toggleErrorIndicator(false,this.input,this.inputLabel);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.validation,this.validationLabel);}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);this.inputLabel=this.Y.one(this.baseSelector+"_Label");}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");}
this.data.attrs.required=constraint.required;},initEvents:function(){var input=this.input;input.on("focus",this.showOverlay,this,'input');input.on("blur",this.blurValidation,this,'input');input.on("keyup",this.validateInput,this);input.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'input');}},this);if(this.data.attrs.require_validation){var validation=this.validation;validation.on("focus",function(e,type){if(!this.inputOverlay||!this.inputOverlay.get("visible")){this.showOverlay(e,type);}},this,'validation');validation.on("blur",this.blurValidation,this,'validation');validation.on("keyup",this.validateValidation,this);validation.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'validation');}},this);}},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
if(this.data.attrs.require_current_password&&this.currentPasswordField){eventObject.data.currentValue=this.currentPasswordField.get('value');}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),errorLength=errors.length;if(commonErrorDiv&&errorLength){for(var i=0,errorString="",message,id,defaultID=this.input.get("id");i<errorLength;i++){message=errors[i];id=defaultID;if(typeof message==='object'&&message.text){if(message.id){id=message.id;}
message=message.text;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");},showOverlay:function(e,type){var name=type+"Overlay";if(!this[name]){var overlay,element=this[type],insertInto=this.Y.one(this.baseSelector+((type==='input')?'_PasswordHelp':'')),content;if(type==='input'){content=this.Y.Node.create('<div class="rn_PasswordOverlay" />').setHTML(new EJS({text:this.getStatic().templates.overlay}).render({title:this.data.attrs.label_validation_title,instanceID:this.instanceID,validations:this.data.js.requirements,passwordRequirementsLabel:RightNow.Interface.getMessage("PASSWD_VALIDATION_REQS_READ_L_MSG")}));}
else{content=this.Y.one(this.baseSelector+'_PasswordValidationHelp').addClass('rn_PasswordOverlay').removeClass('rn_ScreenReaderOnly');}
if(this.Y.Overlay){overlay=new this.Y.Overlay({bodyContent:content,visible:false,align:{node:element,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}}).render(insertInto);}
else{insertInto.append(content);overlay={_body:content,show:function(){this._body.removeClass('rn_Hidden');},hide:function(){this._body.addClass('rn_Hidden');},get:function(what){if(what==='visible'){return!this._body.hasClass('rn_Hidden');}
if(what==='bodyContent'){return this._body;}}};}
this[name]=overlay;}
this[name].align&&this[name].align();this[name].show();},blurValidation:function(e,type){var overlay=this[type+"Overlay"];if(!overlay||this._alreadyBlurring)return;if(e===false){overlay.hide();return;}
this.toggleErrorIndicator(false,this[type],this[type+"Label"]);if(this["validate"+type.charAt(0).toUpperCase()+type.slice(1)](true)){overlay.hide();}
else if(overlay.get('visible')){this.toggleErrorIndicator(true,this[type],this[type+"Label"]);if(e.keyCode){var overlayBody=overlay.get('bodyContent');overlayBody=(overlayBody.item)?overlayBody.item(0):overlayBody.one('*');this._alreadyBlurring=true;this.Y.Node.getDOMNode(overlayBody.setAttribute("tabIndex","-1")).focus();this._alreadyBlurring=false;e.halt();}
else if(type==='validation'){overlay.hide();}}},validationClasses:function(){return this.validationClasses.classes||(this.validationClasses.classes={fail:'rn_Fail',pass:'rn_Pass',progress:[{className:'rn_NoValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_SHORT_MSG")},{className:'rn_AllValidations',label:RightNow.Interface.getMessage("PERFECT_LBL")},{className:'rn_SomeValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_INSECURE_MSG")}]});},validateInput:function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB)return;var Y=this.Y,password=this.input.get("value"),passed=0,total=0,requirements=this.data.js.requirements,checks=this._getPasswordStats(password);Y.Object.each(checks,function(value,key,className,requirement){if(!(requirement=requirements[key]))return;if((requirement.bounds==='max'&&value>requirement.count)||(requirement.bounds==='min'&&value<requirement.count)){className='fail';}
else{passed++;className='pass';}
this.updatePasswordChecklist(key,className);total++;},this);var UI=RightNow.UI,baseSelector=this.baseSelector,quotient=passed/total,index=Math.round(quotient);if(quotient!==index&&quotient>0.3){index=2;}
index=this.validationClasses().progress[index];UI.show(baseSelector+" .rn_Strength");UI.hide(baseSelector+" .rn_Intro .rn_Text");var meter=Y.one(baseSelector+" .rn_Meter");if(meter){meter.setHTML('<div class="'+index.className+'"></div>');}
meter=Y.one(baseSelector+"_MeterLabel");if(meter){meter.set("innerHTML",index.label);}
return passed===total;},validateValidation:function(){var validationValue=this.validation.get('value'),addRemoveClassOrder=[this.validationClasses().fail,this.validationClasses().pass];if(validationValue===this.input.get("value")){addRemoveClassOrder.reverse();}
if(this.validationOverlay){this.validationOverlay.get("bodyContent").addClass(addRemoveClassOrder[0]).removeClass(addRemoveClassOrder[1]);}
return addRemoveClassOrder[0]===this.validationClasses().pass;},updatePasswordChecklist:function(name,action){if(!(this._passwordChecklist||(this._passwordChecklist=this.Y.one(this.baseSelector+" ul.rn_Requirements"))))return;var className=this.validationClasses()[action],label=((action==='pass')?RightNow.Interface.getMessage("COMPLETE_LBL"):RightNow.Interface.getMessage("INCOMPLETE_LBL"));this._passwordChecklist.one("li[data-validate='"+name+"']").set('className',className).one(".rn_ScreenReaderOnly").set("innerHTML",label);},_getPasswordStats:function(password){var checks={repetitions:0,occurrences:0,uppercase:0,lowercase:0,special:0,specialAndDigits:0,length:0},len=password.length,lastChar='',i,j,char,occur,reps,lc,uc;for(i=0;i<len;i++){occur=0;char=password[i]||password.substr(i,1);if(char===lastChar){reps++;if(reps>checks.repetitions){checks.repetitions=reps;}}
else{lastChar=char;reps=1;}
for(j=0;j<len;j++){if((password[j]||password.substr(j,1))===char){occur++;}}
if(occur>checks.occurrences){checks.occurrences=occur;}
uc=char.toLocaleUpperCase();lc=char.toLocaleLowerCase();if(uc===lc&&lc===char){if(!isNaN(parseInt(char,10))){checks.specialAndDigits++;}
else{checks.specialAndDigits++;checks.special++;}}
else if(lc===char){checks.lowercase++;}
else if(uc===char){checks.uppercase++;}}
checks.length=len;return checks;}});
RightNow.Widgets.TextInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this._inputSelector);if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.focus)
this.input.focus();if(this.data.js.mask){this._initializeMask();}
if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||this._fieldName==="Contact.Address.PostalCode"){RightNow.Event.on("evt_provinceResponse",this.onProvinceChange,this);}
if(this.data.attrs.validate_on_blur){this.input.on("blur",this._blurValidate,this);if(this.data.attrs.require_validation){this.Y.Event.attach("blur",this._blurValidate,this._inputSelector+'_Validate',this,true);}}
this.input.on('change',function(){this.fire('change',this);},this);if(this.data.attrs.require_validation){this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this._isFormSubmitting=false;this.parentForm().on("submit",this.onValidate,this).on("send",this._toggleFormSubmittingFlag,this).on("response",this._toggleFormSubmittingFlag,this);this.on("constraintChange",this.constraintChange,this);RightNow.Event.on("evt_formValidateFailure",this._onValidateFailure,this);}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.Y.one(this._inputSelector+'_Validate'),this.Y.one(this._inputSelector+'_LabelValidate'));}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);}
this.data.attrs.required=constraint.required;},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)||(this.data.attrs.require_validation&&!this._validateVerifyField(errors))||!this._compareInputToMask(true)){this.lastErrorLocation=args[0].data.error_location;this._displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},_displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),verifyField;if(commonErrorDiv){for(var i=0,errorString="",message,id=this.input.get("id");i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message!==null&&message.id&&message.message){id=verifyField=message.id;message=message.message;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
if(!verifyField||errors.length>1){this.toggleErrorIndicator(true);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldToHighlight&&labelToHighlight){fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");}
else{this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");}},_toggleFormSubmittingFlag:function(event){this._isFormSubmitting=(event==='send');},_blurValidate:function(event,validateVerifyField){if(this._dialogShowing)
return;this._trimField();if(validateVerifyField){this._validateVerifyField();}
else{var valid=this.validate();if(valid){if(this._fieldName==="Contact.Login"||this.isCommonEmailType()){this._checkExistingAccount();}}
this.toggleErrorIndicator(!valid);}},_validateVerifyField:function(errors){errors=errors||[];var valid=true,verifyField=this.Y.one(this._inputSelector+'_Validate'),verifyLabel=this.Y.one(this._inputSelector+'_LabelValidate');if(verifyField&&this.data.attrs.require_validation){var verifyValue=this.getVerificationValue(),label=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_error||this.data.attrs.label_input);if(this.data.attrs.required&&!verifyValue){errors.push({message:RightNow.Text.sprintf(this.data.attrs.label_required,label),id:verifyField.get("id")});valid=false;}
else if(verifyValue!==this.getValue()){errors.push({message:RightNow.Text.sprintf(this.data.attrs.label_validation_incorrect,label,this.data.attrs.label_input),id:verifyField.get("id")});valid=false;}
this.toggleErrorIndicator(!valid,verifyField,verifyLabel);}
return valid;},_checkExistingAccount:function(){var massagedNewValue=this._massageValueForModificationCheck(this._value);if(this._value===""||massagedNewValue===this._seenValue||(this.data.js.previousValue&&this._value.replace('&','&amp;').replace("'",'&#039;')===this.data.js.previousValue))
return;this._seenValue=massagedNewValue;var eventObject=new RightNow.Event.EventObject(this,{data:{contactToken:this.data.js.contactToken}});if(this.isCommonEmailType())
eventObject.data.email=this._value;else if(this._fieldName==="Contact.Login")
eventObject.data.login=this._value;if(RightNow.Event.fire("evt_accountExistsRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.existing_contact_check_ajax,eventObject.data,{successHandler:this._onAccountExistsResponse,scope:this,data:eventObject,json:true});}},_massageValueForModificationCheck:function(value){if(this.Y.Lang.isUndefined(value)||value===null||value===""){return"";}
if(this.isCommonEmailType()){value=value.toLowerCase();}
return value;},_onAccountExistsResponse:function(response,originalEventObject){if(RightNow.Event.fire("evt_accountExistsResponse",response,originalEventObject)){if(response!==false&&this._isFormSubmitting===false){this.toggleErrorIndicator(true);var warnDialog,handleOK=function(){warnDialog.hide();this._dialogShowing=false;this.input.focus();};warnDialog=RightNow.UI.Dialog.messageDialog(response.message,{icon:"WARN",exitCallback:{fn:handleOK,scope:this}});this._dialogShowing=true;warnDialog.show();}}},onProvinceChange:function(type,args)
{var eventObj=args[0],resetMask=false;if(!eventObj.ProvincesLength)
this.data.js.mask="";if(this._fieldName==="Contact.Address.PostalCode"&&"PostalMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PostalMask;}
else if("PhoneMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PhoneMask;}
if(this._maskNodeOnPage)
this._maskNodeOnPage.remove();if(resetMask&&this.data.js.mask)
this._initializeMask();},_initializeMask:function()
{this.input.on("keyup",this._compareInputToMask,this);this.input.on("blur",this._hideMaskMessage,this);this.input.on("focus",this._compareInputToMask,this);this.data.js.mask=this._createMaskArray(this.data.js.mask);var overlay=this.Y.Node.create("<div class='rn_MaskOverlay'>");if(this.Y.Overlay){this._maskNode=new this.Y.Overlay({bodyContent:overlay,visible:false,align:{node:this.input,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});this._maskNode.render(this.baseSelector);}
else{this._maskNode=overlay.addClass("rn_Hidden");this.input.insert(this._maskNode,"after");}
if(this.data.attrs.always_show_mask){var maskMessageOnPage=this._getSimpleMaskString(),widgetContainer=this.Y.one(this.baseSelector);if(maskMessageOnPage&&widgetContainer){var messageNode=this.Y.Node.create("<div class='rn_Mask'>"+RightNow.Interface.getMessage("EXPECTED_INPUT_LBL")+": "+maskMessageOnPage+"</div>");if(widgetContainer.get("lastChild").hasClass("rn_HintText")){messageNode.addClass("rn_MaskBuffer");}
this._maskNodeOnPage=messageNode;widgetContainer.append(messageNode);}}},_createMaskArray:function(mask)
{if(!mask)return;var maskArray=[];for(var i=0,j=0,size=mask.length/2;i<size;i++)
{maskArray[i]=mask.substring(j,j+2);j+=2;}
return maskArray;},_getSimpleMaskString:function(){if(!this.data.js.mask)return"";var maskString="";for(var i=0;i<this.data.js.mask.length;i++){switch(this.data.js.mask[i].charAt(0)){case"F":maskString+=this.data.js.mask[i].charAt(1);break;case"U":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="A";break;}
break;case"L":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="a";break;}
break;case"M":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":case"L":maskString+="@";break;}
break;}}
return maskString;},_compareInputToMask:function(submitting){if(!this.data.js.mask)return true;var error=[],value=this.input.get("value");if(value.length>0){for(var i=0,tempRegExVal;i<value.length;i++){if(i<this.data.js.mask.length){tempRegExVal="";switch(this.data.js.mask[i].charAt(0)){case'F':if(value.charAt(i)!==this.data.js.mask[i].charAt(1))
error.push([i,this.data.js.mask[i]]);break;case'U':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9A-Z]+$/;break;case'L':tempRegExVal=/^[A-Z]+$/;break;case'C':tempRegExVal=/^[^a-z]+$/;break;}
break;case'L':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-z]+$/;break;case'L':tempRegExVal=/^[a-z]+$/;break;case'C':tempRegExVal=/^[^A-Z]+$/;break;}
break;case'M':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-zA-Z]+$/;break;case'L':tempRegExVal=/^[a-zA-Z]+$/;break;}
break;}
if((tempRegExVal!=="")&&!(tempRegExVal.test(value.charAt(i))))
error.push([i,this.data.js.mask[i]]);}
else
{error.push([i,"LEN"]);}}
if((!error.length)&&(value.length<this.data.js.mask.length)&&(!this.data.attrs.always_show_mask||submitting===true))
{for(i=value.length;i<this.data.js.mask.length;i++)
error.push([i,"MISS"]);}
if(error.length>0)
{this._showMaskMessage(error);if(submitting===true)
this._reportError(RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));return false;}
this._showMaskMessage(null);return true;}
if(!this.data.attrs.always_show_mask&&submitting!==true)
this._showMaskMessage(error);return true;},_showMaskMessage:function(error){if(error===null){this._hideMaskMessage();}
else{if(!this._showMaskMessage._maskMessages){this._showMaskMessage._maskMessages={"F":RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL'),"U#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"L#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"M#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"UA":RightNow.Interface.getMessage('PLEASE_ENTER_UPPERCASE_LETTER_MSG'),"UL":RightNow.Interface.getMessage('PLEASE_ENTER_AN_UPPERCASE_LETTER_MSG'),"UC":RightNow.Interface.getMessage('PLS_ENTER_UPPERCASE_LETTER_SPECIAL_MSG'),"LA":RightNow.Interface.getMessage('PLEASE_ENTER_LOWERCASE_LETTER_MSG'),"LL":RightNow.Interface.getMessage('PLEASE_ENTER_A_LOWERCASE_LETTER_MSG'),"LC":RightNow.Interface.getMessage('PLS_ENTER_LOWERCASE_LETTER_SPECIAL_MSG'),"MA":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_OR_A_NUMBER_MSG'),"ML":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_MSG'),"MC":RightNow.Interface.getMessage('PLEASE_ENTER_LETTER_SPECIAL_CHAR_MSG'),"LEN":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_LONG_MSG'),"MISS":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_SHORT_MSG')};}
var message="",sampleMaskString=this._getSimpleMaskString().split("");for(var i=0,type;i<error.length;i++){type=error[i][1];if(type.charAt(0)==="F"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL')+type.charAt(1)+" ' <br>";sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{if(type!=="MISS"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+this._showMaskMessage._maskMessages[type]+"<br>";if(type!=="LEN"){sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{break;}}}}
sampleMaskString=sampleMaskString.join("");this._setMaskMessage(RightNow.Interface.getMessage('EXPECTED_INPUT_LBL')+": "+sampleMaskString+"<br>"+message);this._showMask();}},_setMaskMessage:function(message)
{var overlayContent=this._maskNode.get('bodyContent');if(overlayContent){overlayContent.set('innerHTML',message);}
else{this._maskNode.set('innerHTML',message);}},_showMask:function()
{if(this.Y.Overlay)
this._maskNode.show();else
RightNow.UI.show(this._maskNode);},_hideMaskMessage:function()
{if(this.Y.Overlay&&this._maskNode.get("visible")!==false)
this._maskNode.hide();else
RightNow.UI.hide(this._maskNode);},_onValidateFailure:function()
{if(this.data.js.mask&&this._maskNode.align&&this.Y.Overlay&&this._maskNode.get("visible")!==false){this._maskNode.align();}}});