
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a){this._errors=a||[];this._value=this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+
c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){for(var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' class='rn_HintBox'>"+this.data.attrs.hint+"</span>"),b=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;b.next();)b=b.next();a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:{node:b,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio()))this.input.on("click",function(){b.focus();a.show()});else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
(function(){var n=function(){var c={},b={},k={};return{getDeferred:function(f,e){if(c[f])return c[f];b[e]=b[e]||{events:[]};b[e].form=f;return{on:function(a,d,c){if(d&&"function"===typeof d)return b[e].events.push({name:a,handler:d,context:c}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,d){if(a&&d&&"object"===typeof d)k[f]||(k[f]={}),k[f][a]=d;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(b){return c[b]},newInstance:function(b,e){e instanceof RightNow.Form&&(c[b]=e)},getDeferredEvents:function(c){var e,a,d={};for(e in b)if(a=b[e],b.hasOwnProperty(e)&&a.form===c&&a.events.length){a=a.events;for(var h=0;h<a.length;h++)d[a[h].name]=d[a[h].name]||[],d[a[h].name].push(a[h])}return d},getDeferredFields:function(b){return k[b]}}}(),m=function(){function c(a,b,c,e){var g={},k=a.getAttribute("target");a.all("input, select, textarea").each(function(a){var b=a.get("type");""!==a.get("name")&&"submit"!==b&&"image"!==b&&(g[a.get("name")]=a.get("value"))});a=b+RightNow.Url.convertToSegment(g)+c;RightNow.Url.getSession()&&(a=RightNow.Url.addParameter(a,"session",RightNow.Url.getSession()));a=e.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",a);k&&a.setAttribute("target",k);e.Y.one(document.body).append(a);a=e.Y.Node.getDOMNode(a);document.createEvent?(e=document.createEvent("MouseEvents"),e.initEvent("click",!1,!1),a.dispatchEvent(e)):a.fireEvent("onclick")}function b(a){this.fire("response",new RightNow.Event.EventObject(this,{data:a}))}function k(a){this.fire("responseError",new RightNow.Event.EventObject(this,{data:a}))}var f={},e={};return{submitForm:function(a,d,h){var f=h.Y.one("#"+a),g=f.getAttribute("method"),l=f.getAttribute("action");a=e[a];d=d||"";if(l&&!h.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(l,"/")&&RightNow.Url.isExternalUrl(l)){d&&f.set("action",l+d);for(d=0;d<a.length;d++)(g=a[d])&&g.value&&((l=f.one('input[name="'+g.name+'"]'))?l.set("value",g.value):f.append(h.Y.Node.create('<input type="hidden" name="'+
g.name+'" value="'+g.value+'"/>')));f.submit()}else c(f,l,d,h);else{f=(l||"/ci/ajaxRequest/sendForm")+d;if(RightNow.Event.noSessionCookies())for(d=0,g=a.length;d<g;d++)if("Contact.Login"===a[d].name){document.cookie="cp_login_start=1;path=/";break}a={f_tok:h._originalEventObject.data.f_tok,form:RightNow.JSON.stringify(a),updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id")})};d={scope:h,json:!0,successHandler:b,failureHandler:k};g=RightNow.UI.Form;null!=g.smartAssistant&&(a.smrt_asst=g.smartAssistant);null!==g.smartAssistantToken&&(a.saToken=g.smartAssistantToken);if(h._originalEventObject){h._originalEventObject.data.timeout&&(d.timeout=h._originalEventObject.data.timeout);h=h._originalEventObject;for(var g=["challengeHandler","challengeHandlerContext"],m,l=0;l<g.length;++l)m=g[l],d[m]=h[m]||void 0}RightNow.Ajax.makeRequest(f,a,d)}},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,c){f[a]||(f[a]={});f[a][b]=c},findField:function(a,b){return f[a][b]},getAllFields:function(a){return f[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(b){b.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));this._errorMessageDiv.setAttribute("aria-live","assertive");if(this._parentForm){if(n.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");n.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=n.getDeferredEvents(this._parentForm);this.Y.Object.each(n.getDeferredFields(this._parentForm),function(b,c){m.addField(this._parentForm,c,b)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(b){m.resetValidatedFields(this._parentForm);this._challengeDivID&&(b.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=b},during:function(b){!1===b?this._eventCanceled=!0:b instanceof RightNow.Event.EventObject&&m.addValidatedField(this._parentForm,b)},post:function(b){var c=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+c,b)}})._addEventHandler("send",{post:function(b){this._eventCanceled||m.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(b){!1===b&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(b){b&&this._collectedFields.push(b)},post:function(b){this.fire("submit",b)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(c){throw"Failed while trying to parse a challenge provider.  "+c;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}}},_filterSubmittedWidgets:function(c){var b=m.getAllFields(this._parentForm),k=[];this.Y.Object.each(b,function(b,e){this.Y.Array.each(c,function(a,c){a.context===b&&-1===this.Y.Array.indexOf(this._collectedFields,e)&&k.push(c)},this)},this);return k},getValidatedFields:function(){return m.getValidatedFields(this._parentForm)},addField:function(c,b){m.addField(this._parentForm,c,b)},findField:function(c){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return m.findField(this._parentForm,c)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"'>"),"before")},_reportChallengeError:function(c){c=c||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+c+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus();return!1}))},_challengeHandler:function(c,b,k){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(c),this.on("submit",this._onValidateChallengeResponse,this));this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(c));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var c=this._challengeProvider.getInputs(this._challengeDivID);if(c.abuse_challenge_response)for(var b in c)c.hasOwnProperty(b)&&RightNow.Ajax.addRequestData(b,c[b])}},{find:function(c,b,k){if(c=RightNow.UI.findParentForm(c))return k?c:n.getDeferred(c,b);throw Error("You're using a form that doesn't have a proper form submit button or an id");}})})();
RightNow.Widgets.AnswerNotificationManager=RightNow.Widgets.extend({constructor:function(){this.messageBox=this.Y.one(this.data.attrs.message_element?'#'+this.data.attrs.message_element:this.baseSelector+'_Message');this.notificationList=this.Y.one(this.baseSelector+'_List');if(this.notificationList){this.notificationList.delegate('click',this.onDeleteClick,'.rn_Notification .rn_Notification_Delete',this);this.notificationList.delegate('click',this.onRenewClick,'.rn_Notification .rn_Notification_Renew',this);}},onDeleteClick:function(e){this.handleClickEvent(e.target,'evt_answerNotificationDeleteRequest',this.data.attrs.delete_notification_ajax,this.onDeleteResponse);},onRenewClick:function(e){this.handleClickEvent(e.target,'evt_answerNotificationUpdateRequest',this.data.attrs.renew_notification_ajax,this.onRenewResponse);},handleClickEvent:function(button,event,endpoint,handler){var id=button.ancestor('.rn_Notification').getData('id'),eo=new RightNow.Event.EventObject(this,{data:{filter_type:'answer',id:parseInt(id,10)}});if(this.lockedItem!==id&&RightNow.Event.fire(event,eo)){RightNow.Ajax.makeRequest(endpoint,eo.data,{successHandler:handler,scope:this,data:eo,json:true});this.lockedItem=id;}},onDeleteResponse:function(response,eo){this.lockedItem=null;if(RightNow.Event.fire('evt_answerNotificationDeleteResponse',{data:eo,response:response})){if(response.error){RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG"),{icon:"WARN"});}
else{this.displayMessage(this.data.attrs.label_notif_deleted);var item=this.notificationList.one('.rn_Notification[data-id="'+eo.data.id+'"]'),scope=this;if(item){item.transition({opacity:0,duration:0.4},function(){this.remove();if(!scope.notificationList.all('.rn_Notification').size()){scope.notificationList.append(scope.data.attrs.label_no_notifs);}});}}}},onRenewResponse:function(response,eo){this.lockedItem=null;if(RightNow.Event.fire('evt_answerNotificationRenewResponse',{data:eo,response:response})){if(response.error){RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG"),{icon:"WARN"});}
else{this.displayMessage(this.data.attrs.label_notif_renewed);this.notificationList.get('childNodes').remove();this.Y.Array.each(response.notifications,function(notification){this.notificationList.append(new EJS({text:this.getStatic().templates.view}).render({id:notification.id,url:RightNow.Url.addParameter(RightNow.Url.addParameter(this.data.attrs.url,'a_id',notification.id),'session',RightNow.Url.getSession()),summary:notification.summary,subscribedLabel:RightNow.Interface.getMessage('SUBSCRIBED_ON_PCT_S_LBL').replace("%s",notification.startDate),expiresLabel:notification.expiration||RightNow.Interface.getMessage('NO_EXPIRATION_DATE_LBL'),includeRenew:!!this.data.js.duration,renewLabel:this.data.attrs.label_renew_button,deleteLabel:this.data.attrs.label_delete_button}));},this);}}},displayMessage:function(message){this.messageBox.setStyle("opacity",0).addClass("rn_MessageBox");this.messageBox.transition({opacity:1,duration:0.4});this.messageBox.set('innerHTML',message);RightNow.UI.updateVirtualBuffer();this.messageBox.set('tabIndex',0);this.messageBox.focus();}});
RightNow.Widgets.ProdCatNotificationManager=RightNow.Widgets.extend({constructor:function()
{this._widgetContainer=this.Y.one(this.baseSelector+'_List');this._numberOfNotifs=this.data.js.notifications.length;this.displayRenewButton=this.data.js.duration;this._messageDiv=((this.data.attrs.message_element)?this.Y.one('#'+this.data.attrs.message_element):null)||this.Y.one(this.baseSelector+'_Message');if(!this._widgetContainer)return;if(this._numberOfNotifs)
{for(var i=0;i<this._numberOfNotifs;i++)
{this.Y.one(this.baseSelector+'_Delete_'+i).on('click',this._onButtonClick,this,{"index":i,"delete":true});if(this.displayRenewButton){this.Y.one(this.baseSelector+'_Renew_'+i).on('click',this._onButtonClick,this,{"index":i,"renew":true});}}}
this.Y.one(this.baseSelector+'_AddButton').on('click',this._openDialog,this);RightNow.Event.subscribe("evt_menuFilterSelectRequest",this._closeDialog,this);RightNow.Event.subscribe("evt_menuFilterSelectResponse",this._onProdCatAdded,this);},_openDialog:function()
{var dialogBody=this.Y.one(this.baseSelector+"_Dialog");if(dialogBody&&!this._dialog)
{dialogBody=this.Y.Node.getDOMNode(dialogBody.removeClass('rn_Hidden'));var buttons=[{text:this.data.attrs.label_dialog_cancel,handler:{fn:this._closeDialog,scope:this},isDefault:true}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_add_button,dialogBody,{"buttons":buttons});RightNow.UI.show(dialogBody);}
this._dialog.show();this._dialog.bodyNode.one("a").focus();},_closeDialog:function(evt)
{if(typeof evt==='string'){this._widgetContainer.set('innerHTML',"").addClass('rn_Loading');this._messageDiv.removeClass('rn_MessageBox').set('innerHTML',"");}
if(this._dialog){this._dialog.hide();this._clearErrorMessage();}},_onButtonClick:function(evt,notifElement)
{this._buttonClicked=evt.target;this._buttonClicked.disabled=true;this._currentNotif=this.Y.one(this.baseSelector+"_Notification_"+notifElement.index);var notifValue=this.data.js.notifications[notifElement.index],eventObject=new RightNow.Event.EventObject(this,{data:{filter_type:notifValue.filter_type||(notifValue.type==='product'?this.data.js.productsTable:this.data.js.categoriesTable),id:notifValue.id}}),event,successHandler,endpoint;if(notifElement.renew){event='evt_prodCatRenewRequest';successHandler=this._onRenewResponse;endpoint=this.data.attrs.renew_notification_ajax;}
else{event='evt_prodCatDeleteRequest';successHandler=this._onDeleteResponse;endpoint=this.data.attrs.delete_notification_ajax;}
if(RightNow.Event.fire(event,eventObject)){RightNow.Ajax.makeRequest(endpoint,eventObject.data,{successHandler:successHandler,scope:this,data:eventObject,json:true});}},_onRenewResponse:function(response,originalEventObj)
{if(RightNow.Event.fire('evt_prodCatRenewResponse',{data:originalEventObj,response:response})){if(response.error){this._displayMessage(response.error);}
else{this._displayMessage(this.data.attrs.label_notif_renewed);this._buttonClicked.set('disabled',false);this._widgetContainer.set('innerHTML',"");this._onProdCatAdded(null,[response]);}}},_onDeleteResponse:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_prodCatDeleteResponse",{data:originalEventObj,response:response})){if(response.error){this._displayMessage(response.error);}
else{this._displayMessage(this.data.attrs.label_notif_deleted);if(this._currentNotif){this._currentNotif.transition({opacity:0,duration:0.4},function(){this.remove();});}
if(--this._numberOfNotifs===0){this._widgetContainer.set('innerHTML',this.data.attrs.label_no_notifs);}
this._buttonClicked.set('disabled',false);}}},_onProdCatAdded:function(evt,response)
{response=response[0];var notifications=response.notifications,notification,hierValue,deleteButtonID,renewButtonID;this._widgetContainer.removeClass('rn_Loading');this._numberOfNotifs=notifications.length;for(var i=0;i<this._numberOfNotifs;i++){renewButtonID=(this.displayRenewButton)?this.baseDomID+'_Renew_'+i:null;deleteButtonID=this.baseDomID+'_Delete_'+i;notification=notifications[i];this._widgetContainer.append(this.Y.Node.create(new EJS({text:this.getStatic().templates.view}).render({divID:this.baseDomID+'_Notification_'+i,href:RightNow.Url.addParameter(this.data.attrs.report_page_url+((notification.type==='product')?"/p/":"/c/")+notification.chain,'session',RightNow.Url.getSession()),label:notification.label+' - '+this.Y.Escape.html(notification.summary),startDate:RightNow.Interface.getMessage('SUBSCRIBED_ON_PCT_S_LBL').replace("%s",notification.startDate),expirationDate:notification.expiration,renewButtonID:renewButtonID,labelRenewButton:this.data.attrs.label_renew_button,deleteButtonID:deleteButtonID,labelDeleteButton:this.data.attrs.label_delete_button})));this.Y.one('#'+deleteButtonID).on('click',this._onButtonClick,this,{"index":i,"delete":true});if(this.displayRenewButton){this.Y.one('#'+renewButtonID).on('click',this._onButtonClick,this,{"index":i,"renew":true});}}
this.data.js.notifications=notifications;},_clearErrorMessage:function(){this.Y.all('.rn_ErrorMessage').each(RightNow.UI.hide);},_displayMessage:function(message)
{this._messageDiv.setStyle('opacity',0).addClass('rn_MessageBox');this._messageDiv.transition({opacity:1,duration:0.4});this._messageDiv.set('innerHTML',message);RightNow.UI.updateVirtualBuffer();this._messageDiv.set('tabIndex',0).focus();}});
RightNow.Widgets.ProductCategoryInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this._currentIndex=0;this._noValueNodeIndex=0;this._maxDepth=this.data.attrs.max_lvl||6;this._displayField=this.Y.one(this.baseSelector+"_"+this.data.attrs.data_type+"_Button");this._displayFieldVisibleText=this.Y.one(this.baseSelector+"_Button_Visible_Text");this._accessibleView=this.Y.one(this.baseSelector+"_Links");this._outerTreeContainer=this.Y.one(this.baseSelector+"_TreeContainer");this._treeNode=this.Y.one(this.baseSelector+"_Tree");this._notRequiredDueToProductLinking=false;if(this.data.js.readOnly||!this._displayField)return;var RightNowEvent=RightNow.Event;RightNowEvent.subscribe("evt_menuFilterGetResponse",this._getSubLevelResponse,this);this.parentForm().on('submit',this._onValidate,this);RightNowEvent.subscribe("evt_accessibleTreeViewGetResponse",this._getAccessibleTreeViewResponse,this);if(this.data.attrs.set_button)
this.Y.one(this.baseSelector+"_"+this.data.attrs.data_type+"_SetButton").on("click",this._setButtonClick,this);if(this.data.attrs.hint)
this._hintOverlay=this._initializeHint();this._displayField.on("click",this._toggleProductCategoryPicker,this);this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this._toggleAccessibleView,this);this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this.data.attrs.data_type,hm_type:this.data.js.hm_type,linking_on:this.data.js.linkingOn,linkingProduct:0,table:"Incident",cache:[],name:((this.data.attrs.data_type.indexOf('prod')>-1)?'prod':'cat')}});this._buildMenuPanel();if(this.data.js.hierData[0].length)
this._buildTree();this.on('constraintChange:required_lvl',this.updateRequiredLevel,this);},_initializeHint:function()
{if(this.Y.Overlay)
{var overlay;if(this.data.attrs.always_show_hint)
{overlay=this._createHintElement(true);}
else
{overlay=this._createHintElement(false);this._displayField.on("focus",function(){overlay.show();});this._displayField.on("blur",function(){overlay.hide();});}
return overlay;}
else
{var hint=this.Y.Node.create('<span class="rn_HintText"/>').setHTML(this.data.attrs.hint);this._displayField.insert(hint,'after');}}},_buildMenuPanel:function(){this._panel=new this.Y.Panel({srcNode:this._outerTreeContainer.removeClass('rn_Hidden'),width:300,visible:false,render:this.Y.one(this.baseSelector),headerContent:null,buttons:[],hideOn:[{eventName:'clickoutside'}],align:{node:this._displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]},zIndex:2});this._panel.on('visibleChange',function(e){if(e.newVal){this._treeNode.setStyle("display","block");}
else{this._treeNode.setStyle("display","none");if(this.data.attrs.hint&&!this.data.attrs.always_show_hint){this._toggleHint("hide");}}},this);this._treeNode.setStyle('overflow-y','auto');},_buildTree:function()
{var YAHOO=this.Y.Port(),gallery=this.Y.apm;if(this._treeNode&&gallery.TreeView)
{this._tree=new gallery.TreeView(this._treeNode.get('id'));this._tree.setDynamicLoad(RightNow.Event.createDelegate(this,this._getSubLevelRequest));this._tree.subscribe('focusChanged',function(e){if(e.newNode){this._treeCurrentFocus=e.newNode;}
else if(e.oldNode){this._treeCurrentFocus=e.oldNode;}},this);if(!this.data.attrs.show_confirm_button_in_dialog){YAHOO.util.Event.on(this._tree.getEl(),"keyup",function(ev){if(ev.keyCode===RightNow.UI.KeyMap.TAB)
{var currentNode=this._treeCurrentFocus;if(currentNode.href){if(currentNode.target){window.open(currentNode.href,currentNode.target);}
else{window.location(currentNode.href);}}
else{currentNode.toggle();}
this._tree.fireEvent('enterKeyPressed',currentNode);YAHOO.util.Event.preventDefault(ev);}},null,this);}
var hasDefaultValue=false,hierData=this.data.js.hierData||this.data.js.hierDataNone,scope=this,insertNodes=function(nodeList,root){var dataNode,node,childNodes=[],i;for(i=0;i<nodeList.length;i++){dataNode=nodeList[i];node=new gallery.MenuNode(scope.Y.Escape.html(dataNode.label),root);node.href='javascript:void(0)';node.hierValue=dataNode.id;if(!dataNode.hasChildren){node.dynamicLoadComplete=true;node.iconMode=1;}
if(dataNode.selected){hasDefaultValue=true;scope._currentIndex=node.index;}
if(dataNode.hasChildren&&hierData[dataNode.id]){childNodes.push({children:hierData[dataNode.id],parent:node});}}
root.loadComplete();for(i=0;i<childNodes.length;i++){insertNodes(childNodes[i].children,childNodes[i].parent);}};if(this.data.js.hierData&&this.data.js.hierDataNone)
delete this.data.js.hierData;insertNodes(hierData[0],this._tree.getRoot());var noValueNode=this._tree.getRoot().children[0];noValueNode.isLeaf=true;this._noValueNodeIndex=noValueNode.index;this._tree.subscribe("enterKeyPressed",this._enterPressed,this);if(this.data.attrs.show_confirm_button_in_dialog)
{var confirmButton=this.Y.one(this.baseSelector+'_'+this.data.attrs.data_type+'_ConfirmButton'),cancelButton=this.Y.one(this.baseSelector+'_'+this.data.attrs.data_type+'_CancelButton');confirmButton.detach('click');cancelButton.detach('click');cancelButton.detach('keydown');confirmButton.on('click',function(){this._selectNode({node:this._treeCurrentFocus});},this);cancelButton.on('click',function(){this._panel.hide();},this);cancelButton.on('key',function(ev){!ev.shiftKey&&this._toggleProductCategoryPicker();},'tab',this);}
else
{this._tree.subscribe('clickEvent',this._selectNode,this);}
this._tree.subscribe('expandComplete',function(e){this._treeNode.set('scrollTop',this.Y.one('#'+e.contentElId).ancestor('.ygtvitem').get('offsetTop'));},this);this._tree.collapseAll();if(this.data.attrs.show_confirm_button_in_dialog)
this._outerTreeContainer.setStyle("display","block");this._treeNode.setStyle("display","block");if(hasDefaultValue)
this._displaySelectedNodesAndClose(false);}},_levelOfNode:function(node)
{return(node===null||typeof node.depth==="undefined")?0:node.depth+1;},_displayAccessibleDialog:function()
{if(!this._tree)
this._buildTree();if(!(this._dialog))
{var handleDismiss=function()
{this.hide();};this._buttons=[{text:RightNow.Interface.getMessage("CANCEL_CMD"),handler:handleDismiss,isDefault:false}];RightNow.UI.show(this._accessibleView);this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_nothing_selected,this._accessibleView,{"buttons":this._buttons});this._dialog.after('visibleChange',function(e)
{if(!e.newVal)
{this._displayField.focus();}},this);}
else
{var currentlySelectedSpan=document.getElementById(this.baseDomID+"_IntroCurrentSelection");var introLink=document.getElementById(this.baseDomID+"_Intro");if(currentlySelectedSpan&&introLink)
{var currentNode=this._tree.getNodeByIndex(this._currentIndex);if(!currentNode)
{currentNode={};currentNode.hierValue=0;}
var localInstanceID=this.instanceID;introLink.onclick=function(){document.getElementById("rn_"+localInstanceID+"_AccessibleLink_"+currentNode.hierValue).focus();};var selectedNodes=this._getSelectedNodesMessage();selectedNodes=selectedNodes[0]?selectedNodes.join(", "):this.data.attrs.label_all_values;currentlySelectedSpan.innerHTML=RightNow.Text.sprintf(RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),selectedNodes);}}
this._dialog.show();},_toggleAccessibleView:function()
{if(this.data.attrs.data_type==="Category"&&this.data.js.linkingOn)
this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct;if(this._flatTreeViewData)
this._displayAccessibleDialog();else
RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo);},_getAccessibleTreeViewResponse:function(e,args)
{if(args[0].data.hm_type!=this._eo.data.hm_type)
return;var evtObj=args[0];if(evtObj.data.data_type==this.data.attrs.data_type)
{this._flatTreeViewData=evtObj.data.accessibleLinks;var noValue={0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0};if(!this.Y.Lang.isArray(this._flatTreeViewData))
{var tempArray=[];for(var i in this._flatTreeViewData)
{if(!isNaN(parseInt(i,10)))
tempArray[i]=this._flatTreeViewData[i];}
this._flatTreeViewData=tempArray;}
this._flatTreeViewData.unshift(noValue);var htmlList="<p><a href='javascript:void(0)' id='rn_"+this.instanceID+"_Intro'"+"onclick='document.getElementById(\"rn_"+this.instanceID+"_AccessibleLink_"+noValue[1]+"\").focus();'>"+RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_LNKS_DEPTH_ANNOUNCED_MSG"),this.data.attrs.label_input)+" <span id='rn_"+this.instanceID+"_IntroCurrentSelection'>"+RightNow.Text.sprintf(RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),noValue[0])+"</span></a></p>",previousLevel=-1;for(i in this._flatTreeViewData)
{if(this._flatTreeViewData.hasOwnProperty(i))
{var item=this._flatTreeViewData[i];if(item.level>previousLevel)
htmlList+="<ol>";while(item.level<previousLevel)
{htmlList+="</li></ol>";previousLevel--;}
if(item.level===previousLevel){htmlList+="</li>";}
htmlList+='<li><a href="javascript:void(0)" id="rn_'+this.instanceID+'_AccessibleLink_'+item[1]+'" class="rn_AccessibleHierLink" data-hierList="'+item.hier_list+'">'+'<span class="rn_ScreenReaderOnly">'+this.data.attrs.label_level+' '+(item.level+1)+'</span>'+item[0]+'</a>';previousLevel=item.level;}}
for(i=previousLevel;i>=0;--i)
htmlList+="</li></ol>";htmlList+="<div id='rn_"+this.instanceID+"_AccessibleErrorLocation'></div>";this._accessibleView.setHTML(htmlList).all('a.rn_AccessibleHierLink').on('click',this._accessibleLinkClick,this);this._displayAccessibleDialog();}},_accessibleLinkClick:function(e)
{var element=e.target;var hierArray=element.getAttribute("data-hierList").split(",");var i=hierArray.length-1;var currentNode=null;while(!currentNode&&i>=0)
{currentNode=this._tree.getNodeByProperty("hierValue",parseInt(hierArray[i],10));i--;}
i++;if(this._noValueNodeIndex===currentNode.index||currentNode.hierValue==hierArray[hierArray.length-1])
{this._selectNode({node:currentNode});}
else
{var onExpandComplete=function(expandingNode)
{if(expandingNode.nextToExpand)
{var nextNode=this._tree.getNodeByProperty("hierValue",parseInt(expandingNode.nextToExpand,10));if(nextNode)
{nextNode.nextToExpand=hierArray[++i];nextNode.expand();}}
else if(i===hierArray.length)
{this._tree.unsubscribe("expandComplete",onExpandComplete,null);this._selectNode({node:expandingNode});}
return true;};this._tree.subscribe("expandComplete",onExpandComplete,this);currentNode.nextToExpand=hierArray[++i];currentNode.expand();}
return false;},_toggleProductCategoryPicker:function(e)
{if(!this._tree)
this._buildTree();if(!this._panel.get("visible"))
{this._panel.align().show();var currentNode=this._tree.getNodeByIndex(this._currentIndex)||this._tree.getRoot().children[0];if(currentNode&&currentNode.focus)
{currentNode.focus();}
this._toggleHint("show");}
else
{this._toggleHint("hide");}},_getSelectedNodesMessage:function()
{return this._getPropertyChain("label");},_getPropertyChain:function(property)
{property=property||"label";this._currentIndex=this._currentIndex||1;var hierValues=[],currentNode=this._tree.getNodeByIndex(this._currentIndex);while(currentNode&&!currentNode.isRoot())
{hierValues.push(currentNode[property]);currentNode=currentNode.parent;}
return hierValues.reverse();},_displaySelectedNodesAndClose:function(focus)
{var hierValues,description,descText;this._eo.data.value=this._currentIndex;this._eo.data.hierChain=this._getPropertyChain('hierValue');RightNow.Event.fire("evt_productCategorySelected",this._eo);this.fire('change',this);delete this._eo.data.hierChain;this._panel.hide();this._displayField.setAttribute("aria-busy","true");if(this._currentIndex<=this._noValueNodeIndex)
{this._displayFieldVisibleText.setHTML(this.data.attrs.label_nothing_selected);descText=this.data.attrs.label_nothing_selected;}
else
{hierValues=this._getSelectedNodesMessage().join("<br>");this._displayFieldVisibleText.setHTML(hierValues);descText=this.data.attrs.label_screen_reader_selected+hierValues;}
description=this.Y.one(this.baseSelector+"_TreeDescription");if(description)
description.setHTML(descText);this._displayField.setAttribute("aria-busy","false");if(this._dialog&&this._dialog.get("visible"))
this._dialog.hide();if(focus&&this._displayField.focus&&!this._dialog)
try{this._displayField.focus();}catch(e){}},_enterPressed:function(keyEvent)
{this._selectNode({node:keyEvent.details[0]});},_selectNode:function(clickEvent)
{this._selectedNode=clickEvent.node;this._currentIndex=this._selectedNode.index;this._selected=true;if((!this._selectedNode.expanded&&this._currentIndex!==this._noValueNodeIndex&&!this._selectedNode.dynamicLoadComplete)||(this.data.js.linkingOn&&this.data.attrs.data_type==="Product"))
{this._getSubLevelRequest(clickEvent.node);}
else
{this._errorLocation="";this._checkRequiredLevel();}
this._displaySelectedNodesAndClose(true);if(clickEvent.event)
clickEvent.event.preventDefault();return false;},_getSubLevelRequest:function(expandingNode)
{if(this._nodeBeingExpanded)return;this._nodeBeingExpanded=true;this._eo.data.level=expandingNode.depth+1;this._eo.data.value=expandingNode.hierValue;this._eo.data.label=expandingNode.label;if(this.data.attrs.show_confirm_button_in_dialog)
this._requestedIndex=expandingNode.index;else
this._currentIndex=expandingNode.index;if(this.data.attrs.data_type==="Product")
{RightNow.UI.Form.currentProduct=this._eo.data.value;}
this._eo.data.reset=false;if(this._eo.data.linking_on)
{if(this.data.attrs.data_type==="Category")
{if(expandingNode.children.length)
{this._nodeBeingExpanded=false;return;}
this._eo.data.reset=(this._eo.data.value<1);}
else if(this._eo.data.value<1&&this.data.attrs.data_type==="Product")
{this._nodeBeingExpanded=false;RightNow.Event.fire("evt_menuFilterGetResponse",new RightNow.Event.EventObject(this,{data:{reset_linked_category:true,data_type:"Category",reset:true}}));return;}}
if(this.data.js.link_map)
{this._eo.data.link_map=this.data.js.link_map;delete this.data.js.link_map;}
RightNow.Event.fire("evt_menuFilterRequest",this._eo);if(this._eo.data.link_map)
delete this._eo.data.link_map;this._nodeBeingExpanded=false;},_getSubLevelResponse:function(type,args)
{var evtObj=args[0],tempNode;if((evtObj.w_id&&evtObj.w_id===this.instanceID)||(this.data.js.linkingOn&&evtObj.data.data_type==="Category"&&this.data.attrs.data_type===evtObj.data.data_type))
{var currentRoot;if(evtObj.data.reset_linked_category&&this.data.attrs.data_type==="Category")
{if(this.data.js.link_map)
delete this.data.js.link_map;if(!this._tree||evtObj.data.reset)
{this._buildTree();this._linkedCategorySubset=false;}
this._flatTreeViewData=null;currentRoot=this._tree.getRoot();if(!evtObj.data.reset)
{this._linkedCategorySubset=true;currentRoot.dynamicLoadComplete=false;this._tree.removeChildren(currentRoot);tempNode=new this.Y.apm.MenuNode(this.Y.Escape.html(this.data.attrs.label_all_values),currentRoot,false);tempNode.hierValue=0;tempNode.href='javascript:void(0);';tempNode.isLeaf=true;this._noValueNodeIndex=this._currentIndex=this._requestedIndex=tempNode.index;}
this._displayFieldVisibleText.setHTML(this.data.attrs.label_nothing_selected);var description=this.Y.one(this.baseSelector+"_TreeDescription");if(description)
description.setHTML(this.data.attrs.label_nothing_selected);this._errorLocation='';this._checkRequiredLevel();}
else
{currentRoot=this._tree.getNodeByIndex(this.data.attrs.show_confirm_button_in_dialog?this._requestedIndex:this._currentIndex);}
var hierLevel=evtObj.data.level,hierData=evtObj.data.hier_data;if(hierLevel<=this._maxDepth)
{for(var i=0,hierValue;i<hierData.length;i++)
{hierValue=hierData[i].id;if(!currentRoot.children[i]||currentRoot.children[i].hierValue!==hierValue)
{tempNode=new this.Y.apm.MenuNode(this.Y.Escape.html(hierData[i].label),currentRoot,false);tempNode.hierValue=hierValue;tempNode.href='javascript:void(0);';if(!hierData[i].hasChildren||hierLevel===this._maxDepth)
{tempNode.dynamicLoadComplete=true;tempNode.iconMode=1;}}}
currentRoot.loadComplete();}
if(this._selected&&this.data.attrs.required_lvl)
{this._errorLocation="";this._checkRequiredLevel();this._selected=false;}}},_setButtonClick:function()
{var hierValues=[],ID;if(this._currentIndex<=this._noValueNodeIndex){if(!this._errorMessageDiv){this._errorMessageDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'/>");this.Y.one(this.baseSelector).prepend(this._errorMessageDiv);}
this._errorMessageDiv.setHTML("<b><a href='javascript:void(0);' onclick='document.getElementById(\""+this._displayField.get('id')+"\").focus(); return false;'>"+
this.data.attrs.label_nothing_selected+"</a></b>");RightNow.UI.show(this._errorMessageDiv);var errorLink=this._errorMessageDiv.one('a');if(errorLink){errorLink.focus();}
return;}
if(!this._checkRequiredLevel()){return;}
RightNow.UI.hide(this._errorMessageDiv);var currentNode=this._tree.getNodeByIndex(this._currentIndex),index=currentNode.depth+1;while(currentNode&&!currentNode.isRoot()){ID=currentNode.hierValue;hierValues[index]={"id":ID,"label":currentNode.label};currentNode=currentNode.parent;index--;}
this._currentIndex=this._noValueNodeIndex;var description=this.Y.one(this.baseSelector+"_TreeDescription");if(this._displayField&&description){description.setHTML(this.data.attrs.label_nothing_selected);this._displayFieldVisibleText.setHTML(this.data.attrs.label_nothing_selected);}
this._eo.data.hierSetData=hierValues;this._eo.data.id=hierValues[hierValues.length-1].id;RightNow.Event.fire("evt_menuFilterSelectRequest",this._eo);},_onValidate:function(type,args)
{var formEventObject=this.createEventObject();this._errorLocation=this.lastErrorLocation=args[0].data.error_location;if(this._checkRequiredLevel())
{formEventObject.data.value=(this._currentIndex&&this._currentIndex!==this._noValueNodeIndex)?this._tree.getNodeByIndex(this._currentIndex).hierValue:null;if(formEventObject.data.required&&this._notRequiredDueToProductLinking){formEventObject.data.required=false;}
RightNow.Event.fire("evt_formFieldValidatePass",formEventObject);return formEventObject;}
RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;},_createHintElement:function(visibility)
{var overlay=this.Y.Node.create("<span class='rn_HintBox'/>").set('id',this.baseDomID+'_Hint').setHTML(this.data.attrs.hint);if(visibility)
overlay.addClass("rn_AlwaysVisibleHint");return new this.Y.Overlay({visible:visibility,align:{node:this._displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]},bodyContent:overlay,render:this.Y.one(this.baseSelector)});},_toggleHint:function(hideOrShow)
{if(this._hintOverlay&&this._hintOverlay[hideOrShow]&&!this.data.attrs.always_show_hint)
this._hintOverlay[hideOrShow]();},swapLabel:function(container,requiredLevel,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,requiredLevel:requiredLevel,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL")};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateRequiredLevel:function(evt,constraint){var newLevel=constraint[0].constraint;if(newLevel>this.data.attrs.max_lvl||this.data.attrs.required_lvl===newLevel)return;if(this.data.attrs.required_lvl>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
this.swapLabel(this.Y.one(this.baseSelector+'_Label'),newLevel,this.data.attrs.label_input,this.getStatic().templates.label);this.data.attrs.required_lvl=newLevel;if(!newLevel){this._displayField.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").removeClass("rn_ErrorLabel");}
else{this._errorLocation="";this._checkRequiredLevel();}},_checkRequiredLevel:function()
{if(this.data.attrs.required_lvl)
{if(!this._tree)
{this._buildTree();this._currentIndex=this._noValueNodeIndex;}
var currentNode=this._tree.getNodeByIndex(this._currentIndex);this._removeRequiredError(currentNode);var currentDepth=(currentNode)?currentNode.depth+1:1;this._notRequiredDueToProductLinking=false;if(this.data.js.linkingOn&&this.data.attrs.data_type==="Category"&&this._linkedCategorySubset)
{if(this._tree.getNodeCount()===1)
{this._notRequiredDueToProductLinking=true;return true;}
else if((this._currentIndex===this._noValueNodeIndex)||(((currentNode.dynamicLoadComplete===false)||currentNode.hasChildren(false))&&(currentDepth<this.data.attrs.required_lvl)))
{this._displayRequiredError(currentNode);return false;}}
else if((!currentNode)||(this._currentIndex===this._noValueNodeIndex)||(((currentNode.dynamicLoadComplete===false)||currentNode.hasChildren(false))&&(currentDepth<this.data.attrs.required_lvl)))
{this._displayRequiredError(currentNode);return false;}}
return true;},_removeRequiredError:function(currentNode)
{this._displayField.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").removeClass("rn_ErrorLabel");currentNode=this._displayRequiredError.errorNode||currentNode;if(currentNode)
currentNode.removeClass("rn_ErrorField");this.Y.one(this.baseSelector+"_RequiredLabel").replaceClass("rn_RequiredLabel","rn_Hidden");RightNow.UI.hide(this._accessibleErrorMessageDiv);},_displayRequiredError:function(currentNode)
{this._displayField.addClass("rn_ErrorField");this.Y.one(this.baseSelector+"_Label").addClass("rn_ErrorLabel");currentNode||(currentNode=this._tree.getRoot().children[0]);currentNode.addClass("rn_ErrorField");this._displayRequiredError.errorNode=currentNode;var message=this.data.attrs.label_nothing_selected;if(currentNode.index!==this._noValueNodeIndex)
{message=(this.data.attrs.label_required.indexOf("%s")>-1)?RightNow.Text.sprintf(this.data.attrs.label_required,currentNode.label):this.data.attrs.label_required;}
var requiredLabel=this.Y.one(this.baseSelector+"_RequiredLabel");if(requiredLabel)
{requiredLabel.setHTML(message).replaceClass('rn_Hidden','rn_RequiredLabel');}
var label=this.data.attrs.label_error||this.data.attrs.label_input;if(this._errorLocation)
{var commonErrorDiv=this.Y.one('#'+this._errorLocation);if(commonErrorDiv){commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='#' onclick='document.getElementById(\""+this._displayField.get('id')+"\").focus(); return false;'>"+
label+" - "+message+"</a></b></div> ");}}
if(this._dialog&&this._dialog.get("visible"))
{this._accessibleErrorMessageDiv||(this._accessibleErrorMessageDiv=this.Y.one(this.baseSelector+"_AccessibleErrorLocation"));if(this._accessibleErrorMessageDiv)
{this._accessibleErrorMessageDiv.setHTML("<div><b><a id='rn_"+this.instanceID+"_FocusLink' href='javascript:void(0);' "+" onclick='document.getElementById(\""+"rn_"+this.instanceID+"_AccessibleLink_"+currentNode.hierValue+"\").focus(); return false;'>"+
label+" - "+message+"</a></b></div> ").addClass('rn_MessageBox').addClass('rn_ErrorMessage').removeClass('rn_Hidden');}
var errorLink=this.Y.one(this.baseSelector+"_FocusLink");RightNow.UI.updateVirtualBuffer();if(errorLink)
errorLink.focus();}}});