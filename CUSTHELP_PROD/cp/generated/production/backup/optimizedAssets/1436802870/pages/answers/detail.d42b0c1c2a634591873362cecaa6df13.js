
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
(function(){function r(f){function h(a,b){b=b?RightNow.Url.convertToSegment(RightNow.Url.convertToArray(1,b)):"";d.add({state:a},{url:p.getCurrentPage()+b})}function k(a){return function(){g||a.apply(this,arguments)}}var c={},e={},a={},b="",g=!1,d=new f.HistoryHTML5;d.on("change",function(a){var b;a.src===f.HistoryHTML5.SRC_POPSTATE&&(a=a.changed.state||a.changed[RightNow.Event.browserHistoryManagementKey],b=l.get(),g=!0,a?f.Object.each(a.newVal,function(a){q.ajaxCallback(a.response,a.data)}):f.Object.each(b,function(a){a.fire("reset").fire("send")}),g=!1)});return{enabled:!0,setCache:function(a,b,g){c[a]||(c[a]={});c[a][b]=g},checkCache:function(a,b){return c[a]?c[a][b]:null},restoreCache:k(function(c){f.Object.isEmpty(e)&&h(a,b+=c.friendly);b=""}),addRequest:k(function(c,g){f.Object.isEmpty(e)&&(q.searchesPerformed++,a={},b="");e[g]=c}),addResponse:k(function(c,g){var d=e[g];if(d){var k=b+=d.friendly,d=f.merge(d,c);a[g]=d;delete e[g];f.Object.isEmpty(e)&&h(a,k)}})}}var m,q,p,l;"pushState"in window.history?YUI().use("history-html5",function(f){m=r(f)}):m={enabled:!1};q=function(){function f(a,b,c){var d="undefined"===typeof c;a&&!d&&m.addResponse({response:a,data:b},c);m.setCache(b.searchSource,b.cacheKey,a);c=l.get(b.searchSource);d&&(c.once("send",function(){return!1}).fire("send",b.allFilters),a.fromHistoryManager=!0);c.fire("response",new RightNow.Event.EventObject(null,{data:a,filters:b.allFilters}))}function h(a,b,c,d){a=RightNow.Ajax.makeRequest(a,b,{successHandler:f,failureHandler:function(a){var b=RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:c,timeout:1E4});m.addRequest(d,a.id+"")}function k(a,b,c,d){var f=["keyword"].concat(a.filters||[]),s=f.length,h,k,l={};c=RightNow.Lang.cloneObject(c);a.params&&(c=e.mix(c,a.params));if(b&&b.allFilters)for(a=0;a<s;a++)h=f[a],(k=b.allFilters[h])&&k.filters&&k.filters.data&&!c[h]&&("keyword"!==h||d||(h="kw"),l[h]=c[h]=k.filters.data);c.page&&!l.page&&(l.page=c.page);return{filtersToInclude:l,params:c}}function c(a,b){b&&1!==b||(a=RightNow.Url.addParameter(a,"search","1"));return a}var e=YUI();return{searchesPerformed:0,go:function(a,b,g,d,e){if("report"===d.type){if("undefined"===typeof b)throw Error("No search filters have been defined for report "+d.id);RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b}));if(!m.enabled||!0===a.newPage||a.reportPage&&!RightNow.Url.isSameUrl(a.reportPage))if(g=RightNow.Url,d=a.reportPage||p.getCurrentPage(),e=a.target||"_self",!a.page&&b.allFilters.page&&(a.page=1,b.allFilters.page=1),d=g.convertSearchFiltersToParms(d,b.allFilters,0),d=g.addParameter(d,"session",g.getSession()),d=c(d,b.allFilters.page),a.popupWindow){b=window.screenX||window.screenLeft;g=window.screenY||window.screenTop;var f;f=b+document.body.clientWidth;e=screen.width*a.width/100;a=screen.height*a.height/100;f=b>screen.width-f?b-e-15:f+15;var n=window.screenY?window.screenY:window.screenTop;0>f&&(f=b+100);0>n&&(n=g+100);window.open(d,"_blank","scrollbars=1,resizable=1,left="+f+",top="+n+",width="+e+"px,height="+a+"px")}else window.open(d,e);else a.page?delete b.allFilters.search:b.allFilters.page=1,a=d.id,d=d.type+d.id,g=p.buildReportRequestParameters(a,b.allFilters,b.format,b.token,0),e=RightNow.Url.convertSearchFiltersToParms("",b.allFilters,""),f=g.sf,1===f.page&&(f.search=1),f=RightNow.JSON.stringify(f),n=m.checkCache(d,f),e={key:d,friendly:e},n?(m.restoreCache(e),l.get(d).fire("response",new RightNow.Event.EventObject(null,{data:n,filters:b}))):h("/ci/ajaxRequest/getReportData",{filters:f,report_id:a,r_tok:g.token,format:RightNow.JSON.stringify(g.fmt)},{searchSource:d,allFilters:b,cacheKey:f},e)}else if(g&&"object"===typeof g&&d.id)if(RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b})),m.enabled&&!0!==a.newPage){a=e.endpoint;b=k(e,b,g,!0);g=b.filtersToInclude;b=b.params;if(!a)throw Error("An endpoint hasn't been specified");d=d.type+d.id;e=RightNow.JSON.stringify(b);f=m.checkCache(d,e);g={key:d,friendly:RightNow.Url.convertToSegment(g)};f?(m.restoreCache(g),l.get(d).fire("response",new RightNow.Event.EventObject(null,{data:f,filters:b}))):h(a,b,{searchSource:d,allFilters:b,cacheKey:e},g)}else a=RightNow.Url,d=p.getCurrentPage(),b=k(e,b,g,!1).filtersToInclude,d+=a.convertToSegment(b),d=a.addParameter(d,"session",a.getSession()),d=c(d,b.page),window.open(d,"_self")},ajaxCallback:f}}();p={buildReportRequestParameters:function(f,h,k,c,e){var a=RightNow.Lang.cloneObject(h),b;for(b in a)a.hasOwnProperty(b)&&(a[b].filters&&(a[b].filters.report_id=parseInt(f,10)),a[b].data&&delete a[b].data);k||(k={});k.urlParms=RightNow.Url.buildUrlLinkString(h,k.parmList);return{c:e,id:f,sf:a,fmt:k,token:c}},getCurrentPage:function(){var f=window.location,h=f.pathname,f=f.origin||f.protocol+"//"+f.host;return"/"===h||"/app"===h||"/app/"===h?f+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):h.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};l=function(){function f(c){if(!c||!c.length||2>c.length)throw Error("You're doing it wrong");this.sources=c;this.multiple=!0}var h={},k=RightNow.EventProvider.extend({overrides:{constructor:function(c,e){this.parent();this.Y=c;delete this.data;delete this.baseDomID;delete this.baseSelector;this.searchSource=e;this.instanceID=e.id;this._addEventHandler("search",{pre:function(a){this._params||(this._params={});a instanceof RightNow.Event.EventObject&&(this._originalEventObject=RightNow.Lang.cloneObject(a),this._collectSearchFilters(a),this._params.newPage=a.filters.newPage)},during:function(a){a instanceof RightNow.Event.EventObject&&this._collectSearchFilters(a)},post:function(){var a,b;if(this._excludedFilters)for(a=0;a<this._excludedFilters.length;a++)b=this._excludedFilters[a],this._respondingFilters&&!this._respondingFilters[b]&&(b=this._filters.allFilters[b])&&b.filters&&(b.filters.data[0]?b.filters.data[0]=null:b.filters.data=null);this.fire("send",this._filters,this._params)}})._addEventHandler("send",{pre:function(a){this._originalEventObject||(this._originalEventObject={filters:{page:1,newPage:!1}});this._eventCancelled=!1},during:function(a){!1===a&&(this._eventCancelled=!0)},post:function(a){this._eventCancelled||(this._excludedFilters=[],q.go(this._originalEventObject.filters,this._filters,this._params,this.searchSource,this))}})._addEventHandler("setInitialFilters",{post:function(a){this._setInitialFilters(a)}})._addEventHandler("appendFilter",{post:function(a){this._originalEventObject||(this._originalEventObject=RightNow.Lang.cloneObject(a));this._mergeFilters(a)}})._addEventHandler("excludeFilterFromNextSearch",{post:function(a){this._excludedFilters||(this._excludedFilters=[]);this._excludedFilters.push(a.data.name)}})._addEventHandler("reset").on("reset",function(){var a=(this._filters=RightNow.Lang.cloneObject(this._initialFilters))?this._filters.allFilters:null;this._params&&a&&(this._initialParams&&(this._params=RightNow.Lang.cloneObject(this._initialParams)),this.Y.Object.each(this._params,function(b,c,d){a[c]&&a[c].filters&&"data"in a[c].filters&&(d[c]=a[c].filters.data)}))},this)}},_setFilters:function(c){this._filters=c},_setInitialFilters:function(c){c instanceof RightNow.Event.EventObject&&(this.Y.Object.isEmpty(c.filters)||(this._filters=c.filters,this._initialFilters=RightNow.Lang.cloneObject(c.filters)),this.Y.Object.isEmpty(c.data)||(this._params=c.data,this._initialParams=RightNow.Lang.cloneObject(c.data)))},_mergeFilters:function(c){this._filters.allFilters=this.Y.mix(this._filters.allFilters,c.filters,!0,null,0,!0)},_collectSearchFilters:function(c){c=new RightNow.Event.EventObject({instanceID:c.w_id},RightNow.Lang.cloneObject(c));c.filters.searchName?(this._respondingFilters||(this._respondingFilters={}),this._respondingFilters[c.filters.searchName]=!0,this._filters||(this._filters={}),this._filters.allFilters||(this._filters.allFilters={}),this._filters.allFilters[c.filters.searchName]=c):"generic"===this.searchSource.type&&(this._params=this.Y.mix(this._params||{},c.data,!0))}});f.prototype={_invoke:function(c,e,a,b){for(var f=0;f<this.sources.length;f++)this.sources[f][c](e,a,b);return this},on:function(c,e,a){return this._invoke("on",c,e,a)},fire:function(c,e,a){return this._invoke("fire",c,e,a)}};return{multipleSourcesWrapper:f,get:function(c){return"undefined"===typeof c?h:h[c]},add:function(c,e){if(c&&e instanceof k&&!h[c])return h[c]=e},getSearchSources:function(c,e){var a=c?(c+"").split(","):[],b=e?(e+"").split(","):[],f=[],d;for(d=0;d<a.length;d++)f.push({type:"report",id:a[d]});for(d=0;d<b.length;d++)f.push({type:"generic",id:b[d]});return{report:a,source:b,keys:f}},searchSource:k,findNamedSource:function(c,e){if(e){this.findNamedSource.findSource||(this.findNamedSource.findSource=function(a,b){if(b.multiple)for(var c=0;c<b.sources.length;c++){if(b.sources[c].instanceID===a)return b.sources[c]}else if(b.instanceID===a)return b});this.findNamedSource.warning||(this.findNamedSource.warning=function(a){RightNow.UI.DevelopmentHeader&&RightNow.UI.DevelopmentHeader.addJavascriptWarning(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_D_SRCH_SRC_ID_RPT_ID_SRC_ID_LBL"),a))});var a=[],b=[];if("string"===typeof e||"number"===typeof e){e=(e+"").split(",");if(1<e.length){for(var g=0,d;g<e.length;g++)(d=this.findNamedSource.findSource(e[g],c))?a.push(d):b.push(e[g]);b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}else if(a=this.findNamedSource.findSource(e[0],c))return a;!b.length&&this.findNamedSource.warning(e[0]);return c}if("object"===typeof e){for(g in e)e.hasOwnProperty(g)&&((d=this.findNamedSource.findSource(g,c))?(d=YUI().mix(d,e[g]),a.push(d)):b.push(g));b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}}if(!c)throw Error("The widget extending from RightNow.SearchFilter doesn't have report_id or source_id attributes.");return c}}}();RightNow.SearchFilter=RightNow.Widgets.extend({constructor:function(){for(var f=l.getSearchSources(this.data.attrs.report_id,this.data.attrs.source_id),h=[],k=0,c,e;k<f.keys.length;k++)e=f.keys[k],c=l.get(e.type+e.id),c||(c=new l.searchSource(this.Y,e),l.add(e.type+e.id,c)),h.push(c);1<h.length&&(c=new l.multipleSourcesWrapper(h));this.searchSource=function(a){return l.findNamedSource(c,a)}}});RightNow.ResultsDisplay=RightNow.SearchFilter})();
RightNow.Widgets.AdvancedSearchDialog=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this.Y.one(this.baseSelector+"_TriggerLink").on("click",this._openDialog,this);}},_openDialog:function(evt){if(!this._dialog){var dialogDiv=this.Y.one(this.baseSelector+"_DialogContent");if(dialogDiv){var buttons=[{text:this.data.attrs.label_search_button,handler:{fn:this._performSearch,scope:this}},{text:this.data.attrs.label_cancel_button,handler:{fn:this._cancelFilters,scope:this}}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,dialogDiv,{buttons:buttons});this.Y.one("#"+this._dialog.get('id')).addClass("rn_AdvancedSearchDialog");RightNow.UI.show(dialogDiv);this._dialog.hideEvent.subscribe(function(){if(evt.target.focus){evt.target.focus();}},null,this);}}
this._dialogClosed=false;this._dialog.show();this._dialog.hideEvent.subscribe(this._cancelFilters,null,this);},_performSearch:function(){this._closeDialog();var searchPage=this.data.attrs.report_page_url;this.searchSource().fire("search",new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,reportPage:searchPage,newPage:top!==self||(searchPage!==""&&searchPage!=="{current_page}")||!RightNow.Url.isSameUrl(searchPage)}}));},_cancelFilters:function(){if(this._dialogClosed)return;this._closeDialog();this.searchSource().fire("reset",new RightNow.Event.EventObject(this,{data:{name:"all"},filters:{report_id:this.data.attrs.report_id}}));},_closeDialog:function(){this._dialogClosed=true;if(this._dialog)
this._dialog.hide();}});
RightNow.Widgets.KeywordText=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._textElement=this.Y.one(this.baseSelector+"_Text");this.data.js.initialValue=this._decoder(this.data.js.initialValue);if(this._textElement){this._searchedOn=this._textElement.get("value");if(this._searchedOn!==this.data.js.initialValue)
this._textElement.set("value",this.data.js.initialValue);this._setFilter();this._textElement.on("change",this._onChange,this);this.searchSource().on("keywordChanged",this._onChangedResponse,this).on("search",this._onGetFiltersRequest,this).on("reset",this._onResetRequest,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);if(this.data.attrs.initial_focus)
this._textElement.focus();}}},_onChange:function(evt){this._eo.data=this._textElement.get("value");this._eo.filters.data=this._textElement.get("value");this.searchSource().fire("keywordChanged",this._eo);},_onGetFiltersRequest:function(type,args){this._eo.filters.data=this.Y.Lang.trim(this._textElement.get("value"));this._searchedOn=this._eo.filters.data;return this._eo;},_setFilter:function(){this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,data:this.data.js.initialValue,rnSearchType:this.data.js.rnSearchType,report_id:this.data.attrs.report_id}});},_onChangedResponse:function(type,args){var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName),newValue=(data===null)?this.data.js.initialValue:data;newValue=this._decoder(newValue);if(this._textElement.get("value")!==newValue)
this._textElement.set("value",newValue);},_onResetRequest:function(type,args){if(!args[0]||args[0].data.name===this.data.js.searchName){this._textElement.set('value',this.data.js.initialValue);}
else if(args[0].data.name==='all'){this._textElement.set('value',this._searchedOn);}},_decoder:function(value){if(value)
return value.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&#039;/g,"'").replace(/&quot;/g,'"');return value;}});
RightNow.Widgets.SearchButton=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._requestInProgress=false;this._searchButton=this.Y.one(this.baseSelector+"_SubmitButton");if(this._searchButton){this._enableClickListener();this.searchSource().on("response",this._enableClickListener,this);}}},_startSearch:function(evt){if(this._requestInProgress)return;if(!this.data.attrs.popup_window&&(!this.data.attrs.report_page_url&&(this.data.attrs.target==='_self')))
this._disableClickListener();if(this.Y.UA.ie){this._parentForm=this._parentForm||this.Y.one(this.baseSelector).ancestor("form");if(this._parentForm&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(this.Y.Node.getDOMNode(this._parentForm));}}
var searchPage=this.data.attrs.report_page_url;this.searchSource().fire("search",new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,source_id:this.data.attrs.source_id,reportPage:searchPage,newPage:top!==self||(searchPage!==""&&searchPage!=="{current_page}"&&!RightNow.Url.isSameUrl(searchPage)),target:this.data.attrs.target,popupWindow:this.data.attrs.popup_window,width:this.data.attrs.popup_window_width_percent,height:this.data.attrs.popup_window_height_percent}}));},_enableClickListener:function(){this._requestInProgress=false;this._searchButton.on("click",this._startSearch,this);},_disableClickListener:function(){this._requestInProgress=true;this._searchButton.detach("click",this._startSearch);}});
RightNow.Widgets.GuidedAssistant=RightNow.Widgets.extend({constructor:function(){if(this.data.attrs.popup_window_url)return;this._currentLevel=1;this._guide=[];this._map=RightNow.Url.convertToArray(RightNow.Url.getParameterSegment());this._currentGuideID=this.data.js.guidedAssistant.guideID;this._originalGuideID=this._currentGuideID;this._guide[this._currentGuideID]=this.data.js.guidedAssistant;this._currentQuestion=this._guide[this._currentGuideID].questions[0].questionID;this._previousQuestions=[];this._eo=new RightNow.Event.EventObject(this,{data:{guideID:this._currentGuideID}});delete this.data.js.guidedAssistant;this._hasRecordedInitialInteraction=false;this.env=this._getEnvironment();var RightNowEvent=RightNow.Event;RightNowEvent.subscribe("evt_GuidedAssistanceGoToResponse",this._goToResponse,this);RightNowEvent.subscribe("evt_GuidedAssistanceGoToQuestion",this._goToQuestion,this);RightNowEvent.subscribe("evt_GuidedAssistanceAnswerViewed",this._answerViewed,this);this._liveNotificationArea=this.Y.Node.create("<div class='rn_ScreenReaderOnly' role='alert'></div>");new this.Y.Node(document.body).insert(this._liveNotificationArea,0);this._attachDomEvents();this._initHistoryManager();RightNowEvent.fire("evt_GuideLoaded",this._eo);},_attachDomEvents:function(){this.Y.Event.attach("click",this._goBackHelper,this.baseSelector+"_BackButton",this);var widget=this.Y.one(this.baseSelector);widget.delegate("click",this._onClick,"input, button, a",this);widget.delegate("change",this._onSelectChange,"select",this);widget.delegate("keydown",function(e){if((e.keyCode===RightNow.UI.KeyMap.TAB&&this._changeFired)||e.keyCode===RightNow.UI.KeyMap.ENTER){this._onClick(e);}},"select",this);widget.delegate("mousedown",function(e){this._mouseTriggered=true;},"select",this);if(this.Y.UA.ie&&this.Y.UA.ie<9){RightNow.Event.on('evt_GuideQuestionRendered',function(evt,args){args=args[0];var question=args.data.question;if(args.w_id===this.instanceID&&(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION)){this.Y.one(this.baseSelector+'_Response'+args.data.guideID+'_'+question.questionID).one('select').on('change',this._onSelectChange,this);}},this);var initialSelect=this.Y.one(this.baseSelector+' select');if(initialSelect){initialSelect.on('change',this._onSelectChange,this);}}},_onSelectChange:function(e){this._changeFired=true;if(this._mouseTriggered||this.Y.UA.ie&&e.target.get("size")==="0"){this._mouseTriggered=false;this._onClick(e);}},_onClick:function(evt){var target=evt.target,tagName=target.get('tagName').toLowerCase(),id=target.get('id');if(((tagName==='a'||tagName==='button')&&typeof target.get('onclick')==='function')||(tagName==='input'&&target.get('type')==='text')||id.indexOf('BackButton')>0||id.indexOf('RestartButton')>0){return;}
var questionID=parseInt(target.getAttribute("data-question"),10),responseID=parseInt(target.getAttribute("data-response"),10),guideID=parseInt(target.getAttribute("data-guide"),10),answerID=parseInt(target.getAttribute("data-answer"),10),level=parseInt(target.getAttribute("data-level"),10);if(tagName==='a'){this._linkClicked(evt,{guideID:guideID,questionID:questionID,responseID:responseID,answerID:answerID});return;}
this.answerQuestion(target,guideID,questionID,responseID,level);},answerQuestion:function(element,guideID,questionID,responseID,level,skipped){if(guideID!==this._currentGuideID){if(!this._guide[guideID])
throw new Error("Missing guide");else
this._currentGuideID=guideID;}
if(!this._hasRecordedInitialInteraction){RightNow.ActionCapture.record('guidedAssistance','interact',this._currentGuideID);this._hasRecordedInitialInteraction=true;}
this._setAriaLoading(true);var question=this._getQuestionByID(questionID),response=this._getResponseByID(question,responseID);if(question){this._currentLevel=level+1;this._previousQuestions[level]=questionID;this._removeElements(questionID);this._removePairs(questionID);if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION){if(element.get("options").item(element.get("selectedIndex")).get("value")){responseID=parseInt(element.get("options").item(element.get("selectedIndex")).get("value"),10);response=this._getResponseByID(question,responseID);}
else{this._previousQuestions.pop();this._currentLevel--;this._setAriaLoading(false);return;}}
else if(question.type===this.data.js.types.TEXT_QUESTION){var input=this.Y.one(this.baseSelector+"_Response"+guideID+"_"+questionID+"_"+responseID);if(input){input.set("value",this.Y.Lang.trim(input.get("value")));if(input.get("value")===""){input.focus();this._setAriaLoading(false);this._currentLevel--;this._previousQuestions.pop();return;}
response.value=input.get("value");}
else{this._setAriaLoading(false);return;}}
this._addPairs(question,response.value,level);this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[guideID].guideSessionID,ga_id:guideID,q_id:questionID,r_id:responseID,skipped:skipped},true);this._eo.data={guideID:guideID,questionID:questionID,responseID:responseID,responseValue:response.value};RightNow.Event.fire("evt_GuideResponseSelected",this._eo);if(this.data.attrs.single_question_display){if(question.type===this.data.js.types.RADIO_QUESTION||question.type===this.data.js.types.IMAGE_QUESTION)
element.set("checked",false);else if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION)
element.set("selectedIndex",0);else if(question.type===this.data.js.types.TEXT_QUESTION)
element.set("value","");if(this._guideAppended){this._hideFirstGuideQuestion(questionID);this._guideAppended=false;}
else{this._toggleQuestion(question);}
this._toggleBackButton(true);}
else{if(question.type===this.data.js.types.LINK_QUESTION||question.type===this.data.js.types.BUTTON_QUESTION){this._highlightResponse(element,question.type);}
else if(element&&element.get("type")==="radio"&&element.get("checked")===false){element.set("checked",true);}}
this._buildNextResult(response);this._changeFired=false;this._setAriaLoading(false);}},_goToResponse:function(evt,args){var levelOfQuestion=this._goToQuestion(evt,args);if(typeof levelOfQuestion==='undefined'){return;}
var data=args[0].data,guideID=data.guideID,questionID=data.questionID,responseID=data.responseID,goToResponse=function(level){var question=this._getQuestionByID(questionID);if(question&&question.responses){for(var i=0,response;i<question.responses.length;i++){response=question.responses[i];if(response.responseID===responseID&&!(this._restoringState&&response.url)){this._answerQuestion(guideID,question,response,level);}}}};if(levelOfQuestion.guideID){var levelUpToSubGuide=this._goToResponse(this.instanceID,[{data:levelOfQuestion}]),restoringState=this._restoringState;this._guideLoadedCallback=function(idOfLoadedGuide){if(guideID===idOfLoadedGuide){this._guideLoadedCallback=null;this._currentGuideID=guideID;this._restoringState=restoringState;levelOfQuestion=this._goToQuestion(this.instanceID,[{data:{guideID:guideID,questionID:questionID,level:levelUpToSubGuide}}]);goToResponse.call(this,levelOfQuestion+levelUpToSubGuide);this._restoringState=false;}};}
else{goToResponse.call(this,levelOfQuestion);return levelOfQuestion;}},_goToQuestion:function(evt,args){var data=args[0].data,guideID=data.guideID,questionID=data.questionID,startingLevel=(data.level||0)+1,i,response,j;if(this._guide[guideID]&&this._guide[guideID].questions[0]&&(guideID===this._currentGuideID||!this._guide[guideID].parentGuide)){this._currentGuideID=guideID;var nodeList=this._getPathToQuestion([this._guide[guideID].questions[0]],questionID);if(nodeList&&nodeList.length){if(nodeList.length===1){this._removeElements(nodeList[0].questionID);if(this.data.attrs.single_question_display){this._toggleQuestion(nodeList[0],true);this._toggleBackButton(false);}}
else{for(i=0;i<=nodeList.length-2;i++){for(j in nodeList[i].responses){if(nodeList[i].responses.hasOwnProperty(j)){response=nodeList[i].responses[j];if(response.childQuestionID===nodeList[i+1].questionID){this._answerQuestion(guideID,nodeList[i],response,i+startingLevel);}}}}}
return nodeList.length;}}
else{var parentGuide;for(i in this._guide){if(this._guide.hasOwnProperty(i)){response=this._getGuideParentResponse(this._guide[i].questions,guideID);if(response){return{guideID:this._guide[i].guideID,questionID:response.questionID,responseID:response.responseID};}}}}},_answerQuestion:function(guideID,question,response,level){var element;if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION){var parent=this.Y.one(this.baseSelector+"_Response"+guideID+"_"+question.questionID);element=(parent)?parent.one('select'):null;if(element){element.get("options").some(function(option,i){if(option.get("value")===(response.responseID+"")){element.set("selectedIndex",i);return true;}});}}
else{this.Y.one(this.baseSelector+"_Response"+guideID+"_"+response.parentQuestionID).all("input, button").some(function(node){if(node.getAttribute("data-response")===(response.responseID+"")){element=node;return true;}});if(element&&question.type===this.data.js.types.TEXT_QUESTION){element.set("value",RightNow.Interface.getMessage("RESPONSE_PLACEHOLDER_LBL"));}}
this.answerQuestion(element,guideID,response.parentQuestionID,response.responseID,level,true);},_buildNextResult:function(response){var result=this.Y.Node.create("<div class='rn_Result rn_Node'></div>"),deadEnd=true,question;if(!response||!response.type){result.set("innerHTML","<div class='rn_ResultText'>"+RightNow.Interface.getMessage("NO_ANSWERS_FOUND_MSG")+"</div>");}
else{this._currentResponse=response.responseID;this._saveState({guideID:this._currentGuideID,questionID:response.parentQuestionID,responseID:response.responseID,guideSession:this._guide[this._currentGuideID].guideSessionID,sessionID:this.data.js.session});if(response.url){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);RightNow.ActionCapture.flush();if(response.urlType===this.data.js.types.URL_GET&&this.env.samePage()&&this.data.attrs.call_url_new_window){RightNow.Ajax.CT.commitActions();this._callUrl(response);}
else{RightNow.Ajax.CT.commitActions(function(){this._callUrl(response);},this);}
if(this.env.preview){this._callUrl(response);}
if(!this.env.console||this.env.previewEnduser){return;}}
if(response.type&this.data.js.types.TEXT_RESPONSE){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);result.append(this._createTextResultHTML(response)+
this._createResolutionChatLink(this._currentGuideID,response.parentQuestionID,response.responseID)).addClass("rn_Text").set("id",this.baseDomID+"_Result"+this._currentGuideID+"_"+response.responseID);}
if(response.type&this.data.js.types.ANSWER_RESPONSE&&(!this.env.console||this.env.previewEnduser)){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);result.append(this._createAnswersHTML(response)).addClass("rn_Answers").set("id",this.baseDomID+"_Result"+this._currentGuideID+"_"+response.responseID);}
if(response.type&this.data.js.types.QUESTION_RESPONSE){question=this._getQuestionByID(response.childQuestionID);result.append(this._buildQuestionHTML(question)+
this._createQuestionChatLink(this._currentGuideID,response.childQuestionID)).addClass("rn_Question").set("id",this.baseDomID+"_Question"+this._currentGuideID+"_"+response.childQuestionID);this._currentQuestion=response.childQuestionID;this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion},true);deadEnd=false;}
if(response.type&this.data.js.types.GUIDE_RESPONSE&&response.childGuideID){if(result.get("innerHTML")){this._appendElement(result.removeClass("rn_Node"));}
RightNow.Ajax.CT.commitActions();this._getGuideByID(response.childGuideID,response.responseID,this._currentQuestion);return;}}
RightNow.Ajax.CT.commitActions();this._appendElement(result);RightNow.Url.transformLinks(result);if(this.data.attrs.single_question_display&&deadEnd&&this._currentLevel>2){this._displayRestartButton();}
if(question){RightNow.Event.fire('evt_GuideQuestionRendered',new RightNow.Event.EventObject(this,{data:{question:question,guideID:this._currentGuideID}}));}
this._newContentAdded();},_buildQuestionHTML:function(question){var types=this.data.js.types,newQuestion,result,resultClass;switch(question.type){case types.BUTTON_QUESTION:result=this._createButtonHTML(question);resultClass="rn_ButtonQuestion";break;case types.MENU_QUESTION:case types.LIST_QUESTION:result=this._createMenuHTML(question);resultClass=(question.type===types.LIST_QUESTION)?"rn_ListQuestion":"rn_MenuQuestion";break;case types.LINK_QUESTION:result=this._createLinkHTML(question);resultClass="rn_LinkQuestion";break;case types.RADIO_QUESTION:result=this._createRadioHTML(question);resultClass="rn_RadioQuestion";break;case types.IMAGE_QUESTION:result=this._createImageHTML(question);resultClass="rn_ImageQuestion";break;case types.TEXT_QUESTION:result=this._createTextInputHTML(question);resultClass="rn_TextQuestion";break;}
return new EJS({text:this.getStatic().templates.question}).render({responseContent:result,responseClass:resultClass,questionText:question.text,responseID:this.baseDomID+"_Response"+this._currentGuideID+"_"+question.questionID})+
((this.env.console&&!this.env.previewEnduser&&question.agentText)?"<pre class='rn_AgentText'><em>"+RightNow.Interface.getMessage("AGT_TEXT_LBL")+"</em>"+question.agentText+"</pre>":"");},_createButtonHTML:function(question){return new EJS({text:this.getStatic().templates.buttonResponse}).render({guideID:this._currentGuideID,questionID:question.questionID,responses:question.responses,level:this._currentLevel});},_createMenuHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.menuResponse}).render({guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,size:(question.type===this.data.js.types.LIST_QUESTION)?(question.responses.length+1):0,level:this._currentLevel});},_createLinkHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.linkResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,className:(this.env.mobile)?"rn_TransparentScreenReaderOnly":"rn_ScreenReaderOnly",level:this._currentLevel});},_createRadioHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.radioResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,level:this._currentLevel});},_createImageHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.imageResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,level:this._currentLevel});},_createTextInputHTML:function(question){var response=question.responses[0],questionID=question.questionID;return new EJS({text:this.getStatic().templates.textResponse}).render({id:this._buildResponseID(questionID,response.responseID),guideID:this._currentGuideID,questionID:questionID,responseID:response.responseID,responseText:response.text,label:this.data.attrs.label_text_response_button,level:this._currentLevel,requiredLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),screenReaderLabel:RightNow.Interface.getMessage("REQUIRED_LBL")});},_callUrl:function(response){this._map.session=this.data.js.session;if(response.urlType===this.data.js.types.URL_GET){this._navigate(response.url,this._map);}
else if(response.urlType===this.data.js.types.URL_POST){this._post(response.url,this._map);}},_navigate:function(url,paramMap,win){win||(win=window);var params="",separator=(url.indexOf("?")>-1)?"&":"?";this.Y.Object.each(paramMap,function(pair,key){params+=(separator+encodeURIComponent(key)+"="+encodeURIComponent(pair.value||pair));if(separator==="?")
separator="&";});url+=params;if(!this.env.samePage()){win.self.opener.location=url;win.close();}
else if((this.env.console&&!this.env.previewEnduser)||this.data.attrs.call_url_new_window){win.open(url);}
else{win.location=url;}},_post:function(url,paramMap,win){win||(win=window);var form=this.Y.Node.create("<form class='rn_Hidden' method='post'></form>").set("action",url);if(this.env.console&&!this.env.previewEnduser){form.set("target","_blank");}
this.Y.Object.each(paramMap,function(pair,name){form.append(this.Y.Node.create("<input type='text'>").set("name",name).set("value",pair.value||pair));},this);if(!this.env.samePage()&&!this.Y.UA.ie&&!this.env.mobile){form=this.Y.Node.getDOMNode(form);form=win.self.opener.document.body.appendChild(form);win.close();}
else{this._appendElement(form,this._currentGuideID);}
form.submit();},_createTextResultHTML:function(response){return new EJS({text:this.getStatic().templates.textResult}).render({heading:this.data.attrs.label_text_result,resultText:response.responseText||""});},_createAnswersHTML:function(response){var answers="";if(response.childAnswers){answers=new EJS({text:this.getStatic().templates.answerResult}).render({answers:response.childAnswers,guideID:this._currentGuideID,questionID:this._currentQuestion,responseID:response.responseID,target:this.data.attrs.target||((this.env.samePage()||this.env.mobile)?"_blank":"")||"_blank",heading:this.data.attrs.label_answer_result});}
return answers;},_createNewGuide:function(guide,parentGuideID){var question=guide.questions[0],questionID=question.questionID,result=this.Y.Node.create("<div class='rn_Guide rn_Result'></div>").set("id",this.baseDomID+"_Guide"+this._currentGuideID).append(this.Y.Node.create("<div class='rn_Question rn_Node'></div>").set("id",this.baseDomID+"_Question"+guide.guideID+"_"+questionID).append(this._buildQuestionHTML(question)+
this._createQuestionChatLink(this._currentGuideID,questionID)));this._currentQuestion=questionID;this._appendElement(result,parentGuideID);RightNow.Url.transformLinks(result);if(this.data.attrs.single_question_display){this._guideAppended=true;}
RightNow.Event.fire('evt_GuideQuestionRendered',new RightNow.Event.EventObject(this,{data:{question:question,guideID:this._currentGuideID}}));},_createQuestionChatLink:function(guideID,questionID){return(this.data.js.isChatAgent)?"<a class='rn_ChatLink' href='javascript:void(0);' data-guide='"+guideID+"' data-question='"+questionID+"'>"+
RightNow.Interface.getMessage("ADD_TO_CHAT_CMD")+"</a>":"";},_createResolutionChatLink:function(guideID,questionID,responseID){return(this.data.js.isChatAgent)?"<a class='rn_ChatLink' href='javascript:void(0);' data-guide='"+guideID+"' data-question='"+questionID+"' data-response='"+responseID+"'>"+
RightNow.Interface.getMessage("ADD_TO_CHAT_CMD")+"</a>":"";},_displayRestartButton:function(){if(this._restartButton){RightNow.UI.show(this._restartButton);}
else{this._restartButton=this.Y.Node.create("<button class='rn_RestartButton'></button>").set("id",this.baseDomID+"_RestartButton").set("innerHTML",this.data.attrs.label_start_over);this._restartButton.on("click",function(){this._setAriaLoading(true);while(this._currentLevel!==1){this._goBack();}
this._setAriaLoading(false);this._focusTopOfGuide();},this);this.Y.one(this.baseSelector+"_BackButton").insert(this._restartButton,'after');}},_removeElements:function(questionID){var question=this._get("Question",questionID),next=(question)?question.next():null;while(next){next.remove();next=question.next();}},_appendElement:function(element,parentGuideID){var guide=this.Y.one(this.baseSelector+"_Guide"+(parentGuideID||this._currentGuideID));if(guide){guide.appendChild(element).scrollIntoView();window.scrollTo(this.Y.DOM.docScrollX()-20,this.Y.DOM.docScrollY());}},_newContentAdded:function(){if(this.data.attrs.single_question_display){this._focusTopOfGuide();}
else if(this._liveNotificationArea){this._liveNotificationArea.set("innerHTML",RightNow.Interface.getMessage("NEW_CONTENT_ADDED_BELOW_MSG"));}},_focusTopOfGuide:function(){var anchor=this.Y.one(this.baseSelector+"_SamePageAnchor");if(anchor){anchor.setAttribute("tabindex",-1);try{anchor.focus();}
catch(ex){}}
RightNow.UI.updateVirtualBuffer();this._liveNotificationArea.set("innerHTML",RightNow.Interface.getMessage("TOP_CONTENT_CONTENT_ADDED_MSG"));this._setAriaLoading(false);},_getEnvironment:function(){return{mobile:this.data.js.mobile,console:(typeof this.data.js.agentMode!=="undefined"),agent:(this.data.js.agentMode==="agent"),preview:(this.data.js.agentMode&&this.data.js.agentMode.toLowerCase().indexOf("preview")>-1),previewEnduser:(this.data.js.agentMode&&this.data.js.agentMode==="enduserPreview"),samePage:function(){if(this._samePageCachedResult){return this._samePageCachedResult;}
try{this._samePageCachedResult=!window.opener||window.opener===window.self||(window.opener.RightNow&&window.opener.RightNow.Chat);}
catch(e){}
return this._samePageCachedResult;}};},_goBackHelper:function(){this._setAriaLoading(true);this._goBack();this._focusTopOfGuide();this._setAriaLoading(false);},_goBack:function(){this._currentLevel--;var prevQuestionID=this._previousQuestions[this._currentLevel],prevSibling;if(this._toggleQuestion(prevQuestionID,true)){this._removeElements(prevQuestionID);if(prevQuestionID===1&&this._guide[this._currentGuideID].parentGuide){prevSibling=this._get("Guide").previous();if(prevSibling&&prevSibling.get("id").indexOf("Result")>-1){RightNow.UI.show(prevSibling);}}}
else{this._currentGuideID=this._guide[this._currentGuideID].parentGuide;this._toggleQuestion(prevQuestionID,true);this._removeElements(prevQuestionID);}
RightNow.UI.hide(this._restartButton);if(this._currentLevel===1){this._toggleBackButton();}},_addPairs:function(question,responseValue,level){for(var name in question.nameValuePairs){if(question.nameValuePairs.hasOwnProperty(name)){this._map[name]={value:question.nameValuePairs[name],level:level};}}
if(question.name){if(typeof responseValue!=="undefined"){this._map[question.name]={value:responseValue,level:level};}
else if(this._map[question.name]&&this._map[question.name].level===level){delete this._map[question.name];}}},_removePairs:function(){for(var i in this._map){if(this._map.hasOwnProperty(i)&&this._map[i].level>=this._currentLevel){delete this._map[i];}}},_getQuestionByID:function(domNodeID){if(this._guide&&this._guide[this._currentGuideID]&&this._guide[this._currentGuideID].questions){var questions=this._guide[this._currentGuideID].questions;for(var question in questions){if(questions[question].questionID===domNodeID)
return questions[question];}}},_getResponseByID:function(question,responseID){if(question&&question.responses){for(var response in question.responses){if(question.responses[response].responseID===responseID)
return question.responses[response];}}},_getPathToQuestion:function(nodes,questionID){var node,i,found,child;if(nodes.length){node=nodes.shift();if(node.questionID===questionID)return[node];for(i in node.responses){if(node.responses.hasOwnProperty(i)&&node.responses[i].childQuestionID){child=this._getQuestionByID(node.responses[i].childQuestionID);child.parent=node.questionID;nodes.push(child);}}
found=this._getPathToQuestion(nodes,questionID);if(found){return(found[0].parent===node.questionID)?[node].concat(found):found;}}},_getGuideParentResponse:function(questions,guideID){var i,quesLen,j,respLen;for(i=0,quesLen=questions.length;i<quesLen;i++){for(j=0,respLen=questions[i].responses.length;j<respLen;j++){if(questions[i].responses[j].childGuideID===guideID){return{responseID:questions[i].responses[j].responseID,questionID:questions[i].questionID};}}}},_get:function(type,id){var suffix=id?("_"+id):"";return this.Y.one(this.baseSelector+"_"+type+this._currentGuideID+suffix);},_submitStats:function(action,details,queue,callback,scope){if(!this.env.preview&&!this._restoringState&&!this.data.js.isSpider){if(queue){RightNow.Ajax.CT.addAction(action,details);}
else{RightNow.Ajax.CT.submitAction(action,details,callback,scope);}}},_answerViewed:function(evt,args){var data=args[0].data;this._recordAnswerViewed(data.guideID,data.questionID,data.responseID,data.answerID);},_linkClicked:function(evt,ids){var link=evt.target,callback;if(link.hasClass("rn_ChatLink")){if(ids.responseID){this._addResolutionToChat(ids.guideID,ids.questionID,ids.responseID);}
else{this._addQuestionToChat(ids.guideID,ids.questionID);}}
else{if(!link.getAttribute("target")||link.getAttribute("target")==="_self"){evt.halt();callback=function(){RightNow.Url.navigate(link.get("href"));};}
else if(!this.env.samePage()){try{window.self.opener.location=link.get("href");window.self.opener.focus();evt.halt();}
catch(e){}}
this._recordAnswerViewed(ids.guideID,ids.questionID,ids.responseID,ids.answerID,callback);}},_addQuestionToChat:function(guideID,questionID){this._eo.data={guideID:guideID,questionID:questionID};RightNow.Event.fire("evt_GuideAddQuestionToChat",this._eo);},_addResolutionToChat:function(guideID,questionID,responseID){this._eo.data={guideID:guideID,questionID:questionID,responseID:responseID};RightNow.Event.fire("evt_GuideAddResolutionToChat",this._eo);},_recordAnswerViewed:function(guideID,questionID,responseID,answerID,callback){RightNow.ActionCapture.record('guidedAssistanceAnswer','view',guideID);if(callback){RightNow.ActionCapture.flush();}
this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[guideID].guideSessionID,ga_id:guideID,q_id:questionID,r_id:responseID,a_id:answerID},false,callback);},_buildResponseID:function(questionID,responseID){return this.baseDomID+'_Response'+this._currentGuideID+'_'+questionID+'_'+(responseID||'');},_highlightResponse:function(chosenResponse,questionType){var cssClass="rn_HighlightResponse";if(questionType===this.data.js.types.LINK_QUESTION){chosenResponse.get("parentNode").get("parentNode").all("label").removeClass(cssClass);chosenResponse.get("parentNode").all("label").addClass(cssClass);}
else{cssClass+=(this.env.console)?"":" rn_SelectedButton";chosenResponse.get("parentNode").all("button").removeClass(cssClass);chosenResponse.addClass(cssClass);}},_toggleBackButton:function(show){this.Y.one(this.baseSelector+"_BackButton")[((show)?"removeClass":"addClass")]("rn_Hidden");},_toggleQuestion:function(question,show){if(!question)return false;if(typeof question==="number"){var previousQuestion=this._guide[this._currentGuideID].questions[question-1],numberOfPreviousResponses=previousQuestion?previousQuestion.responses.length:0;if(numberOfPreviousResponses>0&&previousQuestion.type===this.data.js.types.TEXT_QUESTION){for(var i=0,input;i<numberOfPreviousResponses;i++){input=this.Y.one(this.baseSelector+"_Response"+this._originalGuideID+"_"+question+"_"+previousQuestion.responses[i].responseID);if(input){input.set("value","");}}}}
var element=this._get("Question",((typeof question==="number")?question:question.questionID)),elementIsHidden;if(element){elementIsHidden=element.hasClass('rn_Hidden');if((show&&!elementIsHidden)||(!show&&elementIsHidden))return false;element[((show)?"removeClass":"addClass")]("rn_Hidden");return true;}
return false;},_hideFirstGuideQuestion:function(questionID){this._get("Question",questionID).addClass("rn_Hidden");this._get("Guide").previous('*').addClass("rn_Hidden");},_setAriaLoading:function(loadingOrNot){this._outerGuideDiv=this._outerGuideDiv||this.Y.one(this.baseSelector);this._outerGuideDiv.setAttribute("aria-busy",((loadingOrNot)?"true":"false"));},_getGuideByID:function(guideID,responseID,questionID){if(this._guide[guideID]){var parentGuideID=this._currentGuideID;this._currentGuideID=guideID;this._createNewGuide(this._guide[guideID],parentGuideID);this._currentGuideID=parentGuideID;}
else if(!this._retrievingNewGuide){this._retrievingNewGuide=true;if(this._restoringState){this._restoringNewGuideState=true;}
var eo=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,guideID:guideID,responseID:responseID,questionID:questionID,langID:this.data.js.langID}});if(RightNow.Event.fire("evt_GuidedAssistanceRequest",eo)){RightNow.Ajax.makeRequest(this.data.attrs.guide_request_ajax,eo.data,{successHandler:this._getGuideResponse,scope:this,json:true,data:eo});}}},_getGuideResponse:function(response,origEventObject){if(RightNow.Event.fire("evt_GuidedAssistanceResponse",{response:response,data:origEventObject})){var newGuide=response,prevGuideID=this._currentGuideID;newGuide.parentGuide=prevGuideID;this._currentGuideID=newGuide.guideID;this._guide[this._currentGuideID]=newGuide;if(!this._restoringNewGuideState){this._submitStats(RightNow.Ajax.CT.GA_SESSIONS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,sid:this.data.js.session,acct_id:parseInt(this.data.js.accountID,10),channel:this.data.js.channel},true);}
this._createNewGuide(newGuide,prevGuideID);if(!this._restoringNewGuideState){this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion});}
else{this._restoringNewGuideState=false;}
this._retrievingNewGuide=false;if(this._guideLoadedCallback){this._guideLoadedCallback.call(this,this._currentGuideID);}
this._newContentAdded();}},_initHistoryManager:function(){if(this._history)return;var recordGuideSessionStart=function(){this._submitStats(RightNow.Ajax.CT.GA_SESSIONS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,sid:this.data.js.session,acct_id:parseInt(this.data.js.accountID,10),channel:this.data.js.channel},true);this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion});RightNow.ActionCapture.record('guidedAssistance','load',this._currentGuideID);};if(top===self&&!this.env.console){this._stateKey="gs";this._history=new this.Y.History();this._history.on("change",function(e){var src=e.src,currentState;if(src!==this.Y.HistoryHash.SRC_HASH&&src!==this.Y.HistoryHTML5.SRC_POPSTATE){return;}
currentState=e.newVal[this._stateKey]||"";if(!this._restoreState(currentState)){recordGuideSessionStart.call(this);}},this,true);var initialState;if(this.Y.HistoryBase.html5){initialState=window.location.toString().match(new RegExp("(#"+this._stateKey+"=)([A-Za-z0-9_/.]+)"));if(initialState&&initialState[2]){initialState=initialState[2];}
else{initialState=null;}}
else{initialState=this._history.get(this._stateKey);}
if(initialState&&this._restoreState(initialState)){return;}}
recordGuideSessionStart.call(this);},_restoreState:function(state){if(state){try{state=RightNow.JSON.parse(RightNow.Text.Encoding.base64Decode(state));if(state.sessionID!==this.data.js.session){return false;}
if((this._currentGuideID!==state.guideID||this._currentResponse!==state.responseID||this._previousQuestions[this._currentLevel-1]!==state.questionID)){this._restoringState=true;this._guide[this._currentGuideID].guideSessionID=state.guideSession;this._goToResponse(this.instanceID,[{data:{guideID:state.guideID,questionID:state.questionID,responseID:state.responseID}}]);this._restoringState=false;}}
catch(e){}}
else if(this._currentLevel>1){this._currentResponse=null;this._goToQuestion(this.instanceID,[{data:{guideID:this._originalGuideID,questionID:this._guide[this._originalGuideID].questions[0].questionID}}]);}
return true;},_saveState:function(state){if(this._history&&!this._restoringState){var savedOffState=RightNow.Text.Encoding.base64Encode(RightNow.JSON.stringify(state)),hash="#"+this._stateKey+"="+savedOffState,saveThis={};saveThis[this._stateKey]=savedOffState;this._history.add(saveThis,{url:((window.location.hash)?window.location.toString().replace(window.location.hash,hash):window.location+hash)});}}});
RightNow.Widgets.AnswerFeedback=RightNow.Widgets.extend({constructor:function(){this._dialog=this._keyListener=null;this._rate=0;if(!this.Y.one(this.baseSelector+"_FeedbackTextarea")){RightNow.UI.DevelopmentHeader.addJavascriptError(RightNow.Text.sprintf(RightNow.Interface.getMessage("ANSWERFEEDBACK_DIALOG_MISSING_REQD_MSG"),this.baseDomID+"_FeedbackTextarea"));return;}
var Event=this.Y.Event;if(this.data.js.buttonView){var noButton=this.Y.one(this.baseSelector+"_RatingNoButton"),yesButton=this.Y.one(this.baseSelector+"_RatingYesButton");Event.attach("click",this._onClick,noButton,this,1);Event.attach("click",this._onClick,yesButton,this,2);}
else if(this.data.attrs.use_rank_labels){var ratingButton=this.baseSelector+"_RatingButton_";for(var i=1,ids=[];i<=this.data.attrs.options_count;++i){ids.push(ratingButton+i);}
this.Y.Array.each(ids,function(id,i){Event.attach("click",this._onClick,id,this,i+1);},this);}
else
{var ratingCell=this.baseSelector+"_RatingCell_";for(i=1,ids=[];i<=this.data.attrs.options_count;++i){ids.push(ratingCell+i);}
this.Y.Array.each(ids,function(id,i){var j=i+1;Event.attach("mouseover",this._onCellOver,id,this,j);Event.attach("focus",this._onCellOver,id,this,j);Event.attach("mouseout",this._onCellOut,id,this,j);Event.attach("blur",this._onCellOut,id,this,j);Event.attach("click",this._onClick,id,this,j);},this);}
RightNow.Event.subscribe("evt_formTokenUpdate",this._onFormTokenUpdate,this);},_onClick:function(event,rating)
{this._rate=rating;this._submitAnswerRating();if(this._rate<=this.data.attrs.dialog_threshold)
{if(this.data.attrs.feedback_page_url)
{var pageString=this.data.attrs.feedback_page_url;pageString=RightNow.Url.addParameter(pageString,"a_id",this.data.js.answerID);pageString=RightNow.Url.addParameter(pageString,"session",RightNow.Url.getSession());window.open(pageString,'',"resizable, scrollbars, width=630, height=400");}
else
{this._showDialog();}}},_showDialog:function()
{RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject(this,{data:{formToken:this.data.js.f_tok}}));if(!this._dialog)
{var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._onSubmit,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this},isDefault:false}],dialogForm=this.Y.one(this.baseSelector+"_AnswerFeedbackForm");this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,dialogForm,{"buttons":buttons,"dialogDescription":this.baseDomID+"_DialogDescription","width":this.data.attrs.dialog_width||''});this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._onSubmit,this);RightNow.UI.show(dialogForm);this.Y.one('#'+this._dialog.id).addClass('rn_AnswerFeedbackDialog');}
this._emailField=this._emailField||this.Y.one(this.baseSelector+"_EmailInput");this._errorDisplay=this._errorDisplay||this.Y.one(this.baseSelector+"_ErrorMessage");this._feedbackField=this._feedbackField||this.Y.one(this.baseSelector+"_FeedbackTextarea");if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
this._dialog.show();var focusElement;if(this._emailField&&this._emailField.get("value")==='')
focusElement=this._emailField;else
focusElement=this._feedbackField;focusElement.focus();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);},_onSubmit:function(type,args)
{var target=(args&&args[1])?(args[1].target||args[1].srcElement):null;if(type==="keyPressed"&&target){var tag=target.get('tagName'),innerHTML=target.get('innerHTML');if(tag==='A'||tag==='TEXTAREA'||innerHTML===this.data.attrs.label_send_button||innerHTML===this.data.attrs.label_cancel_button){return;}}
if(!this._validateDialogData()){return;}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._incidentCreateFlag=true;this._submitFeedback();},_onCancel:function()
{RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._closeDialog(true);},_validateDialogData:function()
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');var returnValue=true;if(this._emailField)
{this._emailField.set("value",this.Y.Lang.trim(this._emailField.get("value")));if(this._emailField.get("value")==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_email_address),this._emailField.get("id"));returnValue=false;}
else if(!RightNow.Text.isValidEmailAddress(this._emailField.get("value")))
{this._addErrorMessage(this.data.attrs.label_email_address+' '+RightNow.Interface.getMessage("FIELD_IS_NOT_A_VALID_EMAIL_ADDRESS_MSG"),this._emailField.get("id"));returnValue=false;}}
this._feedbackField.set("value",this.Y.Lang.trim(this._feedbackField.get("value")));if(this._feedbackField.get("value")==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_comment_box),this._feedbackField.get("id"));returnValue=false;}
return returnValue;},_closeDialog:function(cancelled)
{if(!cancelled)
{this._feedbackField.set("value","");}
if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
if(this._dialog)
this._dialog.hide();},_submitFeedback:function()
{var eventObject=new RightNow.Event.EventObject(this,{data:{a_id:this.data.js.answerID,rate:this._rate,threshold:this.data.attrs.dialog_threshold,options_count:this.data.attrs.options_count,message:this._feedbackField.get('value'),email:(this._emailField)?this._emailField.get('value'):this.data.js.email,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire("evt_answerFeedbackRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.submit_feedback_ajax,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}},_onResponseReceived:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_answerFeedbackResponse",response,originalEventObj)){if(this._incidentCreateFlag){this._incidentCreateFlag=false;if(response&&response.ID){RightNow.UI.Dialog.messageDialog(this.data.attrs.label_feedback_submit,{exitCallback:{fn:this._closeDialog,scope:this}});}
else{var message=(response&&response.error)?response.error:response;RightNow.UI.Dialog.messageDialog(message,{icon:"WARN",exitCallback:{fn:function(){RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);},scope:this}});}}
else{this._closeDialog();}}},_submitAnswerRating:function()
{var eventObject=new RightNow.Event.EventObject(this,{data:{a_id:this.data.js.answerID,rate:this._rate,options_count:this.data.attrs.options_count}});RightNow.ActionCapture.record('answer','rate',this.data.js.answerID);RightNow.ActionCapture.record('answer','rated',((this._rate-1)/(this.data.attrs.options_count-1))*100);if(RightNow.Event.fire("evt_answerRatingRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.submit_rating_ajax,eventObject.data,{successHandler:this._onRatingResponseReceived,scope:this,data:{eventName:"evt_answerRatingResponse",data:eventObject},json:true});this._replaceRatingElementsWithMessage();}},_replaceRatingElementsWithMessage:function(){var ratingElement=this.Y.one(this.baseSelector+((this.data.js.buttonView||this.data.attrs.use_rank_labels)?"_RatingButtons":"_RatingMeter"));if(ratingElement){var successMessage=this.Y.Node.create('<span class="rn_ThanksLabel">');successMessage.set('innerHTML',this.data.attrs.label_feedback_submit).set('tabIndex',-1);ratingElement.replace(successMessage);successMessage.focus();}},_onRatingResponseReceived:function(response,originalEventObj)
{RightNow.Event.fire("evt_answerRatingResponse",response,originalEventObj);},_addErrorMessage:function(message,focusElement)
{if(this._errorDisplay)
{this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');var newMessage='<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>',oldMessage=this._errorDisplay.get("innerHTML");if(oldMessage!=="")
{newMessage=oldMessage+'<br>'+newMessage;}
this._errorDisplay.set("innerHTML",newMessage);this._errorDisplay.one('a').focus();}},_onCellOver:function(event,chosenRating)
{if(this._rate<1)
{this._updateCellClass(1,chosenRating,"add");this._updateCellClass(chosenRating+1,this.data.attrs.options_count,"remove");}},_updateCellClass:function(minBound,maxBound,removeOrAddClass)
{var elementID=this.baseSelector+"_RatingCell_";for(var i=minBound;i<=maxBound;i++){if(removeOrAddClass==="add"){this.Y.one(elementID+i).addClass('rn_RatingCellOver');}else{this.Y.one(elementID+i).removeClass('rn_RatingCellOver');}}},_onCellOut:function(event,args)
{if(this._rate<1)
this._updateCellClass(1,this.data.attrs.options_count,"remove");},_onFormTokenUpdate:function(type,args){var eventObject=args[0];if(eventObject.data.newToken&&this.instanceID===eventObject.w_id){this.data.js.f_tok=eventObject.data.newToken;}}});
RightNow.Widgets.SocialBookmarkLink=RightNow.Widgets.extend({constructor:function(){this.Y.Event.attach("click",this._onClick,this.baseSelector+"_Link",this);},_onClick:function(event){event.halt();var panelElement=this.Y.one(this.baseSelector+"_Panel"),links,lastLink;if(!panelElement)return;if(!this._panel){links=panelElement.all("a");lastLink=links.item(links.size()-1);this._panel=new this.Y.Panel({srcNode:panelElement,align:{node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TC,this.Y.WidgetPositionAlign.BC]},render:true,buttons:[],hideOn:[{eventName:"clickoutside"},{node:lastLink,eventName:"keydown",keyCode:RightNow.UI.KeyMap.TAB}]});RightNow.UI.show(panelElement);}
else if(this._panel&&this._panel.get("visible")===true){this._panel.hide();return;}
this._panel.show();panelElement.one('a').focus();}});
RightNow.Widgets.EmailAnswerLink=RightNow.Widgets.extend({constructor:function(){this._dialogElement=this.Y.one(this.baseSelector+'_EmailAnswerLinkForm');if(this._dialogElement)
{this.Y.Event.attach("click",this._onEmailLinkClick,this.baseSelector+"_Link",this);}},_onEmailLinkClick:function()
{if(!this._dialog)
{var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._submitClicked,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._closeDialog,scope:this},isDefault:false}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this._dialogElement,{"buttons":buttons});this._dialogElement.removeClass("rn_Hidden").addClass("rn_EmailLinkDialog");this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._submitClicked,this);}
this._recipientEmailElement=this._recipientEmailElement||this.Y.one(this.baseSelector+"_InputRecipientEmail");this._senderEmailElement=this._senderEmailElement||this.Y.one(this.baseSelector+"_InputSenderEmail");this._senderNameElement=this._senderNameElement||this.Y.one(this.baseSelector+"_InputSenderName");this._errorDisplay=this._errorDisplay||this.Y.one(this.baseSelector+"_ErrorMessage");if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
this._dialog.show();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener,this._recipientEmailElement);},_closeDialog:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._dialog.hide();},_shouldIgnoreEvent:function(name,event){if(name==="keyPressed"){var target=(event&&event[1])?(event[1].target||event[1].srcElement):null,targetContents=target?target.getHTML():null;return(!target||target.get('tagName')==='A'||targetContents===this.data.attrs.label_send_button||targetContents===this.data.attrs.label_cancel_button);}
return false;},_submitClicked:function(type,args)
{if(this._shouldIgnoreEvent(type,args))return;RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);if(this._validateFormData())
{this._submitRequest();}
else
{RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);}},_validateFormData:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
var toEmailIsValid=this._validateEmailAddress(this._recipientEmailElement,this.data.attrs.label_to),fromEmailIsValid=!this._senderEmailElement||this._validateEmailAddress(this._senderEmailElement,this.data.attrs.label_sender_email),senderNameIsValid=!this._senderNameElement||this._validateSenderName(this._senderNameElement,this.data.attrs.label_sender_name);return toEmailIsValid&&fromEmailIsValid&&senderNameIsValid;},_validateSenderName:function(senderInput,label){var nameValue=this.Y.Lang.trim(senderInput.get("value")),id=senderInput.get("id"),errors=[];if(nameValue===""){errors.push(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"));}
else{if(nameValue.indexOf("<")>-1||nameValue.indexOf(">")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_CONTAIN_THAN_MSG"));}
if(nameValue.indexOf("'")>-1||nameValue.indexOf('"')>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_QUOTES_MSG"));}
if(nameValue.indexOf("&")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_MSG"));}}
this.Y.Array.each(errors,function(message){this._addErrorMessage(RightNow.Text.sprintf(message,label),id);},this);return!errors.length;},_validateEmailAddress:function(emailField,label)
{if(emailField)
{var emailFieldValue=this.Y.Lang.trim(emailField.get("value")),id=emailField.get("id");if(emailFieldValue==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),label),id);return false;}
if(emailFieldValue.indexOf(";")>=0||emailFieldValue.indexOf(",")>=0||emailFieldValue.indexOf(" ")>=0)
{this._addErrorMessage(RightNow.Interface.getMessage("PLEASE_ENTER_SINGLE_EMAIL_ADDRESS_MSG"),id);return false;}
if(!RightNow.Text.isValidEmailAddress(emailFieldValue))
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"),label),id);return false;}
if(emailFieldValue.length>80)
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_TOO_LONG_MSG"),label),id);return false;}
return true;}
return false;},_submitRequest:function()
{var eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,to:this._recipientEmailElement.get("value"),a_id:this.data.js.answerID,emailAnswerToken:this.data.js.emailAnswerToken,from:((this._senderEmailElement)?this._senderEmailElement.get("value"):"")||this.data.js.senderEmail,name:((this._senderNameElement)?this._senderNameElement.get("value"):"")||this.data.js.senderName}});if(RightNow.Event.fire("evt_emailLinkRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.send_email_ajax,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}},_onResponseReceived:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_emailLinkSubmitResponse",{data:originalEventObj,response:response})){if(response.ajaxError){this._closeDialog();}
else{var dialogParameters={exitCallback:{fn:this._closeDialog,scope:this}},message;if(typeof response==="string"){message=response;}
else if(response.errors){message=RightNow.Interface.getMessage('ERROR_REQUEST_ACTION_COMPLETED_MSG');dialogParameters.icon='WARN';}
else{message=this.data.attrs.label_email_sent;}
RightNow.UI.Dialog.messageDialog(message,dialogParameters);}}},_addErrorMessage:function(message,focusElement){if(this._errorDisplay){this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');var newMessage='<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>';var oldMessage=this._errorDisplay.get("innerHTML");if(oldMessage!=="")
newMessage=oldMessage+'<br/>'+newMessage;this._errorDisplay.set("innerHTML",newMessage);this._errorDisplay.one('a').focus();}}});
RightNow.Widgets.SearchTypeList=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._selectBox=this.Y.one(this.baseSelector+"_Options");if(!this._selectBox)
return;this._eo=new RightNow.Event.EventObject(this);this._selectBox.on("change",this._onSelectChange,this);this.searchSource().on("searchTypeChanged",this._onChangedResponse,this).on("search",function(){return this._eo;},this).on("reset",this._onResetRequest,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);this._setFilter();this._setSelectedDropdownItem(this.data.js.defaultFilter);}},_onSelectChange:function()
{this._setSelected();this.searchSource().fire("searchTypeChanged",this._eo);if(this.data.attrs.search_on_select)
{this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire("search",this._eo);}},_setSelectedDropdownItem:function(valueToSelect)
{this._selectBox.get("options").each(function(option,i){if(parseInt(option.get("value"),10)===valueToSelect){this._selectBox.set("selectedIndex",i);return;}},this);},_setSelected:function()
{var selectedOption=this._selectBox.get('options').item(this._selectBox.get('selectedIndex')),value=parseInt(selectedOption.get('value'),10),label=selectedOption.get('text'),node;for(node in this.data.js.filters)
{if(this.data.js.filters[node].fltr_id===value)
{this._setSelectedFilter(this.data.js.filters[node],label);}}},_setSelectedFilter:function(selected,label)
{this._eo.filters.fltr_id=selected.fltr_id;this._eo.filters.data={"val":selected.fltr_id};this._eo.filters.data.label=label;this._eo.filters.oper_id=selected.oper_id;},_setFilter:function()
{this._eo.filters={"rnSearchType":this.data.js.rnSearchType,"searchName":this.data.js.searchName,"report_id":this.data.attrs.report_id};for(var node in this.data.js.filters)
{if(this.data.js.filters[node].fltr_id===this.data.js.defaultFilter)
{this._setSelectedFilter(this.data.js.filters[node],this.data.js.filters[node].prompt);break;}}},_onResetRequest:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id))
{if(args[0].data.name===this.data.js.searchName){this._setSelectedDropdownItem(this.data.js.resetFilter);this._setSelected();}
else if(args[0].data.name==='all'){this._setSelectedDropdownItem(this.data.js.defaultFilter);this._setSelected();}}},_onChangedResponse:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id))
{var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName,this.data.attrs.report_id);this._setSelectedDropdownItem(((data&&data.val)?data.val:this.data.js.defaultFilter));this._setSelected();}}});
RightNow.Widgets.WebSearchSort=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._searchName="webSearchSort";this._optionsSelect=this.Y.one(this.baseSelector+"_Options");if(!this._optionsSelect)
return;this.searchSource().on("webSearchSortChanged",this._onChangedResponse,this).on("search",function(){return this._eo;},this).on("reset",this._onReset,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);this._optionsSelect.on("change",this._onSortChange,this);this._setFilter();}},_setFilter:function()
{this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this._searchName,report_id:this.data.js.report_id}});this._setDataObject();},_setDataObject:function()
{this._eo.filters.data={"col_id":(this.data.js.sortDefault!=this.data.js.configDefault)?this.data.js.sortDefault:null,"sort_direction":1,"sort_order":1};},_setSelected:function()
{var num=this._optionsSelect.get('selectedIndex');if(this._optionsSelect.get('options').item(num))
{this._eo.filters.data.col_id=this._optionsSelect.get('options').item(num).get('value');}},_setSelectedDropdownItem:function(valueToSelect)
{this._optionsSelect.get('options').each(function(option,i){if(parseInt(option.get('value'),10)===valueToSelect)
{this._optionsSelect.set('selectedIndex',i);}},this);},_onSortChange:function()
{this._setSelected();this.searchSource().fire("webSearchSortChanged",this._eo);},_onChangedResponse:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id))
{var data=RightNow.Event.getDataFromFiltersEventResponse(args,this._searchName,this.data.attrs.report_id);var newValue=(!data||data.col_id===null)?this.data.js.sortDefault:data.col_id;if(this._eo.filters.data===null)
this._setDataObject();this._setSelectedDropdownItem(newValue);this._setSelected();}},_onReset:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id)&&(args[0].data.name===this._searchName||args[0].data.name==="all"))
{this._setSelectedDropdownItem(this.data.js.sortDefault);this._setDataObject();}}});
RightNow.Widgets.WebSearchType=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._optionsSelect=this.Y.one(this.baseSelector+"_Options");this._searchName="webSearchType";if(!this._optionsSelect)
return;this.searchSource().on("webSearchTypeChanged",this._onChangedResponse,this).on("search",function(){return this._eo;},this).on("reset",this._onReset,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);this._optionsSelect.on("change",this._onSearchChange,this);this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this._searchName,report_id:this.data.js.report_id}});this._setFilter();}},_setFilter:function()
{this._eo.filters.data=this.data.js.searchDefault;},_setSelected:function()
{var num=this._optionsSelect.get('selectedIndex');if(this._optionsSelect.get('options').item(num))
{this._eo.filters.data=this._optionsSelect.get('options').item(num).get('value');}},_setSelectedDropdownItem:function(valueToSelect)
{this._optionsSelect.get('options').each(function(option,i){if(parseInt(option.get('value'),10)===valueToSelect)
{this._optionsSelect.set('selectedIndex',i);}},this);},_onSearchChange:function(evt)
{this._setSelected();this.searchSource().fire("webSearchTypeChanged",this._eo);},_onChangedResponse:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id))
{var data=RightNow.Event.getDataFromFiltersEventResponse(args,this._searchName,this.data.attrs.report_id);var newValue=(!data)?this.data.js.searchDefault:data;this._setSelectedDropdownItem(newValue);this._setSelected();}},_onReset:function(type,args)
{if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id)&&(args[0].data.name===this._searchName||args[0].data.name==="all"))
{this._setSelectedDropdownItem(this.data.js.searchDefault);this._setFilter();}}});
RightNow.Widgets.ProductCategorySearchFilter=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._getFiltersRequest.lastInstance=this._getFiltersRequest.lastInstance||{};this._currentIndex=0;this._noValueNodeIndex=0;this._displayField=this.Y.one(this.baseSelector+"_"+this.data.attrs.filter_type+"_Button");this._displayFieldVisibleText=this.Y.one(this.baseSelector+"_ButtonVisibleText");this._accessibleView=this.Y.one(this.baseSelector+"_Links");this._outerTreeContainer=this.Y.one(this.baseSelector+"_TreeContainer");if(!this._displayField)return;this.searchSource(this.data.attrs.report_id).on('search',this._getFiltersRequest,this).on('response',this._onReportResponse,this).on('reset',this._onResetRequest,this);RightNow.Event.subscribe("evt_menuFilterGetResponse",this._getSubLevelResponse,this);RightNow.Event.subscribe("evt_accessibleTreeViewGetResponse",this._getAccessibleTreeViewResponse,this);this._displayField.on('click',this._toggleProductCategoryPicker,this);this.Y.one(this.baseSelector+"_LinksTrigger").on("click",this._toggleAccessibleView,this);this._initializeFilter();this._panel=new this.Y.Panel({srcNode:this._outerTreeContainer.removeClass('rn_Hidden'),width:300,visible:false,render:this.Y.one(this.baseSelector),headerContent:'',hideOn:[{eventName:'clickoutside'}],align:{node:this._displayField,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]},zIndex:1000});this.Y.one(this.baseSelector+'_Tree').setStyle('overflow-y','auto');if(this.data.js.hierData[0].length){this._buildTree();}}},_buildTree:function(forceRebuild){if(this._tree&&!forceRebuild)return;var YAHOO=this.Y.Port(),gallery=this.Y.apm,treeDiv=document.getElementById("rn_"+this.instanceID+"_Tree");if(treeDiv&&gallery.TreeView)
{this._tree=new gallery.TreeView(treeDiv.id);this._tree.setDynamicLoad(RightNow.Event.createDelegate(this,this._getSubLevelRequest));this._tree.subscribe('focusChanged',function(e){if(e.newNode){this._treeCurrentFocus=e.newNode;}
else if(e.oldNode){this._treeCurrentFocus=e.oldNode;}},this);if(!this.data.attrs.show_confirm_button_in_dialog){this.Y.one(this._tree.getEl()).on('key',function(ev){var currentNode=this._treeCurrentFocus;if(currentNode.href){if(currentNode.target){window.open(currentNode.href,node.target);}
else{window.location(currentNode.href);}}
else{currentNode.toggle();}
this._tree.fireEvent('enterKeyPressed',currentNode);ev.halt();},'tab',this);}
var hasDefaultValue=false,hierData=this.data.js.hierData||this.data.js.hierDataNone,scope=this,insertNodes=function(nodeList,root){var dataNode,node,childNodes=[],i;for(i=0;i<nodeList.length;i++){dataNode=nodeList[i];node=new gallery.MenuNode(scope.Y.Escape.html(dataNode.label),root);node.href='javascript:void(0)';node.hierValue=dataNode.id;if(!dataNode.hasChildren){node.dynamicLoadComplete=true;node.iconMode=1;}
if(dataNode.selected){hasDefaultValue=true;scope._currentIndex=node.index;}
if(dataNode.hasChildren&&hierData[dataNode.id]){childNodes.push({children:hierData[dataNode.id],parent:node});}}
root.loadComplete();for(i=0;i<childNodes.length;i++){insertNodes(childNodes[i].children,childNodes[i].parent);}};if(this.data.js.hierData&&this.data.js.hierDataNone)
delete this.data.js.hierData;insertNodes(hierData[0],this._tree.getRoot());var noValueNode=this._tree.getRoot().children[0];noValueNode.isLeaf=true;this._noValueNodeIndex=noValueNode.index;this._tree.subscribe("enterKeyPressed",this._enterPressed,this);if(this.data.attrs.show_confirm_button_in_dialog)
{var confirmButton=this.Y.one(this.baseSelector+'_'+this.data.attrs.filter_type+'_ConfirmButton'),cancelButton=this.Y.one(this.baseSelector+'_'+this.data.attrs.filter_type+'_CancelButton');confirmButton.detach('click');cancelButton.detach('click');cancelButton.detach('keydown');confirmButton.on('click',function(){this._selectNode({node:this._treeCurrentFocus});},this);cancelButton.on('click',function(){this._panel.hide();},this);cancelButton.on('key',function(ev){!ev.shiftKey&&this._toggleProductCategoryPicker();},'tab',this);}
else
{this._tree.subscribe('clickEvent',this._selectNode,this);}
this._tree.subscribe('expandComplete',function(e){treeDiv.scrollTop=this.Y.one('#'+e.contentElId).ancestor('.ygtvitem').get('offsetTop');},this);this._tree.collapseAll();this.Y.one(this.baseSelector+'_Tree').setStyle('display','block');if(this.data.attrs.show_confirm_button_in_dialog)
this.Y.one(this.baseSelector+'_TreeContainer').setStyle("display","block");if(hasDefaultValue)
this._displaySelectedNodesAndClose(false);}},_displayAccessibleDialog:function()
{this._buildTree();if(!(this._dialog))
{var handleDismiss=function()
{this.hide();};this._buttons=[{text:RightNow.Interface.getMessage("CANCEL_CMD"),handler:handleDismiss,isDefault:false}];RightNow.UI.show(this._accessibleView);this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_nothing_selected,this._accessibleView,{"buttons":this._buttons});this._dialog.after('visibleChange',function(e)
{if(!e.newVal)
{this._displayField.focus();}},this);}
else
{var currentlySelectedSpan=document.getElementById(this.baseDomID+"_IntroCurrentSelection"),introLink=document.getElementById(this.baseDomID+"_Intro");if(currentlySelectedSpan&&introLink)
{var currentNode=this._tree.getNodeByIndex(this._currentIndex);if(!currentNode)
{currentNode={};currentNode.hierValue=0;}
var localID=this.baseDomID;introLink.onclick=function(){document.getElementById(localID+"_AccessibleLink_"+currentNode.hierValue).focus();};var selectedNodes=this._getSelectedNodesMessage();selectedNodes=selectedNodes[0]?selectedNodes.join(", "):this.data.attrs.label_all_values;currentlySelectedSpan.innerHTML=RightNow.Text.sprintf(RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),selectedNodes);}}
this.Y.Lang.later(1000,this._dialog,'show');},_toggleAccessibleView:function()
{if(this._dataType==="Category"&&this.data.js.linkingOn)
this._eo.data.linkingProduct=RightNow.UI.Form.currentProduct;if(this._flatTreeViewData)
this._displayAccessibleDialog();else
RightNow.Event.fire("evt_accessibleTreeViewRequest",this._eo);},_getAccessibleTreeViewResponse:function(e,args)
{if(args[0].data.hm_type!==this._eo.data.hm_type)return;var evtObj=args[0],i;if(evtObj.data.data_type===this._dataType)
{this._flatTreeViewData=evtObj.data.accessibleLinks;var noValue={0:this.data.attrs.label_all_values,1:0,hier_list:0,level:0};if(!this.Y.Lang.isArray(this._flatTreeViewData))
{var tempArray=[];for(i in this._flatTreeViewData)
{if(!isNaN(parseInt(i,10)))
tempArray[i]=this._flatTreeViewData[i];}
this._flatTreeViewData=tempArray;}
this._flatTreeViewData.unshift(noValue);var htmlList="<p><a href='javascript:void(0)' id='rn_"+this.instanceID+"_Intro'"+"onclick='document.getElementById(\"rn_"+this.instanceID+"_AccessibleLink_"+noValue[1]+"\").focus();'>"+RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_LNKS_DEPTH_ANNOUNCED_MSG"),this.data.attrs.label_input)+" <span id='rn_"+this.instanceID+"_IntroCurrentSelection'>"+RightNow.Text.sprintf(RightNow.Interface.getMessage("SELECTION_PCT_S_ACTIVATE_LINK_JUMP_MSG"),noValue[0])+"</span></a></p>",previousLevel=-1;for(i in this._flatTreeViewData)
{if(this._flatTreeViewData.hasOwnProperty(i))
{var item=this._flatTreeViewData[i];if(item.level>previousLevel)
htmlList+="<ol>";while(item.level<previousLevel)
{htmlList+="</li></ol>";previousLevel--;}
if(item.level===previousLevel)
htmlList+="</li>";htmlList+='<li><a href="javascript:void(0)" id="rn_'+this.instanceID+'_AccessibleLink_'+item[1]+'" class="rn_AccessibleHierLink" hierList="'+item.hier_list+'">'+'<span class="rn_ScreenReaderOnly">'+this.data.attrs.label_level+' '+(item.level+1)+'</span>'+item[0]+'</a>';previousLevel=item.level;}}
for(i=previousLevel;i>=0;--i)
htmlList+="</li></ol>";htmlList+="<div id='rn_"+this.instanceID+"_AccessibleErrorLocation'></div>";this._accessibleView.set('innerHTML',htmlList);this._accessibleView.all('a.rn_AccessibleHierLink').on('click',this._accessibleLinkClick,this);this._displayAccessibleDialog();}},_accessibleLinkClick:function(e)
{this._expandAndCreateNodes(e.target.getAttribute("hierList").split(","));return false;},_toggleProductCategoryPicker:function(e)
{this._buildTree();if(!this._panel.get("visible"))
{this._panel.align().show();var currentNode=this._tree.getNodeByIndex(this._currentIndex)||this._tree.getRoot().children[0];if(currentNode&&currentNode.focus)
{currentNode.focus();}}},_getSelectedNodesMessage:function()
{return this._getPropertyChain("label");},_getPropertyChain:function(property)
{property=property||"label";this._currentIndex=this._currentIndex||1;var hierValues=[],currentNode=this._tree.getNodeByIndex(this._currentIndex);while(currentNode&&!currentNode.isRoot())
{hierValues.push(currentNode[property]);currentNode=currentNode.parent;}
return hierValues.reverse();},_displaySelectedNodesAndClose:function(focus)
{var hierValues,field,description,descText;this._eo.data.hierChain=this._getPropertyChain('hierValue');RightNow.Event.fire("evt_productCategoryFilterSelected",this._eo);delete this._eo.data.hierChain;this._panel.hide();this._displayField.setAttribute("aria-busy","true");if(this._currentIndex<=this._noValueNodeIndex)
{this._displayFieldVisibleText.setHTML(this.data.attrs.label_nothing_selected);descText=this.data.attrs.label_nothing_selected;}
else
{hierValues=this._getSelectedNodesMessage().join("<br>");this._displayFieldVisibleText.setHTML(hierValues);descText=this.data.attrs.label_screen_reader_selected+hierValues;}
description=this.Y.one(this.baseSelector+"_TreeDescription");if(description)
description.setHTML(descText);this._displayField.setAttribute("aria-busy","false");if(this._dialog&&this._dialog.get("visible"))
this._dialog.hide();if(focus&&this._displayField.focus&&!this._dialog)
try{this._displayField.focus();}catch(e){}},_enterPressed:function(keyEvent)
{this._selectNode({node:keyEvent.details[0]});},_selectNode:function(clickEvent)
{this._currentIndex=clickEvent.node.index;this._selected=true;this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this.baseDomID;this._selectNode._selectedWidget=this.data.info.w_id;if((clickEvent.node.expanded||this._noValueNodeIndex===clickEvent.node.index)&&!this.data.js.linkingOn)
{this._eo.data.level=clickEvent.node.depth+1;if(this._eo.data.level!==this._eo.filters.data[0].length)
{this._eo.filters.data[0]=[];var currentNode=clickEvent.node;while(currentNode&&!currentNode.isRoot())
{this._eo.filters.data[0][currentNode.depth]=currentNode.hierValue;currentNode=currentNode.parent;}}
else
{this._eo.filters.data[0][this._eo.data.level-1]=clickEvent.node.hierValue||this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}}
else if(this.data.attrs.search_on_select&&!RightNow.Url.isSameUrl(this.data.attrs.report_page_url))
{this._eo.data.level=clickEvent.node.depth+1;this._eo.data.label=clickEvent.node.label;this._eo.data.value=clickEvent.node.hierValue;this._eo.filters.data[0][clickEvent.node.depth]=clickEvent.node.hierValue;}
else
{this._getSubLevelRequest(clickEvent.node);this._tree.collapseAll();}
this._displaySelectedNodesAndClose(true);if(clickEvent.event)
clickEvent.event.preventDefault();if(this.data.attrs.search_on_select)
{this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire('search',this._eo);}
return false;},_getSubLevelRequest:function(expandingNode)
{if(this._nodeBeingExpanded||(expandingNode.expanded&&!this.data.js.linkingOn))return;this._nodeBeingExpanded=true;this._eo.data.level=expandingNode.depth+1;this._eo.data.label=expandingNode.label;this._eo.data.value=expandingNode.hierValue;if(this.data.attrs.show_confirm_button_in_dialog)
this._requestedIndex=expandingNode.index;else
this._currentIndex=expandingNode.index;this._getSubLevelRequest._origRequest=this._getSubLevelRequest._origRequest||[];this._getSubLevelRequest._origRequest[this._dataType]=expandingNode.hierValue;if(this._dataType==="Product")
{RightNow.UI.Form.currentProduct=this._eo.data.value;}
if(this._eo.data.value<1&&this._eo.data.linking_on)
{this._eo.data.reset=true;if(this._eo.data.value===0&&this._dataType==="Product")
{this._eo.data.reset=false;this.searchSource().fire('reset',new RightNow.Event.EventObject(this,{data:{name:'c',reset:true}}));this._nodeBeingExpanded=false;return;}
else
{this._eo.data.value=0;}}
else
{this._eo.data.reset=false;}
if(this.data.js.link_map)
{this._eo.data.link_map=this.data.js.link_map;this.data.js.link_map=null;}
if(this._eo.data.level!==this._eo.filters.data[0].length)
{this._eo.filters.data[0]=[];var currentNode=expandingNode;while(currentNode&&!currentNode.isRoot())
{this._eo.filters.data[0][currentNode.depth]=currentNode.hierValue;currentNode=currentNode.parent;}}
else
{this._eo.filters.data[0][this._eo.data.level-1]=this._eo.data.value;for(var i=this._eo.data.level;i<this._eo.filters.data[0].length;i++)
delete this._eo.filters.data[0][i];}
if(!expandingNode.dynamicLoadComplete||this.data.js.linkingOn)
RightNow.Event.fire("evt_menuFilterRequest",this._eo);if(this._eo.data.link_map)
delete this._eo.data.link_map;this._nodeBeingExpanded=false;},_onReportResponse:function(type,args)
{var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName);this._getFiltersRequest.cachedWidgetHier={};if(data[0]&&data[0].length){this._buildTree();if(typeof data[0]==="string")
data[0]=data[0].split(",");var finalData=RightNow.Lang.arrayFilter(data[0]);var fromHistoryManager=args&&args[0]&&args[0].data&&args[0].data.fromHistoryManager;this._expandAndCreateNodes(finalData,fromHistoryManager);this._eo.filters.data[0]=finalData;this._lastSearchValue=finalData.slice(0);if(this._eo.filters.data.reconstructData){this._eo.filters.data.level=this._eo.filters.data.reconstructData.level;this._eo.filters.data.label=this._eo.filters.data.reconstructData.label;}}
else{this._eo.filters.data[0]=[];if(this._tree){this._currentIndex=this._noValueNodeIndex;this._displaySelectedNodesAndClose();}}},_expandAndCreateNodes:function(hierArray,fromHistoryManager)
{var i=hierArray.length-1,currentNode=null;while(!currentNode&&i>=0){currentNode=this._tree.getNodeByProperty("hierValue",parseInt(hierArray[i],10));i--;}
if(this._dataType==="Category"&&this.data.js.linkingOn&&fromHistoryManager){this._restorationHierArray=hierArray;}
if(!currentNode){return;}
if(this._currentIndex===currentNode.index)
{if(this._dialog&&this._dialog.get("visible"))
this._dialog.hide();return;}
i++;if(this._noValueNodeIndex===currentNode.index||currentNode.hierValue===hierArray[hierArray.length-1]){this._selectNode({node:currentNode});}
else{var onExpandComplete=function(expandingNode){if(expandingNode.nextToExpand){var nextNode=this._tree.getNodeByProperty("hierValue",parseInt(expandingNode.nextToExpand,10));if(nextNode){nextNode.nextToExpand=hierArray[++i];nextNode.expand();}}
else if(i===hierArray.length){this._tree.unsubscribe("expandComplete",onExpandComplete,null);expandingNode.expanded=false;this._selectNode({node:expandingNode});}
return true;};this._tree.subscribe("expandComplete",onExpandComplete,this);currentNode.nextToExpand=hierArray[++i];currentNode.expand();}},_getSubLevelResponse:function(type,args)
{var evtObj=args[0];if((evtObj.data.data_type!==this._dataType)||(evtObj.filters.report_id!==this.data.attrs.report_id))
return;if(this.data.js.link_map)
delete this.data.js.link_map;var hierLevel=evtObj.data.level,hierData=evtObj.data.hier_data,redisplaySelectedNode=false,currentRoot,tempNode;this._buildTree();if(!evtObj.data.reset_linked_category&&this._getSubLevelRequest._origRequest&&this._getSubLevelRequest._origRequest[this._dataType])
{currentRoot=this._tree.getNodeByProperty("hierValue",this._getSubLevelRequest._origRequest[this._dataType]);if(currentRoot&&currentRoot.index!==(this.data.attrs.show_confirm_button_in_dialog?this._requestedIndex:this._currentIndex))
{this._currentIndex=currentRoot.index;redisplaySelectedNode=true;}}
else if(evtObj.data.reset_linked_category)
{currentRoot=this._tree.getRoot();currentRoot.dynamicLoadComplete=false;this._tree.removeChildren(currentRoot);this._flatTreeViewData=null;tempNode=new this.Y.apm.MenuNode(this.Y.Escape.html(this.data.attrs.label_all_values),currentRoot,false);tempNode.hierValue=0;tempNode.href='javascript:void(0);';tempNode.isLeaf=true;this._noValueNodeIndex=this._currentIndex=this._requestedIndex=tempNode.index;this._displayFieldVisibleText.setHTML(this.data.attrs.label_nothing_selected);var description=this.Y.one(this.baseSelector+"_TreeDescription");if(description)
description.setHTML(this.data.attrs.label_nothing_selected);}
if(hierLevel<7&&currentRoot&&!currentRoot.dynamicLoadComplete)
{for(var i=0;i<hierData.length;i++)
{tempNode=new this.Y.apm.MenuNode(this.Y.Escape.html(hierData[i].label),currentRoot,false);tempNode.hierValue=hierData[i].id;tempNode.href='javascript:void(0);';if(!hierData[i].hasChildren||hierLevel===6)
{tempNode.dynamicLoadComplete=true;tempNode.iconMode=1;}}
currentRoot.loadComplete();}
if(hierData.length===0&&!this._selected)
{this._displaySelectedNodesAndClose();}
else if(this._selected)
{this._selected=false;}
else if(redisplaySelectedNode&&this._selectNode._selectedWidget)
{this._selectNode._selectedWidget=null;this._displaySelectedNodesAndClose();}
if(this._restorationHierArray){var hierArray=this._restorationHierArray;this._restorationHierArray=null;this._expandAndCreateNodes(hierArray);tempNode=this._tree.getNodeByProperty("hierValue",parseInt(hierArray[hierArray.length-1],10));if(tempNode)
this._selectNode({node:tempNode});}},_getFiltersRequest:function(type,args)
{this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]=this._getFiltersRequest.lastInstance[this.data.attrs.filter_type]||null;this._getFiltersRequest.cachedWidgetHier=this._getFiltersRequest.cachedWidgetHier||{};var filterName=(this._eo.filters.searchName||"")+this.data.attrs.report_id,filterKey=filterName+this.baseDomID,mostRecentFilterKey=filterName+this._getFiltersRequest.lastInstance[this.data.attrs.filter_type],cachedHier=this._getFiltersRequest.cachedWidgetHier[mostRecentFilterKey];this._eo.filters.data.reconstructData=[];if(this._tree&&this._currentIndex&&this._currentIndex!==this._noValueNodeIndex)
{var currentNode=this._tree.getNodeByIndex(this._currentIndex),hierValues,level;this._eo.data.level=currentNode.depth+1;this._eo.data.label=currentNode.label;this._eo.data.value=currentNode.hierValue;while(currentNode&&!currentNode.isRoot())
{level=currentNode.depth+1;hierValues=this._eo.filters.data[0].slice(0,level).join(",");this._eo.filters.data.reconstructData.push({"level":level,"label":currentNode.label,"hierList":hierValues});currentNode=currentNode.parent;}
this._eo.filters.data.reconstructData.reverse();if(cachedHier&&filterKey!==mostRecentFilterKey){this._eo.filters.data=cachedHier;}
else{this._getFiltersRequest.cachedWidgetHier[filterKey]=RightNow.Lang.cloneObject(this._eo.filters.data);}}
else if(cachedHier)
{this._eo.filters.data=cachedHier;this._eo.data.value=cachedHier[0][0];}
else
{this._eo.filters.data[0]=[];this._eo.data.value=0;}
this._lastSearchValue=this._eo.filters.data[0].slice(0);return this._eo;},_onResetRequest:function(type,args)
{args=args[0];if(this._tree&&(!args||args.data.name==='all'||args.data.name===this.data.js.searchName))
{if(args&&args.data.name==="all"&&this._lastSearchValue)
{this._eo.filters.data[0]=this._lastSearchValue;var currentNode=this._tree.getNodeByProperty("hierValue",this._lastSearchValue[this._lastSearchValue.length-1]);this._currentIndex=currentNode?currentNode.index:this._noValueNodeIndex;}
else
{if(args&&args.data.reset&&this.data.js.linkingOn&&this._dataType==="Category")
{RightNow.Event.fire('evt_resetFilterRequest',args);if(this.data.js.link_map)
delete this.data.js.link_map;this._buildTree(true);}
if(!args)
this._eo.filters.data=[(this.data.js.initial)?this.data.js.initial:[]];else
this._eo.filters.data[0]=[];this._lastSearchValue=this._eo.filters.data[0].slice(0);this._currentIndex=this._tree.getNodeByProperty("hierValue",this._lastSearchValue[this._lastSearchValue.length-1]).index;this._getFiltersRequest.cachedWidgetHier={};}
this._displaySelectedNodesAndClose();}},_initializeFilter:function()
{this._eo=new RightNow.Event.EventObject(this,{data:{data_type:this._dataType=this.data.attrs.filter_type,linking_on:this.data.js.linkingOn,cache:[],hm_type:this.data.js.hm_type,linkingProduct:0},filters:{rnSearchType:"menufilter",searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,fltr_id:this.data.js.fltr_id,oper_id:this.data.js.oper_id,data:[(this.data.js.initial)?this.data.js.initial:[]]}});this._lastSearchValue=this._eo.filters.data[0].slice(0);if(this._dataType==="Product")
{RightNow.UI.Form.currentProduct=this._eo.filters.data[0][this._eo.filters.data[0].length-1];}}});
RightNow.Widgets.FilterDropdown=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._eo=new RightNow.Event.EventObject(this);this._selectBox=this.Y.one(this.baseSelector+"_Options");this._selectBox.on("change",this._onSelectChange,this);this.searchSource().on("search",function(){return this._eo;},this).on("reset",this._onResetRequest,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);this._setSelectedDropdownItem(this.data.js.defaultValue);this._setFilter();this.lastValue=this._eo.filters.data.val;}},_onSelectChange:function()
{this.lastValue=this._eo.filters.data.val;this._eo.filters.data.val=this._getSelected();if(this.data.attrs.search_on_select)
{this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire("search",this._eo);}},_getSelected:function()
{return this._selectBox.get('options').item(this._selectBox.get('selectedIndex')).get('value');},_setSelectedDropdownItem:function(valueToSelect)
{this._selectBox.get("options").each(function(option,i){if(option.get("value")===(valueToSelect+'')){this._selectBox.set("selectedIndex",i);return;}},this);},_setFilter:function()
{this._eo.filters={"searchName":this.data.js.searchName,"rnSearchType":this.data.js.rnSearchType,"report_id":this.data.attrs.report_id,"data":{"fltr_id":this.data.js.filters.fltr_id,"oper_id":this.data.js.filters.oper_id,"val":this._getSelected()}};},_onChangedResponse:function(type,args)
{var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName,this.data.attrs.report_id),newValue=this._eo.filters.data.val,allFilters;if(data&&data.fltr_id===this.data.js.filters.fltr_id){newValue=data.val||this.data.js.defaultValue;}
else if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id)){allFilters=args[0].filters.allFilters[this.data.js.searchName];if(!allFilters){newValue=this.data.js.defaultValue;}}
if(newValue!==this._eo.filters.data.val){this._setSelectedDropdownItem(newValue);this._eo.filters.data.val=this.lastValue=newValue;}},_onResetRequest:function(type,args)
{var resetValue=this._eo.filters.data.val;if(RightNow.Event.isSameReportID(args,this.data.attrs.report_id)&&(args[0].data.name===this.data.js.searchName||args[0].data.name==="all"))
{if(args[0].data.name===this.data.js.searchName){resetValue=this.lastValue=this.data.js.defaultValue;}
else if(args[0].data.name==='all'){resetValue=this.lastValue||resetValue;}
if(resetValue!==this._eo.filters.data.val){this._setSelectedDropdownItem(resetValue);this._eo.filters.data.val=resetValue;}}}});
RightNow.Widgets.SortList=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._headingsSelect=this.Y.one(this.baseSelector+"_Headings");this._directionSelect=this.Y.one(this.baseSelector+"_Direction");RightNow.Event.on("evt_sortChange",this._onResponse,this);this.searchSource().on("search",this._onSearch,this).on("reset",this._onReset,this);this.searchSource(this.data.attrs.report_id).on("response",this._onResponse,this);this._setFilter();this._setSelectedDropdownItem(this._headingsSelect,this.data.js.col_id);this._setSelectedDropdownItem(this._directionSelect,this.data.js.sort_direction);this._headingsSelect.on("change",this._onChange,this,"column");this._directionSelect.on("change",this._onChange,this,"direction");}},_onChange:function(evt,dropdownThatChanged){this._setEventObjectFromUI(dropdownThatChanged);RightNow.Event.fire("evt_sortChange",this._eo);if(this.data.attrs.search_on_select){this._eo.filters.reportPage=this.data.attrs.report_page_url;this.searchSource().fire("search",this._eo);}},_setEventObjectFromUI:function(dropdownThatChanged){var selectBox,memberToSet,index;if(dropdownThatChanged==="direction"){selectBox=this._directionSelect;memberToSet="sort_direction";}
else{selectBox=this._headingsSelect;memberToSet="col_id";}
if(selectBox){index=selectBox.get("selectedIndex");index=(index>0)?index:0;this._eo.filters.data[memberToSet]=parseInt(selectBox.get("options").item(index).get("value"),10);}},_setSelectedDropdownItem:function(selectBox,valueToSelect){if(selectBox){selectBox.get("options").each(function(option,i){if(parseInt(option.get("value"),10)===valueToSelect){selectBox.set("selectedIndex",i);return true;}});}
return false;},_setFilter:function(){this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,report_id:this.data.attrs.report_id,data:this._getDataObject()}});},_getDataObject:function(){return{col_id:this.data.js.col_id,sort_direction:this.data.js.sort_direction};},_onResponse:function(name,args){if(args[0].w_id===this.instanceID)return;var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName,this.data.attrs.report_id);if(this._eo.filters.data===null){this._eo.filters.data=this._getDataObject();}
this._setSelectedDropdownItem(this._headingsSelect,((!data||data.col_id==null)?this.data.js.col_id:data.col_id));this._setEventObjectFromUI("column");this._setSelectedDropdownItem(this._directionSelect,((!data||data.sort_direction==null)?this.data.js.sort_direction:data.sort_direction));this._setEventObjectFromUI("direction");},_onReset:function(type,args){if(!args[0]||args[0].data.name===this.data.js.searchName||args[0].data.name==="all"){this._setSelectedDropdownItem(this._headingsSelect,this.data.js.col_id);this._setSelectedDropdownItem(this._directionSelect,this.data.js.sort_direction);this._setFilter();}},_onSearch:function(type,args){return this._eo;}});