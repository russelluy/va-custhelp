
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a){this._errors=a||[];this._value=this.getValue();this._checkRequired();this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+
c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_PCT_D_LBL"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){for(var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' class='rn_HintBox'>"+this.data.attrs.hint+"</span>"),b=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;b.next();)b=b.next();a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:{node:b,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio()))this.input.on("click",function(){b.focus();a.show()});else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
(function(){var n=function(){var c={},b={},k={};return{getDeferred:function(f,e){if(c[f])return c[f];b[e]=b[e]||{events:[]};b[e].form=f;return{on:function(a,d,c){if(d&&"function"===typeof d)return b[e].events.push({name:a,handler:d,context:c}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,d){if(a&&d&&"object"===typeof d)k[f]||(k[f]={}),k[f][a]=d;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(b){return c[b]},newInstance:function(b,e){e instanceof RightNow.Form&&(c[b]=e)},getDeferredEvents:function(c){var e,a,d={};for(e in b)if(a=b[e],b.hasOwnProperty(e)&&a.form===c&&a.events.length){a=a.events;for(var h=0;h<a.length;h++)d[a[h].name]=d[a[h].name]||[],d[a[h].name].push(a[h])}return d},getDeferredFields:function(b){return k[b]}}}(),m=function(){function c(a,b,c,e){var g={},k=a.getAttribute("target");a.all("input, select, textarea").each(function(a){var b=a.get("type");""!==a.get("name")&&"submit"!==b&&"image"!==b&&(g[a.get("name")]=a.get("value"))});a=b+RightNow.Url.convertToSegment(g)+c;RightNow.Url.getSession()&&(a=RightNow.Url.addParameter(a,"session",RightNow.Url.getSession()));a=e.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",a);k&&a.setAttribute("target",k);e.Y.one(document.body).append(a);a=e.Y.Node.getDOMNode(a);document.createEvent?(e=document.createEvent("MouseEvents"),e.initEvent("click",!1,!1),a.dispatchEvent(e)):a.fireEvent("onclick")}function b(a){this.fire("response",new RightNow.Event.EventObject(this,{data:a}))}function k(a){this.fire("responseError",new RightNow.Event.EventObject(this,{data:a}))}var f={},e={};return{submitForm:function(a,d,h){var f=h.Y.one("#"+a),g=f.getAttribute("method"),l=f.getAttribute("action");a=e[a];d=d||"";if(l&&!h.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(l,"/")&&RightNow.Url.isExternalUrl(l)){d&&f.set("action",l+d);for(d=0;d<a.length;d++)(g=a[d])&&g.value&&((l=f.one('input[name="'+g.name+'"]'))?l.set("value",g.value):f.append(h.Y.Node.create('<input type="hidden" name="'+
g.name+'" value="'+g.value+'"/>')));f.submit()}else c(f,l,d,h);else{f=(l||"/ci/ajaxRequest/sendForm")+d;if(RightNow.Event.noSessionCookies())for(d=0,g=a.length;d<g;d++)if("Contact.Login"===a[d].name){document.cookie="cp_login_start=1;path=/";break}a={f_tok:h._originalEventObject.data.f_tok,form:RightNow.JSON.stringify(a),updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id")})};d={scope:h,json:!0,successHandler:b,failureHandler:k};g=RightNow.UI.Form;null!=g.smartAssistant&&(a.smrt_asst=g.smartAssistant);null!==g.smartAssistantToken&&(a.saToken=g.smartAssistantToken);if(h._originalEventObject){h._originalEventObject.data.timeout&&(d.timeout=h._originalEventObject.data.timeout);h=h._originalEventObject;for(var g=["challengeHandler","challengeHandlerContext"],m,l=0;l<g.length;++l)m=g[l],d[m]=h[m]||void 0}RightNow.Ajax.makeRequest(f,a,d)}},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,c){f[a]||(f[a]={});f[a][b]=c},findField:function(a,b){return f[a][b]},getAllFields:function(a){return f[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(b){b.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));this._errorMessageDiv.setAttribute("aria-live","assertive");if(this._parentForm){if(n.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");n.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=n.getDeferredEvents(this._parentForm);this.Y.Object.each(n.getDeferredFields(this._parentForm),function(b,c){m.addField(this._parentForm,c,b)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(b){m.resetValidatedFields(this._parentForm);this._challengeDivID&&(b.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=b},during:function(b){!1===b?this._eventCanceled=!0:b instanceof RightNow.Event.EventObject&&m.addValidatedField(this._parentForm,b)},post:function(b){var c=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+c,b)}})._addEventHandler("send",{post:function(b){this._eventCanceled||m.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(b){!1===b&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(b){b&&this._collectedFields.push(b)},post:function(b){this.fire("submit",b)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(c){throw"Failed while trying to parse a challenge provider.  "+c;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}}},_filterSubmittedWidgets:function(c){var b=m.getAllFields(this._parentForm),k=[];this.Y.Object.each(b,function(b,e){this.Y.Array.each(c,function(a,c){a.context===b&&-1===this.Y.Array.indexOf(this._collectedFields,e)&&k.push(c)},this)},this);return k},getValidatedFields:function(){return m.getValidatedFields(this._parentForm)},addField:function(c,b){m.addField(this._parentForm,c,b)},findField:function(c){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return m.findField(this._parentForm,c)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"'>"),"before")},_reportChallengeError:function(c){c=c||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+c+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus();return!1}))},_challengeHandler:function(c,b,k){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(c),this.on("submit",this._onValidateChallengeResponse,this));this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(c));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var c=this._challengeProvider.getInputs(this._challengeDivID);if(c.abuse_challenge_response)for(var b in c)c.hasOwnProperty(b)&&RightNow.Ajax.addRequestData(b,c[b])}},{find:function(c,b,k){if(c=RightNow.UI.findParentForm(c))return k?c:n.getDeferred(c,b);throw Error("You're using a form that doesn't have a proper form submit button or an id");}})})();
(function(){function r(f){function h(a,b){b=b?RightNow.Url.convertToSegment(RightNow.Url.convertToArray(1,b)):"";d.add({state:a},{url:p.getCurrentPage()+b})}function k(a){return function(){g||a.apply(this,arguments)}}var c={},e={},a={},b="",g=!1,d=new f.HistoryHTML5;d.on("change",function(a){var b;a.src===f.HistoryHTML5.SRC_POPSTATE&&(a=a.changed.state||a.changed[RightNow.Event.browserHistoryManagementKey],b=l.get(),g=!0,a?f.Object.each(a.newVal,function(a){q.ajaxCallback(a.response,a.data)}):f.Object.each(b,function(a){a.fire("reset").fire("send")}),g=!1)});return{enabled:!0,setCache:function(a,b,g){c[a]||(c[a]={});c[a][b]=g},checkCache:function(a,b){return c[a]?c[a][b]:null},restoreCache:k(function(c){f.Object.isEmpty(e)&&h(a,b+=c.friendly);b=""}),addRequest:k(function(c,g){f.Object.isEmpty(e)&&(q.searchesPerformed++,a={},b="");e[g]=c}),addResponse:k(function(c,g){var d=e[g];if(d){var k=b+=d.friendly,d=f.merge(d,c);a[g]=d;delete e[g];f.Object.isEmpty(e)&&h(a,k)}})}}var m,q,p,l;"pushState"in window.history?YUI().use("history-html5",function(f){m=r(f)}):m={enabled:!1};q=function(){function f(a,b,c){var d="undefined"===typeof c;a&&!d&&m.addResponse({response:a,data:b},c);m.setCache(b.searchSource,b.cacheKey,a);c=l.get(b.searchSource);d&&(c.once("send",function(){return!1}).fire("send",b.allFilters),a.fromHistoryManager=!0);c.fire("response",new RightNow.Event.EventObject(null,{data:a,filters:b.allFilters}))}function h(a,b,c,d){a=RightNow.Ajax.makeRequest(a,b,{successHandler:f,failureHandler:function(a){var b=RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG");403===a.status&&void 0!==a.responseText&&(b=a.responseText);RightNow.UI.Dialog.messageDialog(b,{icon:"WARN",exitCallback:function(){window.location.reload(!0)}})},json:!0,data:c,timeout:1E4});m.addRequest(d,a.id+"")}function k(a,b,c,d){var f=["keyword"].concat(a.filters||[]),s=f.length,h,k,l={};c=RightNow.Lang.cloneObject(c);a.params&&(c=e.mix(c,a.params));if(b&&b.allFilters)for(a=0;a<s;a++)h=f[a],(k=b.allFilters[h])&&k.filters&&k.filters.data&&!c[h]&&("keyword"!==h||d||(h="kw"),l[h]=c[h]=k.filters.data);c.page&&!l.page&&(l.page=c.page);return{filtersToInclude:l,params:c}}function c(a,b){b&&1!==b||(a=RightNow.Url.addParameter(a,"search","1"));return a}var e=YUI();return{searchesPerformed:0,go:function(a,b,g,d,e){if("report"===d.type){if("undefined"===typeof b)throw Error("No search filters have been defined for report "+d.id);RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b}));if(!m.enabled||!0===a.newPage||a.reportPage&&!RightNow.Url.isSameUrl(a.reportPage))if(g=RightNow.Url,d=a.reportPage||p.getCurrentPage(),e=a.target||"_self",!a.page&&b.allFilters.page&&(a.page=1,b.allFilters.page=1),d=g.convertSearchFiltersToParms(d,b.allFilters,0),d=g.addParameter(d,"session",g.getSession()),d=c(d,b.allFilters.page),a.popupWindow){b=window.screenX||window.screenLeft;g=window.screenY||window.screenTop;var f;f=b+document.body.clientWidth;e=screen.width*a.width/100;a=screen.height*a.height/100;f=b>screen.width-f?b-e-15:f+15;var n=window.screenY?window.screenY:window.screenTop;0>f&&(f=b+100);0>n&&(n=g+100);window.open(d,"_blank","scrollbars=1,resizable=1,left="+f+",top="+n+",width="+e+"px,height="+a+"px")}else window.open(d,e);else a.page?delete b.allFilters.search:b.allFilters.page=1,a=d.id,d=d.type+d.id,g=p.buildReportRequestParameters(a,b.allFilters,b.format,b.token,0),e=RightNow.Url.convertSearchFiltersToParms("",b.allFilters,""),f=g.sf,1===f.page&&(f.search=1),f=RightNow.JSON.stringify(f),n=m.checkCache(d,f),e={key:d,friendly:e},n?(m.restoreCache(e),l.get(d).fire("response",new RightNow.Event.EventObject(null,{data:n,filters:b}))):h("/ci/ajaxRequest/getReportData",{filters:f,report_id:a,r_tok:g.token,format:RightNow.JSON.stringify(g.fmt)},{searchSource:d,allFilters:b,cacheKey:f},e)}else if(g&&"object"===typeof g&&d.id)if(RightNow.Event.fire("evt_searchRequest",new RightNow.Event.EventObject(this,{filters:b})),m.enabled&&!0!==a.newPage){a=e.endpoint;b=k(e,b,g,!0);g=b.filtersToInclude;b=b.params;if(!a)throw Error("An endpoint hasn't been specified");d=d.type+d.id;e=RightNow.JSON.stringify(b);f=m.checkCache(d,e);g={key:d,friendly:RightNow.Url.convertToSegment(g)};f?(m.restoreCache(g),l.get(d).fire("response",new RightNow.Event.EventObject(null,{data:f,filters:b}))):h(a,b,{searchSource:d,allFilters:b,cacheKey:e},g)}else a=RightNow.Url,d=p.getCurrentPage(),b=k(e,b,g,!1).filtersToInclude,d+=a.convertToSegment(b),d=a.addParameter(d,"session",a.getSession()),d=c(d,b.page),window.open(d,"_self")},ajaxCallback:f}}();p={buildReportRequestParameters:function(f,h,k,c,e){var a=RightNow.Lang.cloneObject(h),b;for(b in a)a.hasOwnProperty(b)&&(a[b].filters&&(a[b].filters.report_id=parseInt(f,10)),a[b].data&&delete a[b].data);k||(k={});k.urlParms=RightNow.Url.buildUrlLinkString(h,k.parmList);return{c:e,id:f,sf:a,fmt:k,token:c}},getCurrentPage:function(){var f=window.location,h=f.pathname,f=f.origin||f.protocol+"//"+f.host;return"/"===h||"/app"===h||"/app/"===h?f+"/app/"+RightNow.Interface.getConfig("CP_HOME_URL"):h.split("/").slice(0,RightNow.Url.getParameterSegment()-1).join("/")}};l=function(){function f(c){if(!c||!c.length||2>c.length)throw Error("You're doing it wrong");this.sources=c;this.multiple=!0}var h={},k=RightNow.EventProvider.extend({overrides:{constructor:function(c,e){this.parent();this.Y=c;delete this.data;delete this.baseDomID;delete this.baseSelector;this.searchSource=e;this.instanceID=e.id;this._addEventHandler("search",{pre:function(a){this._params||(this._params={});a instanceof RightNow.Event.EventObject&&(this._originalEventObject=RightNow.Lang.cloneObject(a),this._collectSearchFilters(a),this._params.newPage=a.filters.newPage)},during:function(a){a instanceof RightNow.Event.EventObject&&this._collectSearchFilters(a)},post:function(){var a,b;if(this._excludedFilters)for(a=0;a<this._excludedFilters.length;a++)b=this._excludedFilters[a],this._respondingFilters&&!this._respondingFilters[b]&&(b=this._filters.allFilters[b])&&b.filters&&(b.filters.data[0]?b.filters.data[0]=null:b.filters.data=null);this.fire("send",this._filters,this._params)}})._addEventHandler("send",{pre:function(a){this._originalEventObject||(this._originalEventObject={filters:{page:1,newPage:!1}});this._eventCancelled=!1},during:function(a){!1===a&&(this._eventCancelled=!0)},post:function(a){this._eventCancelled||(this._excludedFilters=[],q.go(this._originalEventObject.filters,this._filters,this._params,this.searchSource,this))}})._addEventHandler("setInitialFilters",{post:function(a){this._setInitialFilters(a)}})._addEventHandler("appendFilter",{post:function(a){this._originalEventObject||(this._originalEventObject=RightNow.Lang.cloneObject(a));this._mergeFilters(a)}})._addEventHandler("excludeFilterFromNextSearch",{post:function(a){this._excludedFilters||(this._excludedFilters=[]);this._excludedFilters.push(a.data.name)}})._addEventHandler("reset").on("reset",function(){var a=(this._filters=RightNow.Lang.cloneObject(this._initialFilters))?this._filters.allFilters:null;this._params&&a&&(this._initialParams&&(this._params=RightNow.Lang.cloneObject(this._initialParams)),this.Y.Object.each(this._params,function(b,c,d){a[c]&&a[c].filters&&"data"in a[c].filters&&(d[c]=a[c].filters.data)}))},this)}},_setFilters:function(c){this._filters=c},_setInitialFilters:function(c){c instanceof RightNow.Event.EventObject&&(this.Y.Object.isEmpty(c.filters)||(this._filters=c.filters,this._initialFilters=RightNow.Lang.cloneObject(c.filters)),this.Y.Object.isEmpty(c.data)||(this._params=c.data,this._initialParams=RightNow.Lang.cloneObject(c.data)))},_mergeFilters:function(c){this._filters.allFilters=this.Y.mix(this._filters.allFilters,c.filters,!0,null,0,!0)},_collectSearchFilters:function(c){c=new RightNow.Event.EventObject({instanceID:c.w_id},RightNow.Lang.cloneObject(c));c.filters.searchName?(this._respondingFilters||(this._respondingFilters={}),this._respondingFilters[c.filters.searchName]=!0,this._filters||(this._filters={}),this._filters.allFilters||(this._filters.allFilters={}),this._filters.allFilters[c.filters.searchName]=c):"generic"===this.searchSource.type&&(this._params=this.Y.mix(this._params||{},c.data,!0))}});f.prototype={_invoke:function(c,e,a,b){for(var f=0;f<this.sources.length;f++)this.sources[f][c](e,a,b);return this},on:function(c,e,a){return this._invoke("on",c,e,a)},fire:function(c,e,a){return this._invoke("fire",c,e,a)}};return{multipleSourcesWrapper:f,get:function(c){return"undefined"===typeof c?h:h[c]},add:function(c,e){if(c&&e instanceof k&&!h[c])return h[c]=e},getSearchSources:function(c,e){var a=c?(c+"").split(","):[],b=e?(e+"").split(","):[],f=[],d;for(d=0;d<a.length;d++)f.push({type:"report",id:a[d]});for(d=0;d<b.length;d++)f.push({type:"generic",id:b[d]});return{report:a,source:b,keys:f}},searchSource:k,findNamedSource:function(c,e){if(e){this.findNamedSource.findSource||(this.findNamedSource.findSource=function(a,b){if(b.multiple)for(var c=0;c<b.sources.length;c++){if(b.sources[c].instanceID===a)return b.sources[c]}else if(b.instanceID===a)return b});this.findNamedSource.warning||(this.findNamedSource.warning=function(a){RightNow.UI.DevelopmentHeader&&RightNow.UI.DevelopmentHeader.addJavascriptWarning(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_D_SRCH_SRC_ID_RPT_ID_SRC_ID_LBL"),a))});var a=[],b=[];if("string"===typeof e||"number"===typeof e){e=(e+"").split(",");if(1<e.length){for(var g=0,d;g<e.length;g++)(d=this.findNamedSource.findSource(e[g],c))?a.push(d):b.push(e[g]);b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}else if(a=this.findNamedSource.findSource(e[0],c))return a;!b.length&&this.findNamedSource.warning(e[0]);return c}if("object"===typeof e){for(g in e)e.hasOwnProperty(g)&&((d=this.findNamedSource.findSource(g,c))?(d=YUI().mix(d,e[g]),a.push(d)):b.push(g));b.length&&this.findNamedSource.warning(b.join(", "));if(a.length)return 1<a.length?new f(a):a[0]}}if(!c)throw Error("The widget extending from RightNow.SearchFilter doesn't have report_id or source_id attributes.");return c}}}();RightNow.SearchFilter=RightNow.Widgets.extend({constructor:function(){for(var f=l.getSearchSources(this.data.attrs.report_id,this.data.attrs.source_id),h=[],k=0,c,e;k<f.keys.length;k++)e=f.keys[k],c=l.get(e.type+e.id),c||(c=new l.searchSource(this.Y,e),l.add(e.type+e.id,c)),h.push(c);1<h.length&&(c=new l.multipleSourcesWrapper(h));this.searchSource=function(a){return l.findNamedSource(c,a)}}});RightNow.ResultsDisplay=RightNow.SearchFilter})();
RightNow.Widgets.ChatPostMessage=RightNow.Widgets.extend({constructor:function(){this.container=this.Y.one(this.baseSelector);this.input=this.Y.one(this.baseSelector+"_Input");this.isOffTheRecord=this.data.attrs.all_posts_off_the_record;this._errorDialog=null;this._vaMode=false;if(this.input)
{RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatSendButtonClickResponse",this.sendText,this);RightNow.Event.subscribe("evt_chatPostLengthExceededResponse",this._onChatPostLengthExceededResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantAddedResponse",this._onChatEngagementParticipantAddedResponse,this);RightNow.Event.subscribe("evt_chatPostResponse",this._onChatPostResponse,this);this.input.on("valueChange",this._onValueChange,this);this.input.on("key",this._onEnterKey,"enter",this);}},_onChatStateChangeResponse:function(type,args)
{if(!RightNow.Event.fire("evt_handleChatStateChange",new RightNow.Event.EventObject(this,{data:args[0].data})))
return;var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED)
{this.input.set('disabled',false);RightNow.UI.show(this.container);if(this.data.attrs.initial_focus&&this.input.focus)
{top.window.focus();this.input.focus();}}
else if(currentState===ChatState.REQUEUED)
{RightNow.UI.hide(this.container);}
else if(currentState===ChatState.CANCELLED||currentState===ChatState.DISCONNECTED||currentState===ChatState.REQUEUED)
{RightNow.UI.hide(this.container);}
else if(currentState===ChatState.RECONNECTING)
{this.input.set('disabled',true);}},_onValueChange:function(e)
{var eo=new RightNow.Event.EventObject(this,{data:{keyEvent:e,inputValue:e.newVal,inputValueBeforeChange:e.prevVal,isOffTheRecord:this.isOffTheRecord}});RightNow.Event.fire("evt_chatPostMessageKeyUpRequest",eo);},_onEnterKey:function(e)
{if(e.shiftKey)
return;if(this.input.get('value')!=='\r\n')
this.sendText();else
this.input.set('value',"");e.preventDefault();if(this.data.attrs.mobile_mode)
this.input.blur();},_onChatPostLengthExceededResponse:function(type,eventObject)
{if(eventObject[0].w_id!==this.instanceID)
return;this.input.set('value',eventObject[0].data.inputValueBeforeChange).set('disabled',true);if(this._errorDialog){this._errorDialog.show();}
else{this._errorDialog=RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("THE_INPUT_IS_TOO_LONG_MSG"),{icon:"WARN",exitCallback:{fn:this._enableControls,scope:this}});}},_enableControls:function()
{this.input.set('disabled',false).focus();},sendText:function()
{var text=this.input.get('value');if(text.replace(/^\s*/,"").length==0||text.length>349525)
return;var c,newText="";for(i=0;i<text.length;i++)
{c=text.charCodeAt(i);if(c<32&&c!==RightNow.UI.KeyMap.LINEFEED&&c!==RightNow.UI.KeyMap.RETURN&&c!==RightNow.UI.KeyMap.TAB)
{newText+="&#00";newText+=(c<10)?"0"+c.toString():c.toString();}
else if(c=='<')
newText+="&lt;";else if(c=='>')
newText+="&gt;";else
newText+=text.substr(i,1);}
text=newText;this.input.set('value',"");if(this._vaMode)
this.input.set('disabled',true);var eo=new RightNow.Event.EventObject(this,{data:{messageBody:text,isEndUserPost:true,isOffTheRecord:this.isOffTheRecord}});RightNow.Event.fire("evt_chatPostMessageRequest",eo);if(!this.data.attrs.mobile_mode)
this.input.focus();},_onChatPostResponse:function(type,args)
{if(!args[0].data.isEndUserPost)
{this.input.set('disabled',false);if(this.data.attrs.focus_on_incoming_messages)
{top.window.focus();this.input.focus();}
else if(this._vaMode)
{this.input.focus();}}},_onChatEngagementParticipantAddedResponse:function(type,args)
{this._vaMode=args[0].data.virtualAgent===undefined?false:args[0].data.virtualAgent;}});
RightNow.Widgets.ChatOffTheRecordDialog=RightNow.Widgets.ChatPostMessage.extend({overrides:{constructor:function(){this.parent();this._dialog=null;this.isOffTheRecord=true;if(this.input)
{RightNow.Event.subscribe("evt_chatOffTheRecordButtonClickResponse",this._onChatOffTheRecordButtonClickResponse,this);}},_onEnterKey:function(e){this.parent(e);this._clearAndHide();},_onChatStateChangeResponse:function(type,args){if(args[0].data.currentState!==RightNow.Chat.Model.ChatState.CONNECTED)
this._clearAndHide();}},_onChatOffTheRecordButtonClickResponse:function(type,args)
{if(!this._dialog)
{var dialogTitle=this.data.attrs.label_window_title;var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._onSend,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._clearAndHide,scope:this}}];var dialogOptions={"buttons":buttons,"alignOn":[{eventName:'resize',node:'win'},{eventName:'scroll',node:'win'}]};this._dialog=RightNow.UI.Dialog.actionDialog(dialogTitle,this.container,dialogOptions);if(this._dialog.cancelEvent)
this._dialog.cancelEvent.subscribe(this._clearAndHide,null,this);this._dialog.validate=function(){return false;};}
RightNow.UI.show(this.container);this._dialog.show();},_onSend:function()
{this.sendText();this._clearAndHide();},_clearAndHide:function()
{if(this._dialog)
{this.input.set('value','');this._dialog.hide();}}});
RightNow.Widgets.ChatDisconnectButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);this._disconnectButton=this.Y.one(this.baseSelector+"_Button");this._currentState=RightNow.Chat.Model.SEARCHING;if(this._container&&this._disconnectButton)
{this._disconnectButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onButtonClick:function(type,args)
{if(this._currentState!==RightNow.Chat.Model.ChatState.DISCONNECTED&&this._currentState!==RightNow.Chat.Model.ChatState.CANCELLED){RightNow.Event.fire("evt_chatHangupRequest",new RightNow.Event.EventObject(this,{data:{}}));}
else{RightNow.Event.fire("evt_chatCloseButtonClickRequest",new RightNow.Event.EventObject(this,{data:{closingUrl:this.data.attrs.close_redirect_url,openInWindow:this.data.attrs.open_in_window}}));}},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var previousState=args[0].data.previousState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED&&previousState!==ChatState.CONNECTED)
{RightNow.UI.show(this._container);}
else if(currentState===ChatState.CANCELLED||currentState===ChatState.DISCONNECTED)
{if(this.data.attrs.mobile_mode||!window.opener)
{RightNow.UI.hide(this._container);}
else
{this._disconnectButton.set('innerHTML',new EJS({text:this.getStatic().templates.closeButton}).render({attrs:this.data.attrs})).set('title',this.data.attrs.label_tooltip_close);}}
this._currentState=currentState;}});
RightNow.Widgets.ChatOffTheRecordButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);this._offTheRecordButton=this.Y.one(this.baseSelector+'_Button');if(this._offTheRecordButton&&this._container)
{this._offTheRecordButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onButtonClick:function(type,args)
{RightNow.Event.fire("evt_chatOffTheRecordButtonClickRequest",new RightNow.Event.EventObject(this));},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED)
RightNow.UI.show(this._container);else if(currentState===ChatState.REQUEUED||currentState===ChatState.DISCONNECTED||currentState===ChatState.RECONNECTING)
RightNow.UI.hide(this._container);}});
RightNow.Widgets.ChatPrintButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);this._printButton=this.Y.one(this.baseSelector+'_Button');if(this._printButton&&this._container)
{this._printButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);this._toggleInProblematicBrowsers(true);}},_onButtonClick:function()
{window.print();},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED)
{RightNow.UI.show(this._container);}
else if(currentState===ChatState.REQUEUED)
{RightNow.UI.hide(this._container);}
else if(currentState===ChatState.DISCONNECTED)
{this._toggleInProblematicBrowsers(false);}},_toggleInProblematicBrowsers:function(disabled)
{var userAgent=navigator.userAgent.toLowerCase();if(userAgent.indexOf('safari')>-1)
{this._printButton.set('disabled',disabled);if(disabled)
{this._printButton.set('title',this.data.attrs.label_print_after_chat);}
else
{this._printButton.set('title',this.data.attrs.label_tooltip);}}}});
RightNow.Widgets.ChatServerConnect=RightNow.Widgets.extend({constructor:function(){this._resumeSessionDialog=null;this._miscellaneousData=null;this._validChatRequest=true;this._connectionStatus=this.Y.one(this.baseSelector+"_ConnectionStatus");this._connectingIconElem=this.Y.one(this.baseSelector+"_ConnectingIcon");this._errorMessageDiv=this.Y.one(this.baseSelector+"_ErrorLocation");if(this.Y.one(this.baseSelector+"_Connector")){RightNow.Event.subscribe("evt_chatEventBusInitializedResponse",this._validateChatParameters,this);RightNow.Event.subscribe("evt_chatConnectResponse",this._onChatConnectResponse,this);RightNow.Event.subscribe("evt_chatFetchUpdateResponse",this._onFetchUpdateResponse,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatSetParametersResponse",this._onChatSetParametersResponse,this);RightNow.Event.subscribe("evt_chatValidateParametersResponse",this._onChatValidateParametersResponse,this);RightNow.Event.subscribe("evt_chatCheckAnonymousResponse",this._onChatCheckAnonymousResponse,this);}
if(RightNow.Chat.UI&&RightNow.Chat.UI.EventBus!==null&&RightNow.Chat.UI.EventBus.isEventBusInitialized!==undefined&&RightNow.Chat.UI.EventBus.isEventBusInitialized())
this._validateChatParameters();},_validateChatParameters:function()
{var eventObject;this._setMiscellaneousData();eventObject=new RightNow.Event.EventObject(this,{data:{email:this.data.js.contactEmail||RightNow.Url.getParameter("Contact.Email.0.Address"),prod:RightNow.Url.getParameter("p"),cat:RightNow.Url.getParameter("c"),miscellaneousData:this._miscellaneousData,customFields:this.data.js.customFields}});RightNow.Event.fire("evt_chatValidateParametersRequest",eventObject);this._checkAnonymousRequest();this._displayErrors();this._setChatParameters();},_onChatValidateParametersResponse:function(type,args)
{var eventObject=args[0];this._validChatRequest=eventObject.data.valid;if(this._validChatRequest)
{return;}
if(!this._errorMessages)
this._errorMessages=[];this._errorMessages.push(this.data.attrs.label_validation_fail);},_checkAnonymousRequest:function()
{if(!this.data.attrs.first_name_required&&!this.data.attrs.last_name_required&&!this.data.attrs.email_required)
return;var eventObject=new RightNow.Event.EventObject(this,{data:{firstName:this.data.js.contactFirstName||RightNow.Url.getParameter("Contact.Name.First")||RightNow.Url.getParameter("contacts.first_name"),firstNameRequired:this.data.attrs.first_name_required,lastName:this.data.js.contactLastName||RightNow.Url.getParameter("Contact.Name.Last")||RightNow.Url.getParameter("contacts.last_name"),lastNameRequired:this.data.attrs.last_name_required,email:this.data.js.contactEmail||RightNow.Url.getParameter("Contact.Email.0.Address")||RightNow.Url.getParameter("contacts.email"),emailRequired:this.data.attrs.email_required}});RightNow.Event.fire("evt_chatCheckAnonymousRequest",eventObject);},_onChatCheckAnonymousResponse:function(type,args)
{var eventObject=args[0];if(!eventObject.data.anonymousRequest)
return;if(!this._errorMessages)
this._errorMessages=[];this._errorMessages.push(this.data.attrs.label_prevent_anonymous_chat);this._validChatRequest=false;},_displayErrors:function()
{if(this._validChatRequest||!this._errorMessages||this._errorMessages.length<=0)
return;var errorMessageList=this.Y.Node.create(new EJS({text:this.getStatic().templates.errorMessageList}).render({errors:this._errorMessages,attrs:this.data.attrs}));this._errorMessageDiv.appendChild(errorMessageList);this._errorMessageDiv.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden").scrollIntoView();RightNow.UI.hide(this._connectionStatus);},_setChatParameters:function()
{if(!this._validChatRequest)
return;var surveyCompID=RightNow.Url.getParameter("survey_comp_id");var surveyTermID=RightNow.Url.getParameter("survey_term_id");var surveyCompAuth=RightNow.Url.getParameter("survey_comp_auth");var surveyTermAuth=RightNow.Url.getParameter("survey_term_auth");var eventObject=new RightNow.Event.EventObject(this,{data:{connectionData:{absentInterval:RightNow.Interface.getConfig("ABSENT_INTERVAL","RNL"),absentRetryCount:RightNow.Interface.getConfig("USER_ABSENT_RETRY_COUNT","RNL"),chatServerHost:RightNow.Interface.getConfig("SRV_CHAT_HOST","RNL"),chatServerPort:RightNow.Interface.getConfig("SERVLET_HTTP_PORT","RNL"),dbName:RightNow.Interface.getConfig("DB_NAME","COMMON"),useHttps:window.location.protocol.indexOf('https:')===0},surveyBaseUrl:this.data.js.maUrl,agentAbsentRetryCount:RightNow.Interface.getConfig("AGENT_ABSENT_RETRY_COUNT","RNL"),terminateChatSessionString:this.data.attrs.label_terminate_session}});if(surveyCompID)
eventObject.data.surveyCompID=surveyCompID;if(surveyTermID)
eventObject.data.surveyTermID=surveyTermID;if(surveyCompAuth)
eventObject.data.surveyCompAuth=surveyCompAuth;if(surveyTermAuth)
eventObject.data.surveyTermAuth=surveyTermAuth;RightNow.Event.fire("evt_chatSetParametersRequest",eventObject);},_onChatSetParametersResponse:function(type,args)
{this._connect();},_connect:function(resume)
{var subject=RightNow.Url.getParameter('Incident.Subject')||RightNow.Url.getParameter("incidents.subject");if(subject===null||subject==='')
subject=this.data.js.postedSubject;var eventObject=new RightNow.Event.EventObject(this,{data:{interfaceID:this.data.js.interfaceID,firstName:this.data.js.contactFirstName||RightNow.Url.getParameter("Contact.Name.First")||RightNow.Url.getParameter("contacts.first_name"),lastName:this.data.js.contactLastName||RightNow.Url.getParameter("Contact.Name.Last")||RightNow.Url.getParameter("contacts.last_name"),email:this.data.js.contactEmail||RightNow.Url.getParameter("Contact.Email.0.Address")||RightNow.Url.getParameter("contacts.email"),contactID:this.data.js.contactID,organizationID:this.data.js.organizationID,subject:subject,prod:this.data.js.postedProduct||RightNow.Url.getParameter("p")||RightNow.Url.getParameter("incidents.prod"),cat:this.data.js.postedCategory||RightNow.Url.getParameter("c")||RightNow.Url.getParameter("incidents.cat"),resume:resume,queueID:RightNow.Url.getParameter("q_id"),requestSource:this.data.js.requestSource,surveySendID:RightNow.Url.getParameter("survey_send_id"),surveySendDelay:RightNow.Url.getParameter("survey_send_delay"),surveySendAuth:RightNow.Url.getParameter("survey_send_auth"),sessionID:this.data.js.sessionID,miscellaneousData:this._miscellaneousData,incidentID:RightNow.Url.getParameter("i_id"),routingData:this.data.js.chat_data||RightNow.Url.getParameter("chat_data"),referrerUrl:this._getReferrerUrl(),coBrowsePremiumSupported:typeof CoBrowseLauncher!=="undefined"&&CoBrowseLauncher.isEnvironmentSupported(CoBrowseLauncher.getEnvironment())?0:1}});RightNow.Event.fire("evt_chatConnectRequest",eventObject);},_setMiscellaneousData:function()
{if(this._miscellaneousData)
return;this._miscellaneousData=[];for(var customFieldID in this.data.js.customFields)
{var customField=this.data.js.customFields[customFieldID],columnName=customField.col_name.split("c$")[1],postedCustomFieldName="Incident_CustomFields_c_"+columnName,urlCustomFieldName="Incident.CustomFields.c."+columnName,url2CustomFieldName="incidents.c$"+columnName,postedCustomFields=this.data.js.postedCustomFields||{},Url=RightNow.Url,customFieldValue=postedCustomFields[postedCustomFieldName]||Url.getParameter(urlCustomFieldName)||Url.getParameter(url2CustomFieldName);if(customFieldValue===null&&(customField.data_type===this.data.js.dateField||customField.data_type===this.data.js.dateTimeField))
{var year=postedCustomFields[postedCustomFieldName+"_year"]||Url.getParameter(urlCustomFieldName+"_year"),month=postedCustomFields[postedCustomFieldName+"_month"]||Url.getParameter(urlCustomFieldName+"_month"),day=postedCustomFields[postedCustomFieldName+"_day"]||Url.getParameter(urlCustomFieldName+"_day"),hour=postedCustomFields[postedCustomFieldName+"_hour"]||Url.getParameter(urlCustomFieldName+"_hour"),minute=postedCustomFields[postedCustomFieldName+"_minute"]||Url.getParameter(urlCustomFieldName+"_minute");if(year!==null)
this._miscellaneousData[urlCustomFieldName]=year||month||day?[[year,month,day].join("-"),hour||minute?[hour,minute].join(":"):""].join(" "):null;continue;}
else if(customField.data_type===this.data.js.radioField)
{customFieldValue=customFieldValue==="true"?"1":customFieldValue==="false"?"0":customFieldValue;}
if(customFieldValue!==null)
this._miscellaneousData[urlCustomFieldName]=customFieldValue;}},_getReferrerUrl:function()
{var referrerUrl;if(this.data.js.referrerUrl!=null)
{referrerUrl=this.data.js.referrerUrl;}
else
{var chatData=RightNow.Text.Encoding.base64Decode(RightNow.Url.getParameter("chat_data"));var dataValues=chatData.split('&');for(var index=0;index<dataValues.length;index++)
{var value=dataValues[index].split('=');if(value[0]==="referrerUrl")
{referrerUrl=decodeURIComponent(value[1]);break;}}
if(!referrerUrl)
{referrerUrl=document.referrer;if(!referrerUrl&&window.opener&&window.opener.location)
{try
{referrerUrl=window.opener.location.href;}
catch(e)
{}}}}
return referrerUrl;},_onChatConnectResponse:function(type,args)
{var eventObject=args[0];var messageElement=this.Y.one(this.baseSelector+"_Message");RightNow.UI.hide(this._connectingIconElem);if(eventObject.data.connected)
{if(messageElement)
messageElement.set("innerHTML",this.data.attrs.label_connection_success);}
else if(messageElement)
{messageElement.set("innerHTML",this.data.attrs.label_connection_fail);}
if(eventObject.data.connected&&eventObject.data.existingSession)
{this._displayResumeSessionDialog();return;}
if(eventObject.data.connected)
{this._fetchUpdate();}},_displayResumeSessionDialog:function()
{var buttons=[{text:RightNow.Interface.getMessage("OK_LBL"),handler:{fn:this._resumeSession,scope:this},isDefault:true},{text:RightNow.Interface.getMessage("CANCEL_LBL"),handler:{fn:this._startNewSession,scope:this},isDefault:false}];var dialogBody=this.Y.Node.create("<div>").addClass("rn_dialogLeftAlign").addClass("rn_ChatResumeSessionDialog").set("innerHTML",RightNow.Interface.getMessage("EXISTING_CHAT_SESS_FND_RESUME_SESS_MSG"));this._resumeSessionDialog=RightNow.UI.Dialog.actionDialog(RightNow.Interface.getMessage("EXISTING_CHAT_SESSION_LBL"),dialogBody,{"buttons":buttons});RightNow.UI.Dialog.addDialogEnterKeyListener(this._resumeSessionDialog,this._resumeSession,this);this._resumeSessionDialog.show();},_resumeSession:function()
{this._resumeSessionDialog.hide();this._connect(true);},_startNewSession:function()
{this._resumeSessionDialog.hide();this._connect(false);},_fetchUpdate:function()
{RightNow.Event.fire("evt_chatFetchUpdateRequest",new RightNow.Event.EventObject(this,{data:{}}));},_onFetchUpdateResponse:function()
{this._fetchUpdate();},_onChatStateChangeResponse:function(type,args)
{RightNow.UI.hide(this.baseSelector);}});
RightNow.Widgets.ChatEngagementStatus=RightNow.Widgets.extend({constructor:function(){this._currentState=null;this._previousState=null;this._reason=null;this._widgetElement=this.Y.one(this.baseSelector);if(this.Y.UA.ie>0&&this.Y.UA.ie<=8)
{this._onChatStateChangeResponse(null,[{'data':{'currentState':RightNow.Chat.Model.ChatState.DISCONNECTED,'reason':RightNow.Chat.Model.ChatDisconnectReason.BROWSER_UNSUPPORTED}}]);return;}
if(this._widgetElement)
RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);},_onChatStateChangeResponse:function(type,args)
{this._currentState=args[0].data.currentState;this._previousState=args[0].data.previousState;this._reason=args[0].data.reason;this._updateStatus();RightNow.UI.show(this._widgetElement);this._updateSearchingDetail();this._updateRequeuedDetail();this._updateCanceledDetail();},_updateStatus:function()
{var statusElement=this.Y.one(this.baseSelector+"_Status");if(!statusElement)
return;var ChatState=RightNow.Chat.Model.ChatState;switch(this._currentState)
{case ChatState.SEARCHING:case ChatState.REQUEUED:{statusElement.set("innerHTML",this.data.attrs.label_status_searching);break;}
case ChatState.CONNECTED:{statusElement.set("innerHTML",this.data.attrs.label_status_connected);break;}
case ChatState.RECONNECTING:{if(this._previousState===RightNow.Chat.Model.CONNECTED)
statusElement.set("innerHTML",this.data.attrs.label_status_reconnecting);break;}
case ChatState.CANCELLED:case ChatState.DEQUEUED:{statusElement.set("innerHTML",this.data.attrs.label_status_canceled);break;}
case ChatState.DISCONNECTED:{if(this._reason&&this._reason==='RECONNECT_FAILED')
statusElement.set("innerHTML",RightNow.Interface.getMessage("COMM_RN_LIVE_SERV_LOST_CHAT_SESS_MSG"));else
statusElement.set("innerHTML",this.data.attrs.label_status_disconnected);break;}}},_updateSearchingDetail:function()
{var searchingDetailElement=this.Y.one(this.baseSelector+"_Searching");if(!searchingDetailElement)
return;var ChatState=RightNow.Chat.Model.ChatState;if(this._currentState===ChatState.RECONNECTING)
return;if(this._currentState==ChatState.SEARCHING||this._currentState==ChatState.REQUEUED)
{RightNow.UI.show(searchingDetailElement);}
else
{RightNow.UI.hide(searchingDetailElement);}},_updateRequeuedDetail:function()
{var requeuedDetailElement=this.Y.one(this.baseSelector+"_Requeued");if(!requeuedDetailElement)
return;var ChatState=RightNow.Chat.Model.ChatState;if(this._currentState===ChatState.RECONNECTING)
return;if(this._currentState==ChatState.REQUEUED)
RightNow.UI.show(requeuedDetailElement);else
RightNow.UI.hide(requeuedDetailElement);},_updateCanceledDetail:function()
{var canceledUserDetailElement=this.Y.one(this.baseSelector+"_Canceled_User");var canceledSelfServiceDetailElement=this.Y.one(this.baseSelector+"_Canceled_Self_Service");var canceledNoAgentsAvailDetailElement=this.Y.one(this.baseSelector+"_Canceled_NoAgentsAvail");var canceledQueueTimeoutDetailElement=this.Y.one(this.baseSelector+"_Canceled_Queue_Timeout");var canceledDequeuedDetailElement=this.Y.one(this.baseSelector+"_Canceled_Dequeued");var canceledBrowserDetailElement=this.Y.one(this.baseSelector+"_Canceled_Browser");var ChatState=RightNow.Chat.Model.ChatState;var ChatDisconnectReason=RightNow.Chat.Model.ChatDisconnectReason;if(this._currentState===ChatState.RECONNECTING)
return;if(this._currentState==ChatState.CANCELLED)
{if(canceledUserDetailElement&&this._reason===ChatDisconnectReason.ENDED_USER_CANCEL)
RightNow.UI.show(canceledUserDetailElement);else if(canceledSelfServiceDetailElement&&this._reason===ChatDisconnectReason.ENDED_USER_DEFLECTED)
RightNow.UI.show(canceledSelfServiceDetailElement);else if(canceledNoAgentsAvailDetailElement&&this._reason===ChatDisconnectReason.FAIL_NO_AGENTS_AVAIL)
RightNow.UI.show(canceledNoAgentsAvailDetailElement);else if(canceledQueueTimeoutDetailElement&&this._reason===ChatDisconnectReason.QUEUE_TIMEOUT)
RightNow.UI.show(canceledQueueTimeoutDetailElement);}
else if(this._currentState==ChatState.DEQUEUED&&canceledDequeuedDetailElement)
{RightNow.UI.show(canceledDequeuedDetailElement);}
else if(this._currentState===ChatState.DISCONNECTED&&this._reason===ChatDisconnectReason.NO_AGENTS_AVAILABLE&&canceledUserDetailElement)
{RightNow.UI.show(canceledNoAgentsAvailDetailElement);}
else if(this._currentState===ChatState.DISCONNECTED&&typeof ChatDisconnectReason.BROWSER_UNSUPPORTED!=='undefined'&&this._reason===ChatDisconnectReason.BROWSER_UNSUPPORTED&&canceledBrowserDetailElement)
{RightNow.UI.show(canceledBrowserDetailElement);}
else
{if(canceledUserDetailElement)
RightNow.UI.hide(canceledUserDetailElement);if(canceledSelfServiceDetailElement)
RightNow.UI.hide(canceledSelfServiceDetailElement);if(canceledNoAgentsAvailDetailElement)
RightNow.UI.hide(canceledNoAgentsAvailDetailElement);if(canceledQueueTimeoutDetailElement)
RightNow.UI.hide(canceledQueueTimeoutDetailElement);if(canceledDequeuedDetailElement)
RightNow.UI.hide(canceledDequeuedDetailElement);}}});
RightNow.Widgets.ChatQueueWaitTime=RightNow.Widgets.extend({constructor:function(){RightNow.Event.subscribe("evt_chatEventBusInitializedResponse",this._initialize,this);this._estimatedWaitTimeDisplayed=false;this._queueWaitTimeContainer=this.Y.one(this.baseSelector);this._queuePositionElement=this.Y.one(this.baseSelector+"_QueuePosition");this._estimatedWaitTimeElement=this.Y.one(this.baseSelector+"_EstimatedWaitTime");this._averageWaitTimeElement=this.Y.one(this.baseSelector+"_AverageWaitTime");this._leaveScreenWarningElement=this.Y.one(this.baseSelector+"_BrowserWarning");if(this._queuePositionElement||this._estimatedWaitTimeElement||this._averageWaitTimeElement){RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatQueuePositionNotificationResponse",this._onChatQueuePositionNotificationResponse,this);}
this._displayQueuePosition=this._queuePositionElement&&(this.data.attrs.type==='position'||this.data.attrs.type==='all');this._displayEstimatedWaitTime=this._estimatedWaitTimeElement&&(this.data.attrs.type==='estimated'||this.data.attrs.type==='all');this._displayAverageWaitTime=this._averageWaitTimeElement&&(this.data.attrs.type==='average'||this.data.attrs.type==='all');if(RightNow.Chat.UI&&RightNow.Chat.UI.EventBus!==null&&RightNow.Chat.UI.EventBus.isEventBusInitialized!==undefined&&RightNow.Chat.UI.EventBus.isEventBusInitialized())
this._initialize();},_initialize:function()
{var uiUtils=RightNow.Chat.UI.Util;this._queuePositionMsg=uiUtils.doPositionAndWaitTimeVariableSubstitution(this.data.attrs.label_queue_position,this.instanceID+"_QueuePosition",RightNow.Interface.getConfig("ESTIMATED_WAIT_TIME_SAMPLES","RNL"));this._estimatedWaitTimeMsg=uiUtils.doPositionAndWaitTimeVariableSubstitution(this.data.attrs.label_estimated_wait_time,this.instanceID+"_EstimatedWaitTime",RightNow.Interface.getConfig("ESTIMATED_WAIT_TIME_SAMPLES","RNL"));this._averageWaitTimeMsg=uiUtils.doPositionAndWaitTimeVariableSubstitution(this.data.attrs.label_average_wait_time,this.instanceID+"_AverageWaitTime",RightNow.Interface.getConfig("ESTIMATED_WAIT_TIME_SAMPLES","RNL"));if(uiUtils.hasLeaveScreenIssues())
RightNow.UI.show(this._leaveScreenWarningElement);},_onChatStateChangeResponse:function(type,args)
{if(args[0].data.currentState===RightNow.Chat.Model.ChatState.SEARCHING||args[0].data.currentState===RightNow.Chat.Model.ChatState.REQUEUED)
{this._estimatedWaitTimeDisplayed=false;if(this._displayQueuePosition)
{this._queuePositionElement.set('innerHTML',this.data.attrs.label_queue_position_not_available);RightNow.UI.show(this._queuePositionElement);}
if(this._displayEstimatedWaitTime)
{this._estimatedWaitTimeElement.set('innerHTML',this.data.attrs.label_estimated_wait_time_not_available);RightNow.UI.show(this._estimatedWaitTimeElement);}
if(this._displayAverageWaitTime)
{this._averageWaitTimeElement.set('innerHTML',this.data.attrs.label_average_wait_time_not_available);RightNow.UI.show(this._averageWaitTimeElement);}
RightNow.UI.show(this._queueWaitTimeContainer);}
else if(args[0].data.currentState===RightNow.Chat.Model.ChatState.RECONNECTING)
{return;}
else
{RightNow.UI.hide(this._queueWaitTimeContainer);}},_onChatQueuePositionNotificationResponse:function(type,args){this._updateQueuePosition(args[0].data.position);this._updateEstimatedWaitTime(args[0].data.expectedWaitSeconds);this._updateAverageWaitTime(args[0].data.averageWaitSeconds);},_updateQueuePosition:function(position)
{if(this._displayQueuePosition)
{this._updateQueuePositionMessage(position);this._updateQueuePositionValue(position);}},_updateQueuePositionMessage:function(position)
{this._queuePositionElement.set('innerHTML',position>0?this._queuePositionMsg:this.data.attrs.label_queue_position_not_available);},_updateQueuePositionValue:function(position)
{var queuePositionValueElem=this.Y.one(this.baseSelector+"_QueuePosition_QueuePosition");if(!queuePositionValueElem)
return;queuePositionValueElem.set('innerHTML',position>0?position:"");},_updateEstimatedWaitTime:function(estimatedWaitSeconds)
{if(this._displayEstimatedWaitTime)
{this._updateEstimatedWaitTimeMessage(estimatedWaitSeconds);this._updateEstimatedWaitTimeValue(estimatedWaitSeconds);}},_updateEstimatedWaitTimeMessage:function(estimatedWaitSeconds)
{if(estimatedWaitSeconds>0)
{this._estimatedWaitTimeDisplayed=true;this._estimatedWaitTimeElement.set('innerHTML',this._estimatedWaitTimeMsg);}
else
{this._estimatedWaitTimeElement.set('innerHTML',(estimatedWaitSeconds==0&&!this._estimatedWaitTimeDisplayed?this.data.attrs.label_estimated_wait_time_not_available:this.data.attrs.label_estimated_wait_time_exceeded));}},_updateEstimatedWaitTimeValue:function(estimatedWaitSeconds)
{var estimatedWaitTimeValueElem=this.Y.one(this.baseSelector+"_EstimatedWaitTime_EstimatedWaitTime");if(!estimatedWaitTimeValueElem)
return;estimatedWaitTimeValueElem.set('innerHTML',estimatedWaitSeconds>0?RightNow.Chat.UI.Util.toIso8601Time(estimatedWaitSeconds):"");},_updateAverageWaitTime:function(averageWaitSeconds)
{if(this._displayAverageWaitTime)
{this._updateAverageWaitTimeMessage(averageWaitSeconds);this._updateAverageWaitTimeValue(averageWaitSeconds);}},_updateAverageWaitTimeMessage:function(averageWaitSeconds)
{this._averageWaitTimeElement.set('innerHTML',averageWaitSeconds>0?this._averageWaitTimeMsg:this.data.attrs.label_average_wait_time_not_available);},_updateAverageWaitTimeValue:function(averageWaitSeconds)
{var averageWaitTimeValueElem=this.Y.one(this.baseSelector+"_AverageWaitTime_AverageWaitTime");if(!averageWaitTimeValueElem)
return;averageWaitTimeValueElem.set('innerHTML',averageWaitSeconds>0?RightNow.Chat.UI.Util.toIso8601Time(averageWaitSeconds):"");}});
RightNow.Widgets.ChatAgentStatus=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);this._roster=this.Y.one(this.baseSelector+"_Roster");if(this._container&&this._roster)
{RightNow.Event.subscribe("evt_chatAgentStatusChangeResponse",this._onChatAgentStatusChangeResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantAddedResponse",this._onChatEngagementParticipantAddedResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantRemovedResponse",this._onChatEngagementParticipantRemovedResponse,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onChatEngagementParticipantAddedResponse:function(type,args)
{if(!args[0].data.agent)
return;var agent=args[0].data.agent;this._roster.appendChild(this.Y.Node.create(new EJS({text:this.getStatic().templates.participantAddedResponse}).render({attrs:this.data.attrs,instanceID:this.instanceID,agentName:this.data.attrs.agent_id.replace(/{display_name}/g,agent.name),clientID:agent.clientID})));this._roster.setAttribute('aria-live','polite');RightNow.UI.show(this._container);},_onChatEngagementParticipantRemovedResponse:function(type,args)
{if(!args[0].data.agent)
return;var agent=args[0].data.agent;var element=this.Y.one(this.baseSelector+'_Agent_'+agent.clientID);if(element)
element.remove();},_onChatAgentStatusChangeResponse:function(type,args)
{if(!args[0].data.agent)
return;var agent=args[0].data.agent;var newStatusString="";switch(agent.activityStatus)
{case RightNow.Chat.Model.ChatActivityState.RESPONDING:newStatusString=this.data.attrs.label_status_responding;break;case RightNow.Chat.Model.ChatActivityState.LISTENING:newStatusString=this.data.attrs.label_status_listening;break;case RightNow.Chat.Model.ChatActivityState.ABSENT:newStatusString=this.data.attrs.label_status_absent;break;}
var statusElement=this.Y.one(this.baseSelector+'_AgentStatus_'+agent.clientID);if(statusElement)
{statusElement.setHTML(agent.name+"&nbsp;("+newStatusString+")");}},_onChatStateChangeResponse:function(type,args)
{if(!args[0].data.currentState)
return;var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CANCELLED||currentState===ChatState.DISCONNECTED||currentState===ChatState.REQUEUED)
RightNow.UI.hide(this._container);}});
RightNow.Widgets.ChatTranscript=RightNow.Widgets.extend({constructor:function(){this._transcriptContainer=this.Y.one(this.baseSelector);this._transcript=this.Y.one(this.baseSelector+'_Transcript');this._anchorRE=new RegExp(/(<a .*?>(.*?)<\/a>)/i);this._hrefRE=new RegExp(/href\s*=\s*['"](.+?)['"]/i);this._titleRE=new RegExp(/title\s*=\s*['"](.+?)['"]/i);this._urlRE=new RegExp(/((http[s]?:\/\/|ftp:\/\/)|(www\.)|(ftp\.))([^\s<>\.\/^{^}]+)\.([^\s<>^{^}]+)/i);this._quotedUrlRE=new RegExp(/['"]+((http[s]?:\/\/|ftp:\/\/)|(www\.)|(ftp\.))([^\s<>\.\/]+)\.([^\s<>]+)['"]+/i);this._tagRE=new RegExp(/(<\/?[\w]+[^>]*>)/i);this._endUserName='';if(this._transcript)
{if(!this.data.attrs.mobile_mode)
{RightNow.Event.subscribe("evt_chatCobrowseAcceptResponse",this._coBrowseAcceptResponse,this);RightNow.Event.subscribe("evt_chatCobrowseStatusResponse",this._coBrowseStatusResponse,this);RightNow.Event.subscribe("evt_fileUploadUpdateResponse",this._fileUploadResponse,this);RightNow.Event.subscribe("evt_chatNotifyFattachUpdateResponse",this._fileNotifyResponse,this);}
RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatPostResponse",this._onChatPostResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantAddedResponse",this._onChatEngagementParticipantAddedResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantRemovedResponse",this._onChatEngagementParticipantRemovedResponse,this);RightNow.Event.subscribe("evt_chatEngagementConcludedResponse",this._onChatEngagementConcludedResponse,this);RightNow.Event.subscribe("evt_chatCobrowseInvitationResponse",this._coBrowseInvitationResponse,this);RightNow.Event.subscribe("evt_chatCoBrowsePremiumInvitationResponse",this._coBrowsePremiumInvitationResponse,this);RightNow.Event.subscribe("evt_chatReconnectUpdateResponse",this._reconnectUpdateResponse,this);RightNow.Event.subscribe("evt_chatAgentAbsentUpdateResponse",this._agentAbsentUpdateResponse,this);RightNow.Event.subscribe("evt_chatAgentStatusChangeResponse",this._onAgentStatusChangeResponse,this);RightNow.Event.subscribe("evt_chatPostCompletion",this._onChatPostCompletion,this);RightNow.Event.subscribe("evt_chatCoBrowsePremiumAcceptResponse",this._coBrowseAcceptResponse,this);this._preloadImages();this._transcript.setAttribute("aria-live","polite").setAttribute("role","log");}
if(this.data.attrs.unread_messages_titlebar_enabled)
{this._unreadCount=0;this._windowFocused=document.hasFocus?document.hasFocus():false;this._baseTitle=document.title;var Event=this.Y.Event;if(this.Y.UA.ie>0)
{Event.attach("focusin",this._onApplicationFocus,document,this);Event.attach("focusout",this._onApplicationBlur,document,this);}
else
{Event.attach("focus",this._onApplicationFocus,window,this);Event.attach("blur",this._onApplicationBlur,window,this);}}},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var previousState=args[0].data.previousState;var ChatState=RightNow.Chat.Model.ChatState;var newMessage=null;if(currentState===ChatState.CONNECTED)
RightNow.UI.show(this._transcriptContainer);else if(currentState===ChatState.RECONNECTING)
{this._stateBeforeReconnect=previousState;if(previousState===ChatState.CONNECTED)
newMessage=RightNow.Interface.getMessage("COMM_RN_LIVE_SERV_LOST_PLS_WAIT_MSG");}
else if(currentState===ChatState.DISCONNECTED&&(args[0].data.reason==='RECONNECT_FAILED'||args[0].data.reason==='ERROR'))
newMessage=RightNow.Interface.getMessage("COMM_RN_LIVE_SERV_LOST_CHAT_SESS_MSG");if(currentState===ChatState.CONNECTED&&previousState===ChatState.RECONNECTING)
newMessage=RightNow.Interface.getMessage("CONNECTION_RESUMED_MSG");if(newMessage!==null)
{this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[newMessage],context:null});}},_onChatEngagementParticipantAddedResponse:function(type,args)
{var agent=args[0].data.agent;var role=args[0].data.role;var message="";if(role==="LEAD")
{if(RightNow.Chat.UI.Util.hasLeaveScreenIssues())
{this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[this.data.attrs.label_leave_screen_warning],context:null});}
message=': '+agent.greeting;}
else
{message=' '+this.data.attrs.label_has_joined_chat;}
this._appendEJSToChat(this.getStatic().templates.participantAddedResponse,{attrs:this.data.attrs,agentName:this._getAgentIdString(args[0].data.agent.name),role:role,message:message});},_onChatEngagementParticipantRemovedResponse:function(type,args)
{var reason=args[0].data.reason;var agent=args[0].data.agent;if(!agent)
return;this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[this._getAgentIdString(agent.name),(args[0].data.reason===RightNow.Chat.Model.ChatDisconnectReason.TRANSFERRED_TO_QUEUE?this.data.attrs.label_has_disconnected:this.data.attrs.label_has_left_chat)],context:null});},_onChatPostResponse:function(type,args)
{var message=args[0].data.messageBody;var messageId=args[0].data.messageId;var isEndUserPost=args[0].data.isEndUserPost;var postID;var name;if(args[0].data.richText===undefined||args[0].data.richText===false)
message=this.Y.Escape.html(message).replace(/\n/g,"<br/>");else if(!this.data.attrs.mobile_mode)
message=this._formatLinks(message);if(args[0].data.isOffTheRecord)
message=this.data.attrs.label_off_the_record+' '+message;if(args[0].data.isEndUserPost)
{postID='eup_'+messageId;this._setEndUserName(args);name=this._endUserName;}
else
{postID=args[0].data.serviceFinishTime;name=this._getAgentIdString(args[0].data.agent.name);}
this._appendEJSToChat(this.getStatic().templates.chatPostResponse,{attrs:this.data.attrs,endUserName:name,agentName:name,message:message,context:args[0].data},postID);},_setEndUserName:function(args)
{if(!this._endUserName||this._endUserName==='')
{var endUser=args[0].data.endUser;if(endUser.firstName===null&&endUser.lastName===null)
{if(endUser.email===null)
this._endUserName=this.data.attrs.label_enduser_name_default_prefix;else
this._endUserName=endUser.email;}
else
{if(endUser.firstName!==null&&endUser.lastName!==null)
{var internationalNameOrder=RightNow.Interface.getConfig("intl_nameorder","COMMON");this._endUserName=internationalNameOrder?endUser.lastName+" "+endUser.firstName:endUser.firstName+" "+endUser.lastName;}
else if(endUser.firstName!==null)
{this._endUserName=endUser.firstName;}
else
{this._endUserName=endUser.lastName;}
this._endUserName+=RightNow.Interface.getMessage("NAME_SUFFIX_LBL");this._endUserName=this._endUserName.replace(/</g,"&lt;");this._endUserName=this._endUserName.replace(/>/g,"&gt;");}}},_onChatPostCompletion:function(type,args)
{var messageId=args[0];var timestamp=args[1];var post=this.Y.one('#eup_'+messageId);var insertNode;if(post)
{post.set('id',timestamp);if(post.previous()&&post.previous().get('id')>timestamp)
{insertNode=post.previous();post.remove();insertNode.insert(post,"before");}
else if(post.next()&&post.next().id<timestamp)
{insertNode=post.next();post.remove();insertNode.insert(post,"after");}}},_onChatEngagementConcludedResponse:function(type,args)
{var agent=args[0].data.agent;var messages=[];var context=null;if(args[0].data.isUserDisconnect)
{if(args[0].data.reason==='IDLE_TIMEOUT')
messages.push(RightNow.Interface.getMessage("DISCONNECTED_CHAT_DUE_INACTIVITY_MSG"));else
{messages.push(this.data.attrs.label_you);messages.push(this.data.attrs.label_have_disconnected);context=args[0].data;}}
else
{messages.push(agent.name);messages.push(this.data.attrs.label_has_disconnected);}
this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:messages,context:context});},_fileNotifyResponse:function(type,args)
{this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[this.data.attrs.label_file_attachment_started],context:null});},_fileUploadResponse:function(type,args)
{var attachmentInfo=args[0];var message="";if(attachmentInfo.error!==0||attachmentInfo.errorMessage)
{message=this.data.attrs.label_file_attachment_error;}
else
{var fileName=attachmentInfo.name;var fileSize=Math.round((attachmentInfo.size/1024)*100)/100;message=this.data.attrs.label_file_attachment_received.replace("{0}",fileName).replace("{1}",fileSize+'KB');}
this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[message],context:null});},_agentAbsentUpdateResponse:function(type,args)
{if(args[0].data.requeueSeconds)
this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[RightNow.Interface.getMessage("REQUEUED_APPROXIMATELY_0_MSG").replace("{0}",args[0].data.requeueSeconds)],context:null});},_coBrowseInvitationResponse:function(type,args)
{var CoBrowseTypes=RightNow.Chat.Model.ChatCoBrowseType;var type=args[0].data.modeType;var coBrowseUrl=args[0].data.coBrowseUrl;var agent=args[0].data.agent;if(this.data.attrs.mobile_mode)
{RightNow.Widgets.ChatTranscript.sendCoBrowseResponse(false);}
else
{var message="";if(type===CoBrowseTypes.SCREEN||type===CoBrowseTypes.SCREEN_POINTER)
message=this.data.attrs.label_agent_requesting_view_desktop;else
message=this.data.attrs.label_agent_requesting_control_desktop;this._appendEJSToChat(this.getStatic().templates.cobrowseInvitationResponse,{attrs:this.data.attrs,message:message,agentName:agent.name,url:coBrowseUrl});}},_coBrowsePremiumInvitationResponse:function(type,args)
{if(this.data.attrs.mobile_mode)
{RightNow.Widgets.ChatTranscript.sendCoBrowseResponse(false);return;}
var agentEnvironment=args[0].data.agentEnvironment;var coBrowseSessionId=args[0].data.coBrowseSessionId;var agent=args[0].data.agent;this._appendEJSToChat(this.getStatic().templates.CoBrowsePremiumInvitationResponse,{attrs:this.data.attrs,message:this.data.attrs.label_agent_requesting_view_desktop,agentName:agent.name,agentEnvironment:agentEnvironment,coBrowseSessionId:coBrowseSessionId});this.Y.one(this.baseSelector).delegate('click',this.onAllowCoBrowsePremiumClick,'a.rn_CoBrowsePremiumAllow',this);this.Y.one(this.baseSelector).delegate('click',this.onDeclineCoBrowsePremiumClick,'a.rn_CoBrowsePremiumDecline',this);},_coBrowseAcceptResponse:function(type,args)
{var accepted=args[0].data.accepted;var message="";this._transcript.all('.rn_CoBrowseAction').remove();if(accepted)
message=this.data.attrs.label_initializing_screen_sharing_session;else
message=this.data.attrs.label_screen_sharing_session_declined;this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[message],context:null});},_coBrowseStatusResponse:function(type,args)
{var ChatCoBrowseStatusCode=RightNow.Chat.Model.ChatCoBrowseStatusCode;var coBrowseStatus=args[0].data.coBrowseStatus;var message="";switch(coBrowseStatus)
{case ChatCoBrowseStatusCode.STARTED:message=this.data.attrs.label_screen_sharing_session_started;break;case ChatCoBrowseStatusCode.STOPPED:message=this.data.attrs.label_screen_sharing_session_ended;break;case ChatCoBrowseStatusCode.ERROR:var errorCode=parseInt(args[0].data.coBrowseData[0],10);if(errorCode===0)
message=this.data.attrs.label_java_not_detected;else if(errorCode===1)
message=this.data.attrs.label_java_cert_rejected;break;}
this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[message],context:null});},_reconnectUpdateResponse:function(type,args)
{if(this._stateBeforeReconnect===RightNow.Chat.Model.ChatState.CONNECTED)
this._appendEJSToChat(this.getStatic().templates.systemMessage,{attrs:this.data.attrs,messages:[RightNow.Interface.getMessage("DISCONNECTION_IN_0_SECONDS_MSG").replace("{0}",args[0].data.secondsLeft)],context:null});},_onAgentStatusChangeResponse:function(type,args)
{var agent=args[0].data.agent;if(!agent)
return;var message=null;if(agent.activityStatus===RightNow.Chat.Model.ChatActivityState.ABSENT)
message=RightNow.Interface.getMessage("COMM_DISP_NAME_LOST_PLS_WAIT_MSG");else if(args[0].data.previousState===RightNow.Chat.Model.ChatActivityState.ABSENT)
message=RightNow.Interface.getMessage("COMM_DISPLAY_NAME_RESTORED_MSG");if(message!==null)
this._appendEJSToChat(this.getStatic().templates.agentStatusChangeResponse,{attrs:this.data.attrs,message:message,agentName:agent.name});},_preloadImages:function()
{var imageArray=[];imageArray.push(this.data.attrs.alert_icon_path);imageArray.push(this.data.attrs.agent_message_icon_path);imageArray.push(this.data.attrs.off_the_record_icon_path);if(!this.data.attrs.mobile_mode)
imageArray.push(this.data.attrs.cobrowse_icon_path);if(this.data.attrs.enduser_message_icon_path)
imageArray.push(this.data.attrs.enduser_message_icon_path);for(var x=0;x<imageArray.length;x++)
eval("var imageObject"+x+" = new Image(); imageObject"+x+".src = imageArray[x];");},_appendEJSToChat:function(postText,postData,postID)
{var newEntry=this.Y.Node.create(new EJS({text:postText}).render(postData));if(postID!==undefined)
newEntry.set("id",postID);this._transcript.appendChild(newEntry);var scrollAnim=new this.Y.Anim({node:this._transcriptContainer,to:{scroll:function(node){return[0,node.get('scrollHeight')]}}}).run();if(this.data.attrs.unread_messages_titlebar_enabled&&!this._windowFocused)
document.title='('+(++this._unreadCount)+') '+this._baseTitle;},_formatLinks:function(text)
{var newText='';var stringArray;var tempString=text;var titles={};var hrefs={};var descs={};var tags={};var quotedUrls={};var aMatches=0;var qMatches=0;var tMatches=0;var anchorMatch="";while(anchorMatch=tempString.match(this._anchorRE))
{descs[aMatches]=anchorMatch[2];stringArray=tempString.split(anchorMatch[0]);var title=anchorMatch[0].match(this._titleRE);if(title!=null)
titles[aMatches]=title[1];href=hrefs[aMatches]=anchorMatch[0].match(this._hrefRE);if(href!=null)
{hrefs[aMatches]=href[1];if(!hrefs[aMatches].match(/^(http(s)?)/i))
hrefs[aMatches]="http://"+hrefs[aMatches];newText+=stringArray[0]+"{RNTAMATCH"+aMatches+"}";aMatches++;}
if(stringArray.length>0)
{stringArray.shift();tempString=stringArray.join(anchorMatch[0]);}}
if(aMatches!==0)
{newText+=tempString;tempString=newText;newText="";}
while(urlMatch=tempString.match(this._tagRE))
{tags[tMatches]=urlMatch[0];tempString=tempString.replace(urlMatch[0],"{RNTTMATCH"+tMatches+"}");tMatches++;}
var urlMatch="";while(urlMatch=tempString.match(this._quotedUrlRE))
{quotedUrls[qMatches]=urlMatch[0];tempString=tempString.replace(urlMatch[0],"{RNTQMATCH"+qMatches+"}");qMatches++;}
while(urlMatch=tempString.match(this._urlRE))
{var href=urlMatch[0];stringArray=tempString.split(urlMatch[0]);if(urlMatch[0].match(/^ftp\./i))
href="ftp://"+urlMatch[0];else if(!urlMatch[0].match(/^(http(s)?|ftp)/i))
href="http://"+urlMatch[0];var replace="<a href='"+href+"' target='_blank'>"+urlMatch[0]+"</a>";newText+=stringArray[0]+replace;if(stringArray.length>0)
{stringArray.shift();tempString=stringArray.join(urlMatch[0]);}}
newText+=tempString;if(qMatches>0)
{for(var x=0;x<qMatches;x++)
newText=newText.replace("{RNTQMATCH"+x+"}",quotedUrls[x]);}
if(tMatches>0)
{for(var x=0;x<tMatches;x++)
newText=newText.replace("{RNTTMATCH"+x+"}",tags[x]);}
if(aMatches>0)
{for(var x=0;x<aMatches;x++)
{if(this.data.attrs.mobile_mode)
newText=newText.replace("{RNTAMATCH"+x+"}",descs[x]==null?hrefs[x]:descs[x]+' ('+hrefs[x]+')');else
newText=newText.replace("{RNTAMATCH"+x+"}","<a href='"+hrefs[x]+"' "+(titles[x]==null?"":"title=\""+titles[x]+"\" ")+" target=\"_blank\">"+(descs[x]==null?hrefs[x]:descs[x])+"</a>");}}
return newText;},_getAgentIdString:function(agentName)
{return this.data.attrs.agent_id.replace(/{display_name}/g,agentName);},_onApplicationFocus:function()
{this._windowFocused=true;this._unreadCount=0;document.title=this._baseTitle;},_onApplicationBlur:function()
{this._windowFocused=false;},onAllowCoBrowsePremiumClick:function(e)
{e.halt();var target=e.currentTarget,agentEnvironment=target.getAttribute('data-agentEnvironment'),coBrowseSessionId=target.getAttribute('data-coBrowseSessionId');RightNow.Widgets.ChatTranscript.sendCoBrowsePremiumResponse(true,agentEnvironment,coBrowseSessionId);},onDeclineCoBrowsePremiumClick:function()
{RightNow.Widgets.ChatTranscript.sendCoBrowsePremiumResponse(false);}},{sendCoBrowseResponse:function(accepted,coBrowseUrl)
{var eo=new RightNow.Event.EventObject(this,{data:{}});if(accepted)
{eo.data={coBrowseUrl:coBrowseUrl};RightNow.Event.fire('evt_chatCoBrowseAcceptRequest',eo);}
else
{RightNow.Event.fire('evt_chatCoBrowseDenyRequest',eo);}},sendCoBrowsePremiumResponse:function(accepted,agentEnvironment,coBrowseSessionId)
{var eo=new RightNow.Event.EventObject(this,{data:{}});if(accepted)
{eo.data={agentEnvironment:agentEnvironment,coBrowseSessionId:coBrowseSessionId};RightNow.Event.fire('evt_chatCoBrowsePremiumAcceptRequest',eo);}
else
{RightNow.Event.fire('evt_chatCoBrowsePremiumDenyRequest',eo);}}});
RightNow.Widgets.ChatCancelButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);var cancelButton=this.Y.one(this.baseSelector+"_Button");if(cancelButton)
{cancelButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onButtonClick:function(type,args)
{RightNow.Event.fire("evt_chatHangupRequest",new RightNow.Event.EventObject(this,{data:{isCancelled:true,cancelingUrl:this.data.attrs.canceling_url}}));},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var previousState=args[0].data.previousState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.RECONNECTING)
return;if(currentState===ChatState.SEARCHING)
RightNow.UI.show(this._container);else
RightNow.UI.hide(this._container);}});
RightNow.Widgets.ChatRequestEmailResponseButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);this._requestEmailResponseButton=this.Y.one(this.baseSelector+"_Button");this._currentState=RightNow.Chat.Model.SEARCHING;if(this._container&&this._requestEmailResponseButton)
{this._requestEmailResponseButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onChatStateChangeResponse:function(type,args){var reason=args[0].data.reason;var currentState=args[0].data.currentState;if((currentState===RightNow.Chat.Model.ChatState.CANCELLED&&(reason==="FAIL_NO_AGENTS_AVAIL"||reason==="QUEUE_TIMEOUT"))||currentState===RightNow.Chat.Model.ChatState.DEQUEUED||currentState===RightNow.Chat.Model.ChatState.DISCONNECTED&&reason==="NO_AGENTS_AVAILABLE")
RightNow.UI.show(this._container);else
RightNow.UI.hide(this._container);},_onButtonClick:function(type,args)
{var pageToDisplay=this.Y.Lang.trim(this.data.attrs.page_url);if(pageToDisplay===''){pageToDisplay=this.data.js.baseUrl+"/app/ask";}
window.open(pageToDisplay);}});
RightNow.Widgets.ChatSendButton=RightNow.Widgets.extend({constructor:function(){this._container=this.Y.one(this.baseSelector);var sendButton=this.Y.one(this.baseSelector+"_Button");if(sendButton)
{sendButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onButtonClick:function(type,args)
{RightNow.Event.fire("evt_chatSendButtonClickRequest",new RightNow.Event.EventObject(this));},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED)
{this._container.addClass("rn_ChatSendButtonShown");RightNow.UI.show(this._container);}
else if(currentState===ChatState.REQUEUED||currentState===ChatState.DISCONNECTED||currentState===ChatState.RECONNECTING)
{this._container.removeClass("rn_ChatSendButtonShown");RightNow.UI.hide(this._container);}}});
RightNow.Widgets.FileAttachmentUpload=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this.baseSelector+"_FileInput");if(!this.input)return;this._eo=new RightNow.Event.EventObject(this);this._attachmentCount=this.data.js.attachmentCount||0;this._attachments=[];this._statusMessage=this.Y.one(this.baseSelector+"_StatusMessage");this._parentFormElement=this.input.ancestor('form');if(this._parentFormElement){this._origEncType=this._parentFormElement.get('enctype');this.input.on("change",this._onFileAdded,this);this.input.on("keypress",this._onKeyPress,this);this.input.on("paste",function(){return false;});RightNow.Form.find(this.input.get('id'),this.instanceID).on("submit",this._onValidateUpdate,this);this.on("constraintChange:min_required_attachments",this.updateMinAttachments,this);}
else{RightNow.UI.addDevelopmentHeaderError("FileAttachmentUpload must be placed within a form with a unique ID.");}
this.data.attrs.max_attachments=(this.data.attrs.max_attachments===0)?Number.MAX_VALUE:this.data.attrs.max_attachments;if(this._attachmentCount===this.data.attrs.max_attachments)
this.input.set("disabled",true);},getValue:function(){return this._attachments;}},swapLabel:function(container,minAttachments,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,minAttachments:minAttachments,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL")};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},updateMinAttachments:function(evt,constraint){var minAttachments=constraint[0].constraint;if(minAttachments>this.data.attrs.max_attachments||minAttachments===this.data.attrs.min_required_attachments)return;this.toggleErrorIndicator(false);if(this.data.attrs.min_required_attachments>0&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),minAttachments,this.data.attrs.label_input,this.getStatic().templates.label);}
this.data.attrs.min_required_attachments=minAttachments;},_onKeyPress:function(event)
{var keyPressed=event.keyCode;if(keyPressed&&(keyPressed!==RightNow.UI.KeyMap.ENTER&&keyPressed!==RightNow.UI.KeyMap.TAB)||(keyPressed===RightNow.UI.KeyMap.ENTER&&this.Y.UA.ie))
{event.halt();}},_onFileAdded:function(e){var value=e.target.get('value');if(this._uploading||value===""||!this._validateFileExtension(value))return;this._sendUploadRequest();},_validateFileExtension:function(fileName){if(!this.data.attrs.valid_file_extensions)return true;this._validExtensions||(this._validExtensions=this.data.attrs.valid_file_extensions.toLowerCase().replace(' ','').split(','));var index=fileName.lastIndexOf('.'),fileExtension=(index!==-1&&index!==(fileName.length-1))?fileName.substring(index+1).toLowerCase():null,extensionIsValid=fileExtension&&this.Y.Array.indexOf(this._validExtensions,fileExtension)>-1;if(extensionIsValid){this.toggleErrorIndicator(false);return true;}
this.toggleErrorIndicator(true);this._displayStatus(RightNow.Text.sprintf(this.data.attrs.label_invalid_extension,'.'+this._validExtensions.join(", .")));return false;},_displayStatus:function(message){this._statusMessage.removeClass("rn_ScreenReaderOnly").set('innerHTML',message);},_sendUploadRequest:function(){this._eo.data.filename=this.input.get('value');this._localFile=this._getFileFromInput();if(RightNow.Event.fire("evt_fileUploadRequest",this._eo)){this._setLoading(true);this._parentFormElement.set('enctype','multipart/form-data').set('encoding','multipart/form-data');RightNow.Ajax.makeRequest("/ci/fattach/upload",null,{json:true,data:this._eo,scope:this,timeout:(RightNow.Interface.getConfig("CP_FILE_UPLOAD_MAX_TIME")||300)*1000,upload:this._parentFormElement.get('id'),successHandler:this._fileUploadReturn,failureHandler:this._fileUploadFailure});this.input.set("disabled",true);this._parentFormElement.set('enctype',this._origEncType).set('encoding',this._origEncType);}
else{this.resetInput();}},_processServerError:function(response){var attachmentErrorInfo=this.getAttachmentErrorInfo(response);if(attachmentErrorInfo&&attachmentErrorInfo.errorMessage){attachmentErrorInfo.focusElement=this.input;RightNow.UI.Dialog.messageDialog(attachmentErrorInfo.errorMessage,attachmentErrorInfo);return true;}
return false;},_processAttachmentThreshold:function(count){if(count>=this.data.attrs.max_attachments){this.input.set("disabled",true);return count>this.data.attrs.max_attachments;}
return false;},_fileUploadReturn:function(response,originalEventObject){var originalFileName=originalEventObject.data.filename;this._setLoading(false);this.resetInput();if(RightNow.Event.fire("evt_fileUploadResponse",response,originalEventObject)){var attachmentInfo=response;if(this._processServerError(attachmentInfo)||this._processAttachmentThreshold(++this._attachmentCount))return;var filename=this._normalizeFilename(attachmentInfo.name,originalFileName);this._attachments.push({userName:filename,localName:attachmentInfo.tmp_name,contentType:attachmentInfo.type||'application/octet-stream'});this.fire('change',this);this._renderNewAttachmentItem(filename,this._attachments.length);}},_getFileFromInput:function(){if(this.data.attrs.display_thumbnail&&window.FileReader){var files=this.Y.Node.getDOMNode(this.input).files,file;if(files&&(file=files[0])&&RightNow.Text.beginsWith(file.type,'image')){return file;}}},_renderNewAttachmentItem:function(filename,count){var attachmentItem=this.Y.Node.create(new EJS({text:this.getStatic().templates.attachmentItem}).render({id:this.baseDomID+'_Item'+count,name:filename,displayThumbnail:!!this._localFile,attrs:this.data.attrs}));if(this._localFile){this._loadThumbnail(this._localFile,new FileReader(),function(img){attachmentItem.one('.rn_Thumbnail').append(img);});}
attachmentItem.one("a.rn_fileRemove").on("click",this.removeClick,this,count-1);if(!this._attachmentList){this._attachmentList=this.Y.Node.create("<ul>");this._statusMessage.insert(this._attachmentList,"before");}
this._attachmentList.append(attachmentItem);if(this.data.attrs.max_attachments===this._attachmentCount){this._attachmentList.append(new EJS({text:this.getStatic().templates.maxMessage}).render({maxMessage:this.data.attrs.label_max_attachment_limit}));}},_normalizeFilename:function(filename,originalFileName){if(filename.lastIndexOf('*')!==-1){originalFileName=originalFileName.replace(/\\/g,'/');var lastIndex=originalFileName.lastIndexOf('/');if(lastIndex!==-1){originalFileName=originalFileName.substr(lastIndex+1);}
filename=originalFileName;}
filename=filename.replace("&amp;","&");return this._renameDuplicateFilename(filename);},_renameDuplicateFilename:function(filename){var duplicateFilename,renamedFilename=filename,duplicates=0;function filenameIsDuplicate(file){return file.userName===renamedFilename;}
function addCounterToFilename(name,counter){var lastDot=name.lastIndexOf('.');if(lastDot===-1){return name+counter;}
else{return name.substr(0,lastDot)+counter+name.substr(lastDot);}}
do{duplicateFilename=this.Y.Array.find(this._attachments,filenameIsDuplicate);if(duplicateFilename){renamedFilename=addCounterToFilename(filename,++duplicates);}}
while(duplicateFilename);return renamedFilename;},_loadThumbnail:function(file,reader,callback){var maxHeight=this.data.attrs.max_thumbnail_height,width,height;reader.onload=function(){var image=new Image();image.src=reader.result;image.onload=function(){width=image.width;height=image.height;if(width>height&&width>maxHeight){height=Math.round(height*(maxHeight/width));width=maxHeight;}
else if(height>maxHeight){width=Math.round(width*(maxHeight/height));height=maxHeight;}
image.alt=file.name;image.width=width;image.height=height;callback(image);};};reader.readAsDataURL(file);},_fileUploadFailure:function(){this._setLoading(false,'');RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG"),{"icon":"WARN"});this.resetInput();},getAttachmentErrorInfo:function(attachmentInfo){if(!attachmentInfo)
{return{errorMessage:RightNow.Interface.getMessage("ERROR_REQUEST_ACTION_COMPLETED_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===2)
{return{errorMessage:this.data.attrs.label_generic_error,icon:"WARN"};}
else if(attachmentInfo.error===4||attachmentInfo.error===88)
{return{errorMessage:RightNow.Interface.getMessage("FILE_PATH_FOUND_MSG"),icon:"WARN"};}
else if(attachmentInfo.error===10)
{return{errorMessage:RightNow.Interface.getMessage("FILE_ATT_UPLOAD_EMPTY_PLS_ENSURE_MSG")};}
else if(attachmentInfo.error===20)
{return{errorMessage:RightNow.Interface.getMessage("FILE_UPLOAD_ALLOWED_FILE_MSG"),icon:"WARN"};}
else if(attachmentInfo.errorMessage)
{return{errorMessage:attachmentInfo.errorMessage,icon:"WARN"};}
else
{return null;}},resetInput:function(){this.input.set("value","").set("disabled",false);this.recreateInput();},recreateInput:function(){if(this.Y.UA.ie||this.Y.UA.webkit){var inputField=this.input.cloneNode(false);this.input.replace(inputField);this.input=this.Y.one("#"+inputField.get('id'));if(this.Y.UA.ie>8||this.Y.UA.webkit)
this.input.on("change",this._onFileAdded,this);}},removeClick:function(event,index){this._attachments.splice(index,1);event.target.get("parentNode").remove();if(this._statusMessage){this._statusMessage.set("innerHTML",RightNow.Interface.getMessage("FILE_DELETED_LBL")).addClass("rn_ScreenReaderOnly").setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();}
this._attachmentCount--;this.input.set("disabled",false);if(this._attachmentCount===this.data.attrs.max_attachments-1)
this._attachmentList.removeChild(this._attachmentList.get("lastChild"));this.fire('change',this);},_onValidateUpdate:function(type,args){this.toggleErrorIndicator(false);var eventObject=this.createEventObject();if(this._uploading||this._attachmentCount<this.data.attrs.min_required_attachments){var message=this._uploading?this.data.attrs.label_still_uploading_error:RightNow.Text.sprintf(this.data.attrs.label_min_required,this.data.attrs.label_input,this.data.attrs.min_required_attachments);this.lastErrorLocation=args[0].data.error_location;this._displayError(message,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",this._eo);return false;}
if(this._attachmentCount>0){eventObject.data.value=this._attachments;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},_setLoading:function(turnOn,statusMessage){this._uploading=turnOn;this._loading||(this._loading=this.Y.one(this.baseSelector+"_LoadingIcon"));var useMessage=typeof statusMessage==='string';if(turnOn){RightNow.UI.show(this._loading);if(this._statusMessage){this._statusMessage.removeClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("UPLOADING_ELLIPSIS_MSG"));}}
else{RightNow.UI.hide(this._loading);if(this._statusMessage){this._statusMessage.addClass("rn_ScreenReaderOnly").setHTML(useMessage?statusMessage:RightNow.Interface.getMessage("FILE_UPLOAD_COMPLETE_LBL"));if(!useMessage||statusMessage!==''){this._statusMessage.setAttribute("tabIndex",0);RightNow.UI.updateVirtualBuffer();this._statusMessage.focus();}}}},_displayError:function(errorMessage,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){commonErrorDiv.append(new EJS({text:this.getStatic().templates.error}).render({errorLink:(this.data.attrs.label_error.indexOf("%s")>-1)?RightNow.Text.sprintf(this.attrs.label_error,this.data.attrs.label_input):errorMessage,id:this.input.get('id'),fieldName:this._fieldName}));}
this.toggleErrorIndicator(true);}});
RightNow.Widgets.ChatAttachFileButton=RightNow.Widgets.FileAttachmentUpload.extend({overrides:{constructor:function(){this.parent();this._container=this.Y.one(this.baseSelector);this._dialog=null;this._keyListener=null;this._positionDuringUpload=this.data.attrs.position_during_upload;this._centeredDuringUpload=true;this._transactionID=null;this._form=this.Y.one(this.baseSelector+'_Form');this._eo=new RightNow.Event.EventObject(this);if(this._positionDuringUpload!=='center')
{var positionValues=this._positionDuringUpload.split('-');this._centeredDuringUpload=false;this._xPositionDuringUpload=positionValues[1]==='left'?0:9999;this._yPositionDuringUpload=positionValues[0]==='top'?0:9999;}
this._attachButton=this.Y.one(this.baseSelector+'_Button');if(this._attachButton)
{this._attachButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_fileUploadRequest",this._uploadFile,this);RightNow.Event.subscribe("evt_chatNotifyFattachUpdateResponse",this._fileNotifyResponse,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatEngagementParticipantAddedResponse",this._onChatEngagementParticipantAddedResponse,this);}},_sendUploadRequest:function(){RightNow.Event.fire("evt_fileUploadRequest",this._eo);}},_onButtonClick:function(type,args)
{this._transactionID=null;if(!this._dialog)
{var dialogTitle=this.data.attrs.label_dialog_title;var buttons=[{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this},isDefault:false}];this._form.set('innerHTML','<div id="rn_'+this.instanceID+'_FileAttachContent" class="rn_ChatFileAttachContent rn_Hidden">'+this._form.get('innerHTML')+'</div>');this._dialog=RightNow.UI.Dialog.actionDialog(dialogTitle,this._form,{"buttons":buttons});this._dialog.cfg.setProperty('modal',false);this._dialog.cancelEvent.subscribe(this._onCancel,this);this._dialog.validate=function(){return false;};this.input=this.Y.one(this.baseSelector+"_FileInput");this.input.on("change",this._onFileAdded,this);this.input.on("keypress",this._onKeyPress,this);this.input.on("paste",function(){return false;});this._statusMessage=this.Y.one(this.baseSelector+"_StatusMessage");}
else
{if(this._dialog.cfg.getProperty('visible')===true)
return;}
if(this._statusMessage)
this._statusMessage.set('innerHTML',"");this.input.removeClass("rn_ErrorField");RightNow.UI.show([this.baseSelector+'_FileAttachContent',this.input]);this._dialog.cfg.setProperty('fixedcenter',true);this._dialog.show();},_uploadFile:function(eventObject)
{RightNow.Event.fire("evt_chatNotifyFattachLocalRequest",new RightNow.Event.EventObject(this));if(!this._centeredDuringUpload)
{this._dialog.cfg.setProperty('fixedcenter',false);this._dialog.cfg.setProperty('x',this._xPositionDuringUpload);this._dialog.cfg.setProperty('y',this._yPositionDuringUpload);}
return false;},_fileNotifyResponse:function(type,args)
{this._transactionID=args[0].transactionID;this._parentFormElement.set('enctype','multipart/form-data').set('encoding','multipart/form-data');this._eo.data.transactionID=this._transactionID;RightNow.Ajax.makeRequest("/ci/fattach/upload",null,{upload:this._parentFormElement.get('id'),successHandler:this._onFileUploaded,scope:this,data:this._eo,json:true,timeout:(RightNow.Interface.getConfig("CP_FILE_UPLOAD_MAX_TIME")||300)*1000});},_onFileUploaded:function(response,originalEventObject)
{var attachmentInfo=response,attachmentErrorInfo;if(this._transactionID===null||this._transactionID!==originalEventObject.data.transactionID)
return;this._resetDialog();RightNow.UI.hide(this.input);attachmentErrorInfo=this.getAttachmentErrorInfo(attachmentInfo);if(this._statusMessage)
{if(attachmentErrorInfo&&attachmentErrorInfo.errorMessage)
{this._statusMessage.set('innerHTML',attachmentErrorInfo.errorMessage);this._dialog.syncUI();return;}}
this._dialog.hide();var eventObject=new RightNow.Event.EventObject(this);eventObject.data=response;eventObject.data.transactionID=originalEventObject.data.transactionID;RightNow.Event.fire("evt_chatNotifyFileUploadRequest",eventObject);},_resetDialog:function()
{this._uploading=false;this.recreateInput();this._parentFormElement.reset();RightNow.UI.hide([this._loading,this.baseSelector+'_Indicator']);},_onCancel:function()
{if(this._dialog)
this._dialog.hide();this._resetDialog();RightNow.Event.fire("evt_fileUploadCancelRequest",new RightNow.Event.EventObject(this));},_onChatStateChangeResponse:function(type,args)
{var currentState=args[0].data.currentState;var ChatState=RightNow.Chat.Model.ChatState;if(currentState===ChatState.CONNECTED)
{this._container.addClass("rn_ChatAttachFileButtonShown");RightNow.UI.show(this._container);}
else if(currentState===ChatState.REQUEUED||currentState===ChatState.DISCONNECTED||currentState===ChatState.RECONNECTING)
{this._container.removeClass("rn_ChatAttachFileButtonShown");RightNow.UI.hide(this._container);this._onCancel();}},_onChatEngagementParticipantAddedResponse:function(type,args)
{var vaMode=(args[0].data.virtualAgent===undefined)?false:args[0].data.virtualAgent;if(vaMode===false)
{this._attachButton.removeClass("rn_Hidden");}
else
{this._attachButton.addClass("rn_Hidden");}}});
RightNow.Widgets.ChatCoBrowseButton=RightNow.Widgets.extend({constructor:function(){if(!RightNow.Interface.getConfig("MOD_COBROWSE_ENABLED"))
return;this._hangupCoBrowseButton=this.Y.one(this.baseSelector+'_Button');this._coBrowseIFrame=this.Y.one(this.baseSelector+'_IFrame');this._inCoBrowse=false;if(this._hangupCoBrowseButton&&this._coBrowseIFrame)
{this._hangupCoBrowseButton.on("click",this._onButtonClick,this);RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);RightNow.Event.subscribe("evt_chatCobrowseAcceptResponse",this._coBrowseAcceptResponse,this);RightNow.Event.subscribe("evt_chatCobrowseStatusResponse",this._coBrowseStatusResponse,this);}},_onButtonClick:function(type,args)
{this._stopCoBrowseSession();},_onChatStateChangeResponse:function(type,args)
{if(this._inCoBrowse)
{var currentState=args[0].data.currentState;if(currentState!==RightNow.Chat.Model.ChatState.CONNECTED)
{var eo=new RightNow.Event.EventObject(this,{data:{coBrowseStatus:RightNow.Chat.Model.ChatCoBrowseStatusCode.STOPPED}});this._stopCoBrowseSession();RightNow.Event.fire("evt_chatCobrowseStatusResponse",eo);}}},_coBrowseStatusResponse:function(type,args)
{var coBrowseStatus=args[0].data.coBrowseStatus;if(coBrowseStatus===RightNow.Chat.Model.ChatCoBrowseStatusCode.STARTED)
{this._inCoBrowse=true;RightNow.UI.show(this._hangupCoBrowseButton);RightNow.UI.hide(this._coBrowseIFrame);}
else if(this._inCoBrowse&&coBrowseStatus===RightNow.Chat.Model.ChatCoBrowseStatusCode.STOPPED)
{this._stopCoBrowseSession();}},_coBrowseAcceptResponse:function(type,args)
{if(args[0].data.accepted)
{this._inCoBrowse=true;RightNow.UI.show(this._coBrowseIFrame);this._coBrowseIFrame.set('src',args[0].data.coBrowseUrl);}},_stopCoBrowseSession:function()
{RightNow.UI.hide(this._hangupCoBrowseButton);this._coBrowseIFrame.set('src','about:blank');this._inCoBrowse=false;}});
RightNow.Widgets.ChatQueueSearch=RightNow.Widgets.extend({constructor:function(){this._widgetElement=this.Y.one(this.baseSelector);if(this._widgetElement){RightNow.Event.subscribe("evt_chatStateChangeResponse",this._onChatStateChangeResponse,this);}},_onChatStateChangeResponse:function(type,args){var eventObject=args[0];switch(eventObject.data.currentState)
{case RightNow.Chat.Model.ChatState.RECONNECTING:return;case RightNow.Chat.Model.ChatState.SEARCHING:case RightNow.Chat.Model.ChatState.REQUEUED:case RightNow.Chat.Model.ChatState.DEQUEUED:{this._widgetElement.removeClass("rn_ScreenReaderOnly");break;}
case RightNow.Chat.Model.ChatState.CANCELLED:{if(eventObject.data.reason=='FAIL_NO_AGENTS_AVAIL'||eventObject.data.reason=='QUEUE_TIMEOUT')
this._widgetElement.removeClass("rn_ScreenReaderOnly");else
this._widgetElement.addClass("rn_ScreenReaderOnly");break;}
default:{this._widgetElement.addClass("rn_ScreenReaderOnly");break;}}}});
RightNow.Widgets.KeywordText=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._textElement=this.Y.one(this.baseSelector+"_Text");this.data.js.initialValue=this._decoder(this.data.js.initialValue);if(this._textElement){this._searchedOn=this._textElement.get("value");if(this._searchedOn!==this.data.js.initialValue)
this._textElement.set("value",this.data.js.initialValue);this._setFilter();this._textElement.on("change",this._onChange,this);this.searchSource().on("keywordChanged",this._onChangedResponse,this).on("search",this._onGetFiltersRequest,this).on("reset",this._onResetRequest,this);this.searchSource(this.data.attrs.report_id).on("response",this._onChangedResponse,this);if(this.data.attrs.initial_focus)
this._textElement.focus();}}},_onChange:function(evt){this._eo.data=this._textElement.get("value");this._eo.filters.data=this._textElement.get("value");this.searchSource().fire("keywordChanged",this._eo);},_onGetFiltersRequest:function(type,args){this._eo.filters.data=this.Y.Lang.trim(this._textElement.get("value"));this._searchedOn=this._eo.filters.data;return this._eo;},_setFilter:function(){this._eo=new RightNow.Event.EventObject(this,{filters:{searchName:this.data.js.searchName,data:this.data.js.initialValue,rnSearchType:this.data.js.rnSearchType,report_id:this.data.attrs.report_id}});},_onChangedResponse:function(type,args){var data=RightNow.Event.getDataFromFiltersEventResponse(args,this.data.js.searchName),newValue=(data===null)?this.data.js.initialValue:data;newValue=this._decoder(newValue);if(this._textElement.get("value")!==newValue)
this._textElement.set("value",newValue);},_onResetRequest:function(type,args){if(!args[0]||args[0].data.name===this.data.js.searchName){this._textElement.set('value',this.data.js.initialValue);}
else if(args[0].data.name==='all'){this._textElement.set('value',this._searchedOn);}},_decoder:function(value){if(value)
return value.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&#039;/g,"'").replace(/&quot;/g,'"');return value;}});
RightNow.Widgets.SearchButton=RightNow.SearchFilter.extend({overrides:{constructor:function(){this.parent();this._requestInProgress=false;this._searchButton=this.Y.one(this.baseSelector+"_SubmitButton");if(this._searchButton){this._enableClickListener();this.searchSource().on("response",this._enableClickListener,this);}}},_startSearch:function(evt){if(this._requestInProgress)return;if(!this.data.attrs.popup_window&&(!this.data.attrs.report_page_url&&(this.data.attrs.target==='_self')))
this._disableClickListener();if(this.Y.UA.ie){this._parentForm=this._parentForm||this.Y.one(this.baseSelector).ancestor("form");if(this._parentForm&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(this.Y.Node.getDOMNode(this._parentForm));}}
var searchPage=this.data.attrs.report_page_url;this.searchSource().fire("search",new RightNow.Event.EventObject(this,{filters:{report_id:this.data.attrs.report_id,source_id:this.data.attrs.source_id,reportPage:searchPage,newPage:top!==self||(searchPage!==""&&searchPage!=="{current_page}"&&!RightNow.Url.isSameUrl(searchPage)),target:this.data.attrs.target,popupWindow:this.data.attrs.popup_window,width:this.data.attrs.popup_window_width_percent,height:this.data.attrs.popup_window_height_percent}}));},_enableClickListener:function(){this._requestInProgress=false;this._searchButton.on("click",this._startSearch,this);},_disableClickListener:function(){this._requestInProgress=true;this._searchButton.detach("click",this._startSearch);}});